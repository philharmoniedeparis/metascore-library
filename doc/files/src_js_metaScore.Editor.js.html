<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>src\js\metaScore.Editor.js - metaScore</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="../assets/css/logo.png" title="metaScore" width="117" height="52"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.0.2</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/Ajax.html">Ajax</a></li>
                                <li><a href="../classes/API.html">API</a></li>
                                <li><a href="../classes/Array.html">Array</a></li>
                                <li><a href="../classes/Class.html">Class</a></li>
                                <li><a href="../classes/Color.html">Color</a></li>
                                <li><a href="../classes/Dom.html">Dom</a></li>
                                <li><a href="../classes/Draggable.html">Draggable</a></li>
                                <li><a href="../classes/Editor.html">Editor</a></li>
                                <li><a href="../classes/editor.Button.html">editor.Button</a></li>
                                <li><a href="../classes/editor.DropDownMenu.html">editor.DropDownMenu</a></li>
                                <li><a href="../classes/editor.Field.html">editor.Field</a></li>
                                <li><a href="../classes/editor.field.Boolean.html">editor.field.Boolean</a></li>
                                <li><a href="../classes/editor.field.BorderRadius.html">editor.field.BorderRadius</a></li>
                                <li><a href="../classes/editor.field.Buttons.html">editor.field.Buttons</a></li>
                                <li><a href="../classes/editor.field.Color.html">editor.field.Color</a></li>
                                <li><a href="../classes/editor.field.File.html">editor.field.File</a></li>
                                <li><a href="../classes/editor.field.Image.html">editor.field.Image</a></li>
                                <li><a href="../classes/editor.field.Number.html">editor.field.Number</a></li>
                                <li><a href="../classes/editor.field.Select.html">editor.field.Select</a></li>
                                <li><a href="../classes/editor.field.Text.html">editor.field.Text</a></li>
                                <li><a href="../classes/editor.field.Textarea.html">editor.field.Textarea</a></li>
                                <li><a href="../classes/editor.field.Time.html">editor.field.Time</a></li>
                                <li><a href="../classes/editor.History.html">editor.History</a></li>
                                <li><a href="../classes/editor.MainMenu.html">editor.MainMenu</a></li>
                                <li><a href="../classes/editor.Overlay.html">editor.Overlay</a></li>
                                <li><a href="../classes/editor.overlay.Alert.html">editor.overlay.Alert</a></li>
                                <li><a href="../classes/editor.overlay.BorderRadius.html">editor.overlay.BorderRadius</a></li>
                                <li><a href="../classes/editor.overlay.ColorSelector.html">editor.overlay.ColorSelector</a></li>
                                <li><a href="../classes/editor.overlay.GuideDetails.html">editor.overlay.GuideDetails</a></li>
                                <li><a href="../classes/editor.overlay.GuideSelector.html">editor.overlay.GuideSelector</a></li>
                                <li><a href="../classes/editor.overlay.iFrame.html">editor.overlay.iFrame</a></li>
                                <li><a href="../classes/editor.overlay.InsertImage.html">editor.overlay.InsertImage</a></li>
                                <li><a href="../classes/editor.overlay.LoadMask.html">editor.overlay.LoadMask</a></li>
                                <li><a href="../classes/editor.overlay.Toolbar.html">editor.overlay.Toolbar</a></li>
                                <li><a href="../classes/editor.Panel.html">editor.Panel</a></li>
                                <li><a href="../classes/editor.panel.Block.html">editor.panel.Block</a></li>
                                <li><a href="../classes/editor.panel.Element.html">editor.panel.Element</a></li>
                                <li><a href="../classes/editor.panel.Page.html">editor.panel.Page</a></li>
                                <li><a href="../classes/editor.panel.Text.html">editor.panel.Text</a></li>
                                <li><a href="../classes/editor.panel.Toolbar.html">editor.panel.Toolbar</a></li>
                                <li><a href="../classes/Evented.html">Evented</a></li>
                                <li><a href="../classes/Function.html">Function</a></li>
                                <li><a href="../classes/Locale.html">Locale</a></li>
                                <li><a href="../classes/metaScore.html">metaScore</a></li>
                                <li><a href="../classes/Object.html">Object</a></li>
                                <li><a href="../classes/Player.html">Player</a></li>
                                <li><a href="../classes/player.Component.html">player.Component</a></li>
                                <li><a href="../classes/player.component.Block.html">player.component.Block</a></li>
                                <li><a href="../classes/player.component.Controller.html">player.component.Controller</a></li>
                                <li><a href="../classes/player.component.Element.html">player.component.Element</a></li>
                                <li><a href="../classes/player.component.element.Cursor.html">player.component.element.Cursor</a></li>
                                <li><a href="../classes/player.component.element.Image.html">player.component.element.Image</a></li>
                                <li><a href="../classes/player.component.element.Text.html">player.component.element.Text</a></li>
                                <li><a href="../classes/player.component.Media.html">player.component.Media</a></li>
                                <li><a href="../classes/player.component.Page.html">player.component.Page</a></li>
                                <li><a href="../classes/player.CuePoint.html">player.CuePoint</a></li>
                                <li><a href="../classes/player.Pager.html">player.Pager</a></li>
                                <li><a href="../classes/Resizable.html">Resizable</a></li>
                                <li><a href="../classes/String.html">String</a></li>
                                <li><a href="../classes/StyleSheet.html">StyleSheet</a></li>
                                <li><a href="../classes/Var.html">Var</a></li>
                            </ul>
                
                            <ul id="api-modules" class="apis modules">
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: src\js\metaScore.Editor.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
metaScore.Editor = (function(){

  /**
   * Provides the main Editor class
   *
   * @class Editor
   * @extends Dom
   * @constructor
   * @param {Object} configs Custom configs to override defaults
   * @param {Mixed} [configs.container=&#x27;body&#x27;] The HTMLElement, Dom instance, or CSS selector to which the editor should be appended
   * @param {String} [configs.player_url=&#x27;&#x27;] The URL of the guide&#x27;s JSON data to load
   * @param {String} [configs.api_url=&#x27;&#x27;] The base URL of the RESTful API
   * @param {Object} [configs.ajax={}] Custom options to send with each AJAX request. See {{#crossLink &quot;Ajax/send:method&quot;}}Ajax.send{{/crossLink}} for available options
   */
  function Editor(configs) {
    this.configs = this.getConfigs(configs);

    // call parent constructor
    Editor.parent.call(this, &#x27;&lt;div/&gt;&#x27;, {&#x27;class&#x27;: &#x27;metaScore-editor&#x27;});

    if(DEBUG){
      metaScore.Editor.instance = this;
    }

    if(this.configs.container){
      this.appendTo(this.configs.container);
    }

    // add components
    
    this.h_ruler = new metaScore.Dom(&#x27;&lt;div/&gt;&#x27;, {&#x27;class&#x27;: &#x27;ruler horizontal&#x27;}).appendTo(this);
    this.v_ruler = new metaScore.Dom(&#x27;&lt;div/&gt;&#x27;, {&#x27;class&#x27;: &#x27;ruler vertical&#x27;}).appendTo(this);
    
    this.workspace = new metaScore.Dom(&#x27;&lt;div/&gt;&#x27;, {&#x27;class&#x27;: &#x27;workspace&#x27;}).appendTo(this);
    
    this.mainmenu = new metaScore.editor.MainMenu().appendTo(this)
      .addDelegate(&#x27;button[data-action]:not(.disabled)&#x27;, &#x27;click&#x27;, metaScore.Function.proxy(this.onMainmenuClick, this))
      .addDelegate(&#x27;.time&#x27;, &#x27;valuechange&#x27;, metaScore.Function.proxy(this.onMainmenuTimeFieldChange, this))
      .addDelegate(&#x27;.r-index&#x27;, &#x27;valuechange&#x27;, metaScore.Function.proxy(this.onMainmenuRindexFieldChange, this));      
    
    this.sidebar_wrapper = new metaScore.Dom(&#x27;&lt;div/&gt;&#x27;, {&#x27;class&#x27;: &#x27;sidebar-wrapper&#x27;}).appendTo(this)
      .addListener(&#x27;resizestart&#x27;, metaScore.Function.proxy(this.onSidebarResizeStart, this))
      .addListener(&#x27;resize&#x27;, metaScore.Function.proxy(this.onSidebarResize, this))
      .addListener(&#x27;resizeend&#x27;, metaScore.Function.proxy(this.onSidebarResizeEnd, this));
      
    this.sidebar_resizer = new metaScore.Resizable({target: this.sidebar_wrapper, directions: [&#x27;left&#x27;]});
    
    this.sidebar_resizer.getHandle(&#x27;left&#x27;)
      .addListener(&#x27;dblclick&#x27;, metaScore.Function.proxy(this.onSidebarResizeDblclick, this));
    
    this.sidebar =  new metaScore.Dom(&#x27;&lt;div/&gt;&#x27;, {&#x27;class&#x27;: &#x27;sidebar&#x27;}).appendTo(this.sidebar_wrapper);
    
    this.panels = {};
    
    this.panels.block = new metaScore.editor.panel.Block().appendTo(this.sidebar)
      .addListener(&#x27;componentbeforeset&#x27;, metaScore.Function.proxy(this.onBlockBeforeSet, this))
      .addListener(&#x27;componentset&#x27;, metaScore.Function.proxy(this.onBlockSet, this))
      .addListener(&#x27;componentunset&#x27;, metaScore.Function.proxy(this.onBlockUnset, this))
      .addListener(&#x27;valueschange&#x27;, metaScore.Function.proxy(this.onBlockPanelValueChange, this));
      
    this.panels.block.getToolbar()
      .addDelegate(&#x27;.selector&#x27;, &#x27;valuechange&#x27;, metaScore.Function.proxy(this.onBlockPanelSelectorChange, this))
      .addDelegate(&#x27;.buttons [data-action]&#x27;, &#x27;click&#x27;, metaScore.Function.proxy(this.onBlockPanelToolbarClick, this));
        
    this.panels.page = new metaScore.editor.panel.Page().appendTo(this.sidebar)
      .addListener(&#x27;componentbeforeset&#x27;, metaScore.Function.proxy(this.onPageBeforeSet, this))
      .addListener(&#x27;componentset&#x27;, metaScore.Function.proxy(this.onPageSet, this))
      .addListener(&#x27;componentunset&#x27;, metaScore.Function.proxy(this.onPageUnset, this))
      .addListener(&#x27;valueschange&#x27;, metaScore.Function.proxy(this.onPagePanelValueChange, this));
      
    this.panels.page.getToolbar()
      .addDelegate(&#x27;.selector&#x27;, &#x27;valuechange&#x27;, metaScore.Function.proxy(this.onPagePanelSelectorChange, this))
      .addDelegate(&#x27;.buttons [data-action]&#x27;, &#x27;click&#x27;, metaScore.Function.proxy(this.onPagePanelToolbarClick, this));
        
    this.panels.element = new metaScore.editor.panel.Element().appendTo(this.sidebar)
      .addListener(&#x27;componentbeforeset&#x27;, metaScore.Function.proxy(this.onElementBeforeSet, this))
      .addListener(&#x27;componentset&#x27;, metaScore.Function.proxy(this.onElementSet, this))
      .addListener(&#x27;componentunset&#x27;, metaScore.Function.proxy(this.onElementUnset, this))
      .addListener(&#x27;valueschange&#x27;, metaScore.Function.proxy(this.onElementPanelValueChange, this));
      
    this.panels.element.getToolbar()
      .addDelegate(&#x27;.selector&#x27;, &#x27;valuechange&#x27;, metaScore.Function.proxy(this.onElementPanelSelectorChange, this))
      .addDelegate(&#x27;.buttons [data-action]&#x27;, &#x27;click&#x27;, metaScore.Function.proxy(this.onElementPanelToolbarClick, this));
        
    this.panels.text = new metaScore.editor.panel.Text().appendTo(this.sidebar);
    
    this.grid = new metaScore.Dom(&#x27;&lt;div/&gt;&#x27;, {&#x27;class&#x27;: &#x27;grid&#x27;}).appendTo(this.workspace);
    this.version = new metaScore.Dom(&#x27;&lt;div/&gt;&#x27;, {&#x27;class&#x27;: &#x27;version&#x27;, &#x27;text&#x27;: &#x27;metaScore v.&#x27;+ metaScore.getVersion() +&#x27; r.&#x27;+ metaScore.getRevision()}).appendTo(this.workspace);
    
    this.player_frame = new metaScore.Dom(&#x27;&lt;iframe/&gt;&#x27;, {&#x27;src&#x27;: &#x27;about:blank&#x27;, &#x27;class&#x27;: &#x27;player-frame&#x27;}).appendTo(this.workspace)
      .addListener(&#x27;load&#x27;, metaScore.Function.proxy(this.onPlayerFrameLoadSuccess, this))
      .addListener(&#x27;error&#x27;, metaScore.Function.proxy(this.onPlayerFrameLoadError, this));
    
    this.history = new metaScore.editor.History()
      .addListener(&#x27;add&#x27;, metaScore.Function.proxy(this.onHistoryAdd, this))
      .addListener(&#x27;undo&#x27;, metaScore.Function.proxy(this.onHistoryUndo, this))
      .addListener(&#x27;redo&#x27;, metaScore.Function.proxy(this.onHistoryRedo, this));
      
    this.detailsOverlay = new metaScore.editor.overlay.GuideDetails({
        &#x27;submit_text&#x27;: metaScore.Locale.t(&#x27;editor.detailsOverlay.submit_text&#x27;, &#x27;Apply&#x27;)
      })
      .addListener(&#x27;show&#x27;, metaScore.Function.proxy(this.onDetailsOverlayShow, this))
      .addListener(&#x27;submit&#x27;, metaScore.Function.proxy(this.onDetailsOverlaySubmit, this, [&#x27;update&#x27;]));
      
    this.detailsOverlay.getField(&#x27;type&#x27;).readonly(true);

    new metaScore.Dom(&#x27;body&#x27;)
      .addListener(&#x27;keydown&#x27;, metaScore.Function.proxy(this.onKeydown, this))
      .addListener(&#x27;keyup&#x27;, metaScore.Function.proxy(this.onKeyup, this));
      
    metaScore.Dom.addListener(window, &#x27;hashchange&#x27;, metaScore.Function.proxy(this.onWindowHashChange, this));
    metaScore.Dom.addListener(window, &#x27;beforeunload&#x27;, metaScore.Function.proxy(this.onWindowBeforeUnload, this));

    this
      .addDelegate(&#x27;.timefield&#x27;, &#x27;valuein&#x27;, metaScore.Function.proxy(this.onTimeFieldIn, this))
      .addDelegate(&#x27;.timefield&#x27;, &#x27;valueout&#x27;, metaScore.Function.proxy(this.onTimeFieldOut, this))
      .updateMainmenu()
      .setEditing(false)
      .loadPlayerFromHash();
  }

  metaScore.Dom.extend(Editor);

  Editor.defaults = {
    &#x27;container&#x27;: &#x27;body&#x27;,
    &#x27;player_url&#x27;: &#x27;&#x27;,
    &#x27;api_url&#x27;: &#x27;&#x27;,
    &#x27;ajax&#x27;: {}
  };

  /**
   * Guide creation success callback
   *
   * @method onGuideCreateSuccess
   * @private
   * @param {GuideDetails} overlay The GuideDetails overlay that was used to create the guide
   * @param {XMLHttpRequest} xhr The XHR request
   */
  Editor.prototype.onGuideCreateSuccess = function(overlay, xhr){
    var json = JSON.parse(xhr.response);
  
    this.loadmask.hide();
    delete this.loadmask;
    
    overlay.hide();
      
    this.loadPlayer(json.id, json.vid);
  };

  /**
   * Guide creation error callback
   *
   * @method onGuideCreateError
   * @private
   * @param {XMLHttpRequest} xhr The XHR request
   */
  Editor.prototype.onGuideCreateError = function(xhr){
    this.loadmask.hide();
    delete this.loadmask;

    new metaScore.editor.overlay.Alert({
      &#x27;text&#x27;: metaScore.Locale.t(&#x27;editor.onGuideCreateError.msg&#x27;, &#x27;The following error occured:&lt;br/&gt;&lt;strong&gt;&lt;em&gt;@error (@code)&lt;/em&gt;&lt;/strong&gt;&lt;br/&gt;Please try again.&#x27;, {&#x27;@error&#x27;: xhr.statusText, &#x27;@code&#x27;: xhr.status}),
      &#x27;buttons&#x27;: {
        &#x27;ok&#x27;: metaScore.Locale.t(&#x27;editor.onGuideCreateError.ok&#x27;, &#x27;OK&#x27;),
      },
      &#x27;autoShow&#x27;: true
    });
  };

  /**
   * Guide saving success callback
   *
   * @method onGuideSaveSuccess
   * @private
   * @param {XMLHttpRequest} xhr The XHR request
   */
  Editor.prototype.onGuideSaveSuccess = function(xhr){
    var player = this.getPlayer(),
      json = JSON.parse(xhr.response);
  
    this.loadmask.hide();
    delete this.loadmask;
    
    if(json.id !== player.getId()){
      this.loadPlayer(json.id, json.vid);
    }
    else{    
      this.detailsOverlay
        .clearValues(true)
        .setValues(json, true);
        
      player.setRevision(json.vid);
    }
  };

  /**
   * Guide saving error callback
   *
   * @method onGuideSaveError
   * @private
   * @param {XMLHttpRequest} xhr The XHR request
   */
  Editor.prototype.onGuideSaveError = function(xhr){
    this.loadmask.hide();
    delete this.loadmask;

    new metaScore.editor.overlay.Alert({
      &#x27;text&#x27;: metaScore.Locale.t(&#x27;editor.onGuideSaveError.msg&#x27;, &#x27;The following error occured:&lt;br/&gt;&lt;strong&gt;&lt;em&gt;@error (@code)&lt;/em&gt;&lt;/strong&gt;&lt;br/&gt;Please try again.&#x27;, {&#x27;@error&#x27;: xhr.statusText, &#x27;@code&#x27;: xhr.status}),
      &#x27;buttons&#x27;: {
        &#x27;ok&#x27;: metaScore.Locale.t(&#x27;editor.onGuideSaveError.ok&#x27;, &#x27;OK&#x27;),
      },
      &#x27;autoShow&#x27;: true
    });
  };

  /**
   * Guide deletion confirm callback
   *
   * @method onGuideDeleteConfirm
   * @private
   */
  Editor.prototype.onGuideDeleteConfirm = function(){
    var id = this.getPlayer().getId(),
      component,  options;

    options = metaScore.Object.extend({}, {
      &#x27;dataType&#x27;: &#x27;json&#x27;,
      &#x27;method&#x27;: &#x27;DELETE&#x27;,
      &#x27;success&#x27;: metaScore.Function.proxy(this.onGuideDeleteSuccess, this),
      &#x27;error&#x27;: metaScore.Function.proxy(this.onGuideDeleteError, this)
    }, this.configs.ajax);

    this.loadmask = new metaScore.editor.overlay.LoadMask({
      &#x27;autoShow&#x27;: true
    });

    metaScore.Ajax.send(this.configs.api_url +&#x27;guide/&#x27;+ id +&#x27;.json&#x27;, options);
  };

  /**
   * Guide deletion success callback
   *
   * @method onGuideDeleteSuccess
   * @private
   * @param {XMLHttpRequest} xhr The XHR request
   */
  Editor.prototype.onGuideDeleteSuccess = function(xhr){
    this.removePlayer();

    this.loadmask.hide();
    delete this.loadmask;
  };

  /**
   * Guide deletion error callback
   *
   * @method onGuideDeleteError
   * @private
   * @param {XMLHttpRequest} xhr The XHR request
   */
  Editor.prototype.onGuideDeleteError = function(xhr){
    this.loadmask.hide();
    delete this.loadmask;

    new metaScore.editor.overlay.Alert({
      &#x27;text&#x27;: metaScore.Locale.t(&#x27;editor.onGuideDeleteError.msg&#x27;, &#x27;The following error occured:&lt;br/&gt;&lt;strong&gt;&lt;em&gt;@error (@code)&lt;/em&gt;&lt;/strong&gt;&lt;br/&gt;Please try again.&#x27;, {&#x27;@error&#x27;: xhr.statusText, &#x27;@code&#x27;: xhr.status}),
      &#x27;buttons&#x27;: {
        &#x27;ok&#x27;: metaScore.Locale.t(&#x27;editor.onGuideDeleteError.ok&#x27;, &#x27;OK&#x27;),
      },
      &#x27;autoShow&#x27;: true
    });
  };

  /**
   * Guide revert confirm callback
   *
   * @method onGuideRevertConfirm
   * @private
   */
  Editor.prototype.onGuideRevertConfirm = function(){
    var player = this.getPlayer();
  
    this.loadPlayer(player.getId(), player.getRevision());
  };

  /**
   * GuideSelector submit callback
   *
   * @method onGuideSelectorSubmit
   * @param {CustomEvent} evt The event object. See {{#crossLink &quot;GuideSelector/submit:event&quot;}}GuideSelector.submit{{/crossLink}}
   */
  Editor.prototype.onGuideSelectorSubmit = function(evt){
    this.loadPlayer(evt.detail.guide.id, evt.detail.vid);
  };
  
  /**
   * Keydown event callback
   *
   * @method onKeydown
   * @private
   * @param {KeyboardEvent} evt The event object
   */
  Editor.prototype.onKeydown = function(evt){
    var player;
  
    switch(evt.keyCode){
      case 18: //alt
        if(!evt.repeat){
          this.setEditing(!this.persistentEditing, false);
          evt.preventDefault();
        }
        break;
        
      case 72: //h
        if(evt.ctrlKey){ // Ctrl+h
          player = this.getPlayer();
          if(player){
            player.addClass(&#x27;show-contents&#x27;);
          }
          evt.preventDefault();
        }
        break;
        
      case 90: //z
        if(evt.ctrlKey){ // Ctrl+z
          this.history.undo();
          evt.preventDefault();
        }
        break;
        
      case 89: //y
        if(evt.ctrlKey){ // Ctrl+y
          this.history.redo();
          evt.preventDefault();
        }
        break;
    }
  };
  
  /**
   * Keyup event callback
   *
   * @method onKeyup
   * @private
   * @param {KeyboardEvent} evt The event object
   */
  Editor.prototype.onKeyup = function(evt){
    var player;
    
    switch(evt.keyCode){
      case 18: //alt
        this.setEditing(this.persistentEditing, false);
        evt.preventDefault();
        break;
        
      case 72: //h
        if(evt.ctrlKey){ // Ctrl+h
          player = this.getPlayer();
          if(player){
            player.removeClass(&#x27;show-contents&#x27;);
          }
          evt.preventDefault();
        }
        break;
    }
  };

  /**
   * Mainmenu click event callback
   *
   * @method onMainmenuClick
   * @private
   * @param {MouseEvent} evt The event object
   */
  Editor.prototype.onMainmenuClick = function(evt){  
    var callback;
  
    switch(metaScore.Dom.data(evt.target, &#x27;action&#x27;)){
      case &#x27;new&#x27;:
        callback = metaScore.Function.proxy(function(){    
          new metaScore.editor.overlay.GuideDetails({
              &#x27;autoShow&#x27;: true
            })
            .addListener(&#x27;show&#x27;, metaScore.Function.proxy(this.onDetailsOverlayShow, this))
            .addListener(&#x27;submit&#x27;, metaScore.Function.proxy(this.onDetailsOverlaySubmit, this, [&#x27;create&#x27;]));
        }, this);
      
        if(this.hasOwnProperty(&#x27;player&#x27;)){
          new metaScore.editor.overlay.Alert({
              &#x27;text&#x27;: metaScore.Locale.t(&#x27;editor.onMainmenuClick.open.msg&#x27;, &#x27;Are you sure you want to open another guide ?&lt;br/&gt;&lt;strong&gt;Any unsaved data will be lost.&lt;/strong&gt;&#x27;),
              &#x27;buttons&#x27;: {
                &#x27;confirm&#x27;: metaScore.Locale.t(&#x27;editor.onMainmenuClick.open.yes&#x27;, &#x27;Yes&#x27;),
                &#x27;cancel&#x27;: metaScore.Locale.t(&#x27;editor.onMainmenuClick.open.no&#x27;, &#x27;No&#x27;)
              },
              &#x27;autoShow&#x27;: true
            })
            .addListener(&#x27;buttonclick&#x27;, function(evt){
              if(evt.detail.action === &#x27;confirm&#x27;){
                callback();
              }
            });
        }
        else{
          callback();
        }
        break;
        
      case &#x27;open&#x27;:
        callback = metaScore.Function.proxy(this.openGuideSelector, this);
        
        if(this.hasOwnProperty(&#x27;player&#x27;)){
          new metaScore.editor.overlay.Alert({
              &#x27;text&#x27;: metaScore.Locale.t(&#x27;editor.onMainmenuClick.open.msg&#x27;, &#x27;Are you sure you want to open another guide ?&lt;br/&gt;&lt;strong&gt;Any unsaved data will be lost.&lt;/strong&gt;&#x27;),
              &#x27;buttons&#x27;: {
                &#x27;confirm&#x27;: metaScore.Locale.t(&#x27;editor.onMainmenuClick.open.yes&#x27;, &#x27;Yes&#x27;),
                &#x27;cancel&#x27;: metaScore.Locale.t(&#x27;editor.onMainmenuClick.open.no&#x27;, &#x27;No&#x27;)
              },
              &#x27;autoShow&#x27;: true
            })
            .addListener(&#x27;buttonclick&#x27;, function(evt){
              if(evt.detail.action === &#x27;confirm&#x27;){
                callback();
              }
            });
        }
        else{
          callback();
        }
        break;
        
      case &#x27;edit&#x27;:
        this.detailsOverlay.show();
        break;
        
      case &#x27;save-draft&#x27;:
        this.saveGuide(&#x27;update&#x27;);
        break;
        
      case &#x27;save-copy&#x27;:
        this.saveGuide(&#x27;duplicate&#x27;);
        break;
        
      case &#x27;publish&#x27;:
        callback = metaScore.Function.proxy(function(){
          this.saveGuide(&#x27;update&#x27;, true);
        }, this);
        
        new metaScore.editor.overlay.Alert({
            &#x27;text&#x27;: metaScore.Locale.t(&#x27;editor.onMainmenuClick.publish.msg&#x27;, &#x27;This action will make this version the public version.&lt;br/&gt;Are you sure you want to continue?&#x27;),
            &#x27;buttons&#x27;: {
              &#x27;confirm&#x27;: metaScore.Locale.t(&#x27;editor.onMainmenuClick.publish.yes&#x27;, &#x27;Yes&#x27;),
              &#x27;cancel&#x27;: metaScore.Locale.t(&#x27;editor.onMainmenuClick.publish.no&#x27;, &#x27;No&#x27;)
            },
            &#x27;autoShow&#x27;: true
          })
          .addListener(&#x27;buttonclick&#x27;, function(evt){
            if(evt.detail.action === &#x27;confirm&#x27;){
              callback();
            }
          });
        break;
        
      case &#x27;download&#x27;:
        break;
        
      case &#x27;delete&#x27;:        
        new metaScore.editor.overlay.Alert({
            &#x27;text&#x27;: metaScore.Locale.t(&#x27;editor.onMainmenuClick.delete.msg&#x27;, &#x27;Are you sure you want to delete this guide ?&#x27;),
            &#x27;buttons&#x27;: {
              &#x27;confirm&#x27;: metaScore.Locale.t(&#x27;editor.onMainmenuClick.delete.yes&#x27;, &#x27;Yes&#x27;),
              &#x27;cancel&#x27;: metaScore.Locale.t(&#x27;editor.onMainmenuClick.delete.no&#x27;, &#x27;No&#x27;)
            },
            &#x27;autoShow&#x27;: true
          })
          .addListener(&#x27;buttonclick&#x27;, metaScore.Function.proxy(function(evt){
            if(evt.detail.action === &#x27;confirm&#x27;){
              this.onGuideDeleteConfirm();
            }
          }, this));
        break;
        
      case &#x27;revert&#x27;:
        new metaScore.editor.overlay.Alert({
            &#x27;text&#x27;: metaScore.Locale.t(&#x27;editor.onMainmenuClick.revert.msg&#x27;, &#x27;Are you sure you want to revert back to the last saved version ?&lt;br/&gt;&lt;strong&gt;Any unsaved data will be lost.&lt;/strong&gt;&#x27;),
            &#x27;buttons&#x27;: {
              &#x27;confirm&#x27;: metaScore.Locale.t(&#x27;editor.onMainmenuClick.revert.yes&#x27;, &#x27;Yes&#x27;),
              &#x27;cancel&#x27;: metaScore.Locale.t(&#x27;editor.onMainmenuClick.revert.no&#x27;, &#x27;No&#x27;)
            },
            &#x27;autoShow&#x27;: true
          })
          .addListener(&#x27;buttonclick&#x27;, metaScore.Function.proxy(function(evt){
            if(evt.detail.action === &#x27;confirm&#x27;){
              this.onGuideRevertConfirm();
            }
          }, this));
        break;
        
      case &#x27;undo&#x27;:
        this.history.undo();
        break;
        
      case &#x27;redo&#x27;:
        this.history.redo();
        break;
        
      case &#x27;edit-toggle&#x27;:
        this.setEditing(!metaScore.editing);
        break;
        
      case &#x27;settings&#x27;:
        break;
    }
  };

  /**
   * Mainmenu time field valuechange event callback
   *
   * @method onMainmenuTimeFieldChange
   * @private
   * @param {CustomEvent} evt The event object. See {{#crossLink &quot;Time/valuechange:event&quot;}}Time.valuechange{{/crossLink}}
   */
  Editor.prototype.onMainmenuTimeFieldChange = function(evt){
    var field = evt.target._metaScore,
      time = field.getValue();

    this.getPlayer().media.setTime(time);
  };

  /**
   * Mainmenu reading index field valuechange event callback
   *
   * @method onMainmenuRindexFieldChange
   * @private
   * @param {CustomEvent} evt The event object. See {{#crossLink &quot;Number/valuechange:event&quot;}}Number.valuechange{{/crossLink}}
   */
  Editor.prototype.onMainmenuRindexFieldChange = function(evt){
    var field = evt.target._metaScore,
      value = field.getValue();

    this.getPlayer().setReadingIndex(value, true);
  };

  /**
   * Time field valuein event callback
   *
   * @method onTimeFieldIn
   * @private
   * @param {CustomEvent} evt The event object. See {{#crossLink &quot;Time/valuein:event&quot;}}Time.valuein{{/crossLink}}
   */
  Editor.prototype.onTimeFieldIn = function(evt){
    var field = evt.target._metaScore,
      time = this.getPlayer().media.getTime();

    field.setValue(time);
  };

  /**
   * Time field valueout event callback
   *
   * @method onTimeFieldOut
   * @private
   * @param {CustomEvent} evt The event object. See {{#crossLink &quot;Time/valueout:event&quot;}}Time.valueout{{/crossLink}}
   */
  Editor.prototype.onTimeFieldOut = function(evt){
    var field = evt.target._metaScore,
      time = field.getValue();

    this.getPlayer().media.setTime(time);
  };

  /**
   * Sidebar resizestart event callback
   *
   * @method onSidebarResizeStart
   * @private
   * @param {CustomEvent} evt The event object. See {{#crossLink &quot;Resizable/resizestart:event&quot;}}Resizable.resizestart{{/crossLink}}
   */
  Editor.prototype.onSidebarResizeStart = function(evt){
    this.addClass(&#x27;sidebar-resizing&#x27;);
  };

  /**
   * Sidebar resize event callback
   *
   * @method onSidebarResize
   * @private
   * @param {CustomEvent} evt The event object. See {{#crossLink &quot;Resizable/resize:event&quot;}}Resizable.resize{{/crossLink}}
   */
  Editor.prototype.onSidebarResize = function(evt){
    var width = parseInt(this.sidebar_wrapper.css(&#x27;width&#x27;), 10);
    
    this.workspace.css(&#x27;right&#x27;, width +&#x27;px&#x27;);
  };

  /**
   * Sidebar resizeend event callback
   *
   * @method onSidebarResizeEnd
   * @private
   * @param {CustomEvent} evt The event object. See {{#crossLink &quot;Resizable/resizeend:event&quot;}}Resizable.resizeend{{/crossLink}}
   */
  Editor.prototype.onSidebarResizeEnd = function(evt){
    this.removeClass(&#x27;sidebar-resizing&#x27;);
  };

  /**
   * Sidebar resize handle dblclick event callback
   *
   * @method onSidebarResizeDblclick
   * @private
   * @param {MouseEvent} evt The event object
   */
  Editor.prototype.onSidebarResizeDblclick = function(evt){
    this.toggleClass(&#x27;sidebar-hidden&#x27;);
    
    this.toggleSidebarResizer();
  };

  /**
   * Block panel componentbeforeset event callback
   *
   * @method onBlockBeforeSet
   * @private
   * @param {CustomEvent} evt The event object. See {{#crossLink &quot;Panel/componentbeforeset:event&quot;}}Panel.componentbeforeset{{/crossLink}}
   */
  Editor.prototype.onBlockBeforeSet = function(evt){
    var block = evt.detail.component;
    
    this.panels.element.unsetComponent();
    this.panels.page.unsetComponent();
  };

  /**
   * Block panel componentset event callback
   *
   * @method onBlockSet
   * @private
   * @param {CustomEvent} evt The event object. See {{#crossLink &quot;Panel/componentset:event&quot;}}Panel.componentset{{/crossLink}}
   */
  Editor.prototype.onBlockSet = function(evt){
    var block = evt.detail.component;

    if(block.instanceOf(&#x27;Block&#x27;)){
      this.panels.page.getToolbar()
        .toggleMenuItem(&#x27;new&#x27;, true);
      
      this.panels.page.setComponent(block.getActivePage());

      this.panels.element.getToolbar()
        .toggleMenuItem(&#x27;Cursor&#x27;, true)
        .toggleMenuItem(&#x27;Image&#x27;, true)
        .toggleMenuItem(&#x27;Text&#x27;, true);
    }
    
    this.updatePageSelector();

    evt.stopPropagation();
  };

  /**
   * Block panel componentunset event callback
   *
   * @method onBlockUnset
   * @private
   * @param {CustomEvent} evt The event object. See {{#crossLink &quot;Panel/componentunset:event&quot;}}Panel.componentunset{{/crossLink}}
   */
  Editor.prototype.onBlockUnset = function(evt){
    this.panels.page.unsetComponent();
    this.panels.page.getToolbar().toggleMenuItem(&#x27;new&#x27;, false);
  };

  /**
   * Block panel valuechange event callback
   *
   * @method onBlockPanelValueChange
   * @private
   * @param {CustomEvent} evt The event object. See {{#crossLink &quot;Panel/valueschange:event&quot;}}Panel.valueschange{{/crossLink}}
   */
  Editor.prototype.onBlockPanelValueChange = function(evt){
    var panel = this.panels.block,
      block = evt.detail.component,
      old_values = evt.detail.old_values,
      new_values = evt.detail.new_values;

    this.history.add({
      &#x27;undo&#x27;: function(){
        panel.updateProperties(block, old_values);
      },
      &#x27;redo&#x27;: function(){
        panel.updateProperties(block, new_values);
      }
    });
  };

  /**
   * Block panel toolbar click event callback
   *
   * @method onBlockPanelToolbarClick
   * @private
   * @param {MouseEvent} evt The event object
   */
  Editor.prototype.onBlockPanelToolbarClick = function(evt){
    var player, panel, block, page_configs,
      action = metaScore.Dom.data(evt.target, &#x27;action&#x27;);

    switch(action){
      case &#x27;synched&#x27;:
      case &#x27;non-synched&#x27;:
        player = this.getPlayer();
        panel = this.panels.block;
        block = player.addBlock({
          &#x27;name&#x27;:  metaScore.Locale.t(&#x27;editor.onBlockPanelToolbarClick.defaultBlockName&#x27;, &#x27;untitled&#x27;),
          &#x27;synched&#x27;: action === &#x27;synched&#x27;
        });
        
        page_configs = {};
        
        if(action === &#x27;synched&#x27;){
          page_configs[&#x27;start-time&#x27;] = 0;
          page_configs[&#x27;end-time&#x27;] = this.getPlayer().getMedia().getDuration();
        }
        
        block.addPage(page_configs);
        
        panel.setComponent(block);

        this.history.add({
          &#x27;undo&#x27;: function(){
            panel.unsetComponent();
            block.remove();
          },
          &#x27;redo&#x27;: function(){
            player.addBlock(block);
            panel.setComponent(block);
          }
        });
        break;

      case &#x27;delete&#x27;:
        player = this.getPlayer();
        panel = this.panels.block;
        block = this.panels.block.getComponent();

        if(block){
          panel.unsetComponent();
          block.remove();

          this.history.add({
            &#x27;undo&#x27;: function(){
              player.addBlock(block);
              panel.setComponent(block);
            },
            &#x27;redo&#x27;: function(){
              panel.unsetComponent();
              block.remove();
            }
          });
        }
        break;
    }

    evt.stopPropagation();
  };

  /**
   * Block panel toolbar selector valuechange event callback
   *
   * @method onBlockPanelSelectorChange
   * @private
   * @param {CustomEvent} evt The event object. See {{#crossLink &quot;Select/valueschange:event&quot;}}Select.valueschange{{/crossLink}}
   */
  Editor.prototype.onBlockPanelSelectorChange = function(evt){
    var id = evt.detail.value,
      dom;
      
    if(!id){
      this.panels.block.unsetComponent();
    }
    else{
      dom = this.getPlayer().getComponent(&#x27;.media#&#x27;+ id +&#x27;, .controller#&#x27;+ id +&#x27;, .block#&#x27;+ id);
      
      if(dom &amp;&amp; dom._metaScore){
        this.panels.block.setComponent(dom._metaScore);
      }
    }
  };

  /**
   * Page panel componentbeforeset event callback
   *
   * @method onPageBeforeSet
   * @private
   * @param {CustomEvent} evt The event object. See {{#crossLink &quot;Panel/componentbeforeset:event&quot;}}Panel.componentbeforeset{{/crossLink}}
   */
  Editor.prototype.onPageBeforeSet = function(evt){
    var page = evt.detail.component,
      block = page.getBlock();

    this.panels.element.unsetComponent();    
    this.panels.block.setComponent(block);
  };

  /**
   * Page panel componentset event callback
   *
   * @method onPageSet
   * @private
   * @param {CustomEvent} evt The event object. See {{#crossLink &quot;Panel/componentset:event&quot;}}Panel.componentset{{/crossLink}}
   */
  Editor.prototype.onPageSet = function(evt){
    var page = evt.detail.component,
      block = this.panels.block.getComponent(),
      index, previous_page, next_page,
      start_time_field = this.panels.page.getField(&#x27;start-time&#x27;),
      end_time_field = this.panels.page.getField(&#x27;end-time&#x27;);

    this.panels.page.getToolbar().toggleMenuItem(&#x27;new&#x27;, true);

    this.panels.element
      .unsetComponent()
      .getToolbar()
        .toggleMenuItem(&#x27;Cursor&#x27;, true)
        .toggleMenuItem(&#x27;Image&#x27;, true)
        .toggleMenuItem(&#x27;Text&#x27;, true);
    
    if(block.getProperty(&#x27;synched&#x27;)){
      index = block.getActivePageIndex();
      previous_page = block.getPage(index-1);
      next_page = block.getPage(index+1);
      
      if(previous_page){
        start_time_field.readonly(false).enable().setMin(previous_page.getProperty(&#x27;start-time&#x27;));
      }
      else{        
        start_time_field.readonly(true).enable();
      }
      
      if(next_page){
        end_time_field.readonly(false).enable().setMax(next_page.getProperty(&#x27;end-time&#x27;));
      }
      else{        
        end_time_field.readonly(true).enable();
      }
    }
    else{
      start_time_field.disable();
      end_time_field.disable();
    }
      
    this.updateElementSelector();

    evt.stopPropagation();
  };

  /**
   * Page panel componentunset event callback
   *
   * @method onPageUnset
   * @private
   * @param {CustomEvent} evt The event object. See {{#crossLink &quot;Panel/componentunset:event&quot;}}Panel.componentunset{{/crossLink}}
   */
  Editor.prototype.onPageUnset = function(evt){
    this.panels.element
      .unsetComponent()
      .getToolbar()
        .toggleMenuItem(&#x27;Cursor&#x27;, false)
        .toggleMenuItem(&#x27;Image&#x27;, false)
        .toggleMenuItem(&#x27;Text&#x27;, false);
  };

  /**
   * Page panel valuechange event callback
   *
   * @method onPagePanelValueChange
   * @private
   * @param {CustomEvent} evt The event object. See {{#crossLink &quot;Panel/valueschange:event&quot;}}Panel.valueschange{{/crossLink}}
   */
  Editor.prototype.onPagePanelValueChange = function(evt){
    var editor = this,
      panel = this.panels.page,
      page = evt.detail.component,
      old_values = evt.detail.old_values,
      new_values = evt.detail.new_values,
      block, index, previous_page, next_page;
      
    if((&#x27;start-time&#x27; in new_values) || (&#x27;end-time&#x27; in new_values)){
      if((block = page.getBlock()) &amp;&amp; block.getProperty(&#x27;synched&#x27;)){
        index = block.getActivePageIndex();
        previous_page = block.getPage(index-1);
        next_page = block.getPage(index+1);
    
        if((&#x27;start-time&#x27; in new_values) &amp;&amp; previous_page){
          previous_page.setProperty(&#x27;end-time&#x27;, new_values[&#x27;start-time&#x27;]);
        }
        
        if((&#x27;end-time&#x27; in new_values) &amp;&amp; next_page){
          next_page.setProperty(&#x27;start-time&#x27;, new_values[&#x27;end-time&#x27;]);
        }
      }
      
      editor.updateElementSelector();
    }

    this.history.add({
      &#x27;undo&#x27;: function(){
        panel.updateProperties(page, old_values);
        
        if((&#x27;start-time&#x27; in new_values) || (&#x27;end-time&#x27; in new_values)){
          if((&#x27;start-time&#x27; in new_values) &amp;&amp; previous_page){
            previous_page.setProperty(&#x27;end-time&#x27;, old_values[&#x27;start-time&#x27;]);
          }
          
          if((&#x27;end-time&#x27; in new_values) &amp;&amp; next_page){
            next_page.setProperty(&#x27;start-time&#x27;, old_values[&#x27;end-time&#x27;]);
          }
      
          editor.updateElementSelector();
        }
      },
      &#x27;redo&#x27;: function(){
        panel.updateProperties(page, new_values);
        
        if((&#x27;start-time&#x27; in new_values) || (&#x27;end-time&#x27; in new_values)){
          if((&#x27;start-time&#x27; in new_values) &amp;&amp; previous_page){
            previous_page.setProperty(&#x27;end-time&#x27;, new_values[&#x27;start-time&#x27;]);
          }
          
          if((&#x27;end-time&#x27; in new_values) &amp;&amp; next_page){
            next_page.setProperty(&#x27;start-time&#x27;, new_values[&#x27;end-time&#x27;]);
          }
      
          editor.updateElementSelector();
        }
      }
    });
  };

  /**
   * Page panel toolbar click event callback
   *
   * @method onPagePanelToolbarClick
   * @private
   * @param {MouseEvent} evt The event object
   */
  Editor.prototype.onPagePanelToolbarClick = function(evt){
    var panel, block, page, 
      start_time, end_time, configs,
      previous_page, auto_page, index,
      action = metaScore.Dom.data(evt.target, &#x27;action&#x27;);
    
    switch(action){
      case &#x27;new&#x27;:
        panel = this.panels.page;
        block = this.panels.block.getComponent();
        configs = {};
        
        if(block.getProperty(&#x27;synched&#x27;)){
          index = block.getActivePageIndex();
          previous_page = block.getPage(index);
          
          start_time = this.getPlayer().media.getTime();
          end_time = previous_page.getProperty(&#x27;end-time&#x27;);
        
          configs[&#x27;start-time&#x27;] = start_time;
          configs[&#x27;end-time&#x27;] = end_time;
          
          previous_page.setProperty(&#x27;end-time&#x27;, start_time);
        }
        
        page = block.addPage(configs, index+1);
        panel.setComponent(page);

        this.history.add({
          &#x27;undo&#x27;: function(){
            panel.unsetComponent();
            block.removePage(page);
            
            if(block.getProperty(&#x27;synched&#x27;)){
              previous_page.setProperty(&#x27;end-time&#x27;, end_time);
            }
            
            block.setActivePage(index);
          },
          &#x27;redo&#x27;: function(){
            if(block.getProperty(&#x27;synched&#x27;)){
              previous_page.setProperty(&#x27;end-time&#x27;, start_time);
            }
            
            block.addPage(page, index+1);
            panel.setComponent(page);
          }
        });
        break;

      case &#x27;delete&#x27;:
        panel = this.panels.page;
        block = this.panels.block.getComponent();
        page = panel.getComponent();
        index = block.getActivePageIndex();

        if(page){
          panel.unsetComponent();
          block.removePage(page);
          index--;
          
          if(block.getPageCount() &lt; 1){
            configs = {};
            
            if(block.getProperty(&#x27;synched&#x27;)){
              configs[&#x27;start-time&#x27;] = 0;
              configs[&#x27;end-time&#x27;] = this.getPlayer().getMedia().getDuration();
            }
            
            auto_page = block.addPage(configs);
            panel.setComponent(auto_page);
          }
            
          block.setActivePage(Math.max(0, index));

          this.history.add({
            &#x27;undo&#x27;: function(){
              if(auto_page){
                block.removePage(auto_page, true);
              }
              
              block.addPage(page);
              panel.setComponent(page);
            },
            &#x27;redo&#x27;: function(){
              panel.unsetComponent();
              block.removePage(page, true);
              
              if(auto_page){
                block.addPage(auto_page);
                panel.setComponent(auto_page);
              }
              
              block.setActivePage(index);
            }
          });
        }
        break;
    }

    evt.stopPropagation();
  };

  /**
   * Page panel toolbar selector valuechange event callback
   *
   * @method onPagePanelSelectorChange
   * @private
   * @param {CustomEvent} evt The event object. See {{#crossLink &quot;Select/valueschange:event&quot;}}Select.valueschange{{/crossLink}}
   */
  Editor.prototype.onPagePanelSelectorChange = function(evt){
    var block = this.panels.block.getComponent(),
      id, dom;
    
    if(block){
      id = evt.detail.value;
      dom = this.getPlayer().getComponent(&#x27;.page#&#x27;+ id);
    
      if(dom &amp;&amp; dom._metaScore){
        block.setActivePage(dom._metaScore);
      }
    }
  };

  /**
   * Element panel componentbeforeset event callback
   *
   * @method onElementBeforeSet
   * @private
   * @param {CustomEvent} evt The event object. See {{#crossLink &quot;Panel/componentbeforeset:event&quot;}}Panel.componentbeforeset{{/crossLink}}
   */
  Editor.prototype.onElementBeforeSet = function(evt){
    var element = evt.detail.component,
      page = element.parents().get(0)._metaScore;

    this.panels.page.setComponent(page);
  };

  /**
   * Element panel componentset event callback
   *
   * @method onElementSet
   * @private
   * @param {CustomEvent} evt The event object. See {{#crossLink &quot;Panel/componentset:event&quot;}}Panel.componentset{{/crossLink}}
   */
  Editor.prototype.onElementSet = function(evt){
    var element = evt.detail.component,
      player = this.getPlayer();

    if(element.getProperty(&#x27;type&#x27;) === &#x27;Text&#x27;){
      this.panels.text.setComponent(element);
    }
    else{
      this.panels.text.unsetComponent();
    }
    
    player.setReadingIndex(element.getProperty(&#x27;r-index&#x27;) || 0);

    evt.stopPropagation();
  };

  /**
   * Element panel componentunset event callback
   *
   * @method onElementUnset
   * @private
   * @param {CustomEvent} evt The event object. See {{#crossLink &quot;Panel/componentunset:event&quot;}}Panel.componentunset{{/crossLink}}
   */
  Editor.prototype.onElementUnset = function(evt){
    this.panels.text.unsetComponent();

    evt.stopPropagation();
  };

  /**
   * Element panel valuechange event callback
   *
   * @method onElementPanelValueChange
   * @private
   * @param {CustomEvent} evt The event object. See {{#crossLink &quot;Panel/valueschange:event&quot;}}Panel.valueschange{{/crossLink}}
   */
  Editor.prototype.onElementPanelValueChange = function(evt){
    var editor = this,
      panel = this.panels.element,
      element = evt.detail.component,
      old_values = evt.detail.old_values,
      new_values = evt.detail.new_values;
      
    if((&#x27;start-time&#x27; in new_values) || (&#x27;end-time&#x27; in new_values)){
      editor.updateElementSelector();
    }

    this.history.add({
      &#x27;undo&#x27;: function(){
        panel.updateProperties(element, old_values);
      
        if((&#x27;start-time&#x27; in new_values) || (&#x27;end-time&#x27; in new_values)){
          editor.updateElementSelector();
        }
      },
      &#x27;redo&#x27;: function(){
        panel.updateProperties(element, new_values);
      
        if((&#x27;start-time&#x27; in new_values) || (&#x27;end-time&#x27; in new_values)){
          editor.updateElementSelector();
        }
      }
    });
  };

  /**
   * Element panel toolbar click event callback
   *
   * @method onElementPanelToolbarClick
   * @private
   * @param {MouseEvent} evt The event object
   */
  Editor.prototype.onElementPanelToolbarClick = function(evt){
    var panel, page, element,
      action = metaScore.Dom.data(evt.target, &#x27;action&#x27;);

    switch(action){
      case &#x27;Cursor&#x27;:
      case &#x27;Image&#x27;:
      case &#x27;Text&#x27;:
        panel = this.panels.element;
        page = this.panels.page.getComponent();
        element = page.addElement({&#x27;type&#x27;: action, &#x27;name&#x27;:  metaScore.Locale.t(&#x27;editor.onElementPanelToolbarClick.defaultElementName&#x27;, &#x27;untitled&#x27;)});

        panel.setComponent(element);

        this.history.add({
          &#x27;undo&#x27;: function(){
            panel.unsetComponent();
            element.remove();
          },
          &#x27;redo&#x27;: function(){
            page.addElement(element);
            panel.setComponent(element);
          }
        });
        break;

      case &#x27;delete&#x27;:
        panel = this.panels.element;
        page = this.panels.page.getComponent();
        element = this.panels.element.getComponent();

        if(element){
          panel.unsetComponent();
          element.remove();

          this.history.add({
            &#x27;undo&#x27;: function(){
              page.addElement(element);
              panel.setComponent(element);
            },
            &#x27;redo&#x27;: function(){
              panel.unsetComponent();
              element.remove();
            }
          });
        }
        break;
    }
  };

  /**
   * Element panel toolbar selector valuechange event callback
   *
   * @method onPagePanelSelectorChange
   * @private
   * @param {CustomEvent} evt The event object. See {{#crossLink &quot;Select/valueschange:event&quot;}}Select.valueschange{{/crossLink}}
   */
  Editor.prototype.onElementPanelSelectorChange = function(evt){
    var id = evt.detail.value,
      dom;
      
    if(!id){
      this.panels.element.unsetComponent();
    }
    else{    
      dom = this.getPlayer().getComponent(&#x27;.element#&#x27;+ id);
    
      if(dom &amp;&amp; dom._metaScore){
        this.panels.element.setComponent(dom._metaScore);
      }
    }
  };

  /**
   * Player idset event callback
   *
   * @method onPlayerIdSet
   * @private
   * @param {CustomEvent} evt The event object. See {{#crossLink &quot;Player/idset:event&quot;}}Player.idset{{/crossLink}}
   */
  Editor.prototype.onPlayerIdSet = function(evt){
    var player = evt.detail.player;

    window.history.replaceState(null, null, &#x27;#guide=&#x27;+ player.getId() +&#x27;:&#x27;+ player.getRevision());
  };

  /**
   * Player revisionset event callback
   *
   * @method onPlayerRevisionSet
   * @private
   * @param {CustomEvent} evt The event object. See {{#crossLink &quot;Player/revisionset:event&quot;}}Player.revisionset{{/crossLink}}
   */
  Editor.prototype.onPlayerRevisionSet = function(evt){
    var player = evt.detail.player;

    window.history.replaceState(null, null, &#x27;#guide=&#x27;+ player.getId() +&#x27;:&#x27;+ player.getRevision());
  };

  /**
   * Media timeupdate event callback
   *
   * @method onPlayerTimeUpdate
   * @private
   * @param {CustomEvent} evt The event object. See {{#crossLink &quot;Media/timeupdate:event&quot;}}Media.timeupdate{{/crossLink}}
   */
  Editor.prototype.onPlayerTimeUpdate = function(evt){
    var time = evt.detail.media.getTime();

    this.mainmenu.timefield.setValue(time, true);
  };

  /**
   * Player rindex event callback
   *
   * @method onPlayerReadingIndex
   * @private
   * @param {CustomEvent} evt The event object. See {{#crossLink &quot;Player/rindex:event&quot;}}Player.rindex{{/crossLink}}
   */
  Editor.prototype.onPlayerReadingIndex = function(evt){
    var rindex = evt.detail.value;

    this.mainmenu.rindexfield.setValue(rindex, true);
  };

  /**
   * Player blockadd event callback
   *
   * @method onPlayerBlockAdd
   * @private
   * @param {CustomEvent} evt The event object. See {{#crossLink &quot;Player/blockadd:event&quot;}}Player.blockadd{{/crossLink}}
   */
  Editor.prototype.onPlayerBlockAdd = function(evt){
    this.updateBlockSelector();
  };

  /**
   * Player childremove event callback
   *
   * @method onPlayerChildRemove
   * @private
   * @param {CustomEvent} evt The event object. See {{#crossLink &quot;Dom/childremove:event&quot;}}Dom.childremove{{/crossLink}}
   */
  Editor.prototype.onPlayerChildRemove = function(evt){
    var child = evt.detail.child,
      component = child._metaScore;
  
    if(component){
      if(component.instanceOf(&#x27;Block&#x27;)){
        this.updateBlockSelector();
      }
      else if(component.instanceOf(&#x27;Page&#x27;)){
        this.updatePageSelector();
      }
      else if(component.instanceOf(&#x27;Element&#x27;)){
        this.updateElementSelector();
      }
    }
  };

  /**
   * Player frame load event callback
   *
   * @method onPlayerFrameLoadSuccess
   * @private
   * @param {UIEvent} evt The event object
   */
  Editor.prototype.onPlayerFrameLoadSuccess = function(evt){    
    this.player_frame.get(0).contentWindow.player
      .addListener(&#x27;load&#x27;, metaScore.Function.proxy(this.onPlayerLoadSuccess, this))
      .addListener(&#x27;error&#x27;, metaScore.Function.proxy(this.onPlayerLoadError, this))
      .addListener(&#x27;idset&#x27;, metaScore.Function.proxy(this.onPlayerIdSet, this))
      .addListener(&#x27;revisionset&#x27;, metaScore.Function.proxy(this.onPlayerRevisionSet, this));
  };

  /**
   * Player frame error event callback
   *
   * @method onPlayerFrameLoadError
   * @private
   * @param {UIEvent} evt The event object
   */
  Editor.prototype.onPlayerFrameLoadError = function(evt){
    this.loadmask.hide();
    delete this.loadmask;

    new metaScore.editor.overlay.Alert({
      &#x27;text&#x27;: metaScore.Locale.t(&#x27;editor.onPlayerLoadError.msg&#x27;, &#x27;An error occured while trying to load the guide. Please try again.&#x27;),
      &#x27;buttons&#x27;: {
        &#x27;ok&#x27;: metaScore.Locale.t(&#x27;editor.onPlayerLoadError.ok&#x27;, &#x27;OK&#x27;),
      },
      &#x27;autoShow&#x27;: true
    });
  };

  /**
   * Player load event callback
   *
   * @method onPlayerLoadSuccess
   * @private
   * @param {CustomEvent} evt The event object. See {{#crossLink &quot;Player/load:event&quot;}}Player.load{{/crossLink}}
   */
  Editor.prototype.onPlayerLoadSuccess = function(evt){
    this.player = evt.detail.player
      .addClass(&#x27;in-editor&#x27;)
      .addDelegate(&#x27;.metaScore-component&#x27;, &#x27;click&#x27;, metaScore.Function.proxy(this.onComponentClick, this))
      .addDelegate(&#x27;.metaScore-component.block&#x27;, &#x27;pageadd&#x27;, metaScore.Function.proxy(this.onBlockPageAdd, this))
      .addDelegate(&#x27;.metaScore-component.block&#x27;, &#x27;pageactivate&#x27;, metaScore.Function.proxy(this.onBlockPageActivate, this))
      .addDelegate(&#x27;.metaScore-component.page&#x27;, &#x27;elementadd&#x27;, metaScore.Function.proxy(this.onPageElementAdd, this))
      .addListener(&#x27;blockadd&#x27;, metaScore.Function.proxy(this.onPlayerBlockAdd, this))
      .addListener(&#x27;keydown&#x27;, metaScore.Function.proxy(this.onKeydown, this))
      .addListener(&#x27;keyup&#x27;, metaScore.Function.proxy(this.onKeyup, this))
      .addListener(&#x27;click&#x27;, metaScore.Function.proxy(this.onPlayerClick, this))
      .addListener(&#x27;timeupdate&#x27;, metaScore.Function.proxy(this.onPlayerTimeUpdate, this))
      .addListener(&#x27;rindex&#x27;, metaScore.Function.proxy(this.onPlayerReadingIndex, this))
      .addListener(&#x27;childremove&#x27;, metaScore.Function.proxy(this.onPlayerChildRemove, this));
      
    new metaScore.Dom(this.player_frame.get(0).contentWindow.document.body)
      .addListener(&#x27;keydown&#x27;, metaScore.Function.proxy(this.onKeydown, this))
      .addListener(&#x27;keyup&#x27;, metaScore.Function.proxy(this.onKeyup, this));

    this
      .setEditing(true)
      .updateMainmenu()
      .updateBlockSelector();
      
    this.mainmenu
      .rindexfield.setValue(0, true);
    
    this.detailsOverlay
      .clearValues(true)
      .setValues(this.player.getData(), true);

    this.loadmask.hide();
    delete this.loadmask;
  };

  /**
   * Player error event callback
   *
   * @method onPlayerLoadError
   * @private
   * @param {CustomEvent} evt The event object. See {{#crossLink &quot;Player/error:event&quot;}}Player.error{{/crossLink}}
   */
  Editor.prototype.onPlayerLoadError = function(evt){
    this.loadmask.hide();
    delete this.loadmask;

    new metaScore.editor.overlay.Alert({
      &#x27;text&#x27;: metaScore.Locale.t(&#x27;editor.onPlayerLoadError.msg&#x27;, &#x27;An error occured while trying to load the guide. Please try again.&#x27;),
      &#x27;buttons&#x27;: {
        &#x27;ok&#x27;: metaScore.Locale.t(&#x27;editor.onPlayerLoadError.ok&#x27;, &#x27;OK&#x27;),
      },
      &#x27;autoShow&#x27;: true
    });
  };

  /**
   * Player click event callback
   *
   * @method onPlayerClick
   * @private
   * @param {MouseEvent} evt The event object
   */
  Editor.prototype.onPlayerClick = function(evt){
    
    if(metaScore.editing !== true){
      return;
    }

    this.panels.block.unsetComponent();

    evt.stopPropagation();
  };

  /**
   * Component click event callback
   *
   * @method onComponentClick
   * @private
   * @param {MouseEvent} evt The event object
   */
  Editor.prototype.onComponentClick = function(evt, dom){
    var component;

    if(metaScore.editing !== true){
      return;
    }

    component = dom._metaScore;

    if(component.instanceOf(&#x27;Element&#x27;)){
      this.panels.element.setComponent(component);
    }
    else if(component.instanceOf(&#x27;Page&#x27;)){
      this.panels.page.setComponent(component);
    }
    else{
      this.panels.block.setComponent(component);
    }
    
    evt.stopImmediatePropagation();
  };

  /**
   * Block pageadd event callback
   *
   * @method onBlockPageAdd
   * @private
   * @param {CustomEvent} evt The event object. See {{#crossLink &quot;Block/pageadd:event&quot;}}Block.pageadd{{/crossLink}}
   */
  Editor.prototype.onBlockPageAdd = function(evt){
    var block = evt.detail.block;
    
    if(block === this.panels.block.getComponent()){
      this.updatePageSelector();
    }

    evt.stopPropagation();
  };

  /**
   * Block pageactivate event callback
   *
   * @method onBlockPageActivate
   * @private
   * @param {CustomEvent} evt The event object. See {{#crossLink &quot;Block/pageactivate:event&quot;}}Block.pageactivate{{/crossLink}}
   */
  Editor.prototype.onBlockPageActivate = function(evt){
    var page, basis;
  
    if(metaScore.editing !== true){
      return;
    }
    
    page = evt.detail.page;
    basis = evt.detail.basis;

    if((basis !== &#x27;pagecuepoint&#x27;) || (page.getBlock() === this.panels.block.getComponent())){
      this.panels.page.setComponent(page);
    }
  };

  /**
   * Page elementadd event callback
   *
   * @method onPageElementAdd
   * @private
   * @param {CustomEvent} evt The event object. See {{#crossLink &quot;Page/elementadd:event&quot;}}Page.elementadd{{/crossLink}}
   */
  Editor.prototype.onPageElementAdd = function(evt){
    var page = evt.detail.page;
    
    if(page === this.panels.page.getComponent()){
      this.updateElementSelector();
    }

    evt.stopPropagation();
  };

  /**
   * History add event callback
   *
   * @method onHistoryAdd
   * @private
   * @param {CustomEvent} evt The event object. See {{#crossLink &quot;History/add:event&quot;}}History.add{{/crossLink}}
   */
  Editor.prototype.onHistoryAdd = function(evt){
    this.updateMainmenu();
  };

  /**
   * History undo event callback
   *
   * @method onHistoryUndo
   * @private
   * @param {CustomEvent} evt The event object. See {{#crossLink &quot;History/undo:event&quot;}}History.undo{{/crossLink}}
   */
  Editor.prototype.onHistoryUndo = function(evt){
    this.updateMainmenu();
  };

  /**
   * History redo event callback
   *
   * @method onHistoryRedo
   * @private
   * @param {CustomEvent} evt The event object. See {{#crossLink &quot;History/redo:event&quot;}}History.redo{{/crossLink}}
   */
  Editor.prototype.onHistoryRedo = function(evt){
    this.updateMainmenu();
  };

  /**
   * GuideDetails show event callback
   *
   * @method onDetailsOverlayShow
   * @private
   * @param {CustomEvent} evt The event object. See {{#crossLink &quot;Overlay/show:event&quot;}}Overlay.show{{/crossLink}}
   */
  Editor.prototype.onDetailsOverlayShow = function(evt){
    var player = this.getPlayer();
    
    if(player){
      player.getMedia().pause();
    }
  };

  /**
   * GuideDetails submit event callback
   *
   * @method onDetailsOverlaySubmit
   * @private
   * @param {CustomEvent} evt The event object. See {{#crossLink &quot;GuideDetails/submit:event&quot;}}GuideDetails.submit{{/crossLink}}
   */
  Editor.prototype.onDetailsOverlaySubmit = function(op, evt){
    var overlay = evt.detail.overlay,
      data = evt.detail.values,
      player, callback;
    
    switch(op){
      case &#x27;create&#x27;:
        this.createGuide(data, overlay);
        break;
        
      case &#x27;update&#x27;:
        player = this.getPlayer();
      
        callback = metaScore.Function.proxy(function(){          
          player.updateData(data);
          overlay.setValues(metaScore.Object.extend({}, player.getData(), data), true).hide();
        }, this);
      
        if(&#x27;media&#x27; in data){
          this.getMediaFileDuration(data[&#x27;media&#x27;].url, metaScore.Function.proxy(function(new_duration){
            var old_duration = player.getMedia().getDuration(),
              blocks = [], block, page;
          
            if(new_duration !== old_duration){
              if(new_duration &lt; old_duration){                
                player.getComponents(&#x27;.block&#x27;).each(function(index, block_dom){
                  if(block_dom._metaScore){
                    block = block_dom._metaScore;
                    
                    if(block.getProperty(&#x27;synched&#x27;)){
                      block.getPages().each(function(index, page_dom){
                        if(page_dom._metaScore){
                          page = page_dom._metaScore;
                          
                          if(page.getProperty(&#x27;start-time&#x27;) &lt; new_duration){
                            blocks.push(block.getProperty(&#x27;name&#x27;));
                            return false;
                          }
                        }
                      });
                    }
                  }
                });
              }
              
              if(blocks.length &gt; 0){
                new metaScore.editor.overlay.Alert({
                  &#x27;text&#x27;: metaScore.Locale.t(&#x27;editor.onDetailsOverlaySubmit.update.shorter.msg&#x27;, &#x27;The duration of selected media file (!new_duration centiseconds) is less than the current one (!old_duration centiseconds).&lt;br/&gt;&lt;strong&gt;This will cause some pages of the following blocks to become out of reach: !blocks&lt;/strong&gt;&lt;br/&gt;Please modify the start time of those pages and try again.&#x27;, {&#x27;!new_duration&#x27;: new_duration, &#x27;!old_duration&#x27;: old_duration, &#x27;!blocks&#x27;: blocks.join(&#x27;, &#x27;)}),
                  &#x27;buttons&#x27;: {
                    &#x27;ok&#x27;: metaScore.Locale.t(&#x27;editor.onDetailsOverlaySubmit.update.shorter.ok&#x27;, &#x27;OK&#x27;),
                  },
                  &#x27;autoShow&#x27;: true
                });
              }
              else{
                new metaScore.editor.overlay.Alert({
                  &#x27;text&#x27;: metaScore.Locale.t(&#x27;editor.onDetailsOverlaySubmit.update.diffferent.msg&#x27;, &#x27;The duration of selected media file (!new_duration centiseconds) differs from the current one (!old_duration centiseconds).&lt;br/&gt;&lt;strong&gt;This can cause pages and elements to become desynchronized.&lt;/strong&gt;&lt;br/&gt;Are you sure you want to use the new media file?&#x27;, {&#x27;!new_duration&#x27;: new_duration, &#x27;!old_duration&#x27;: old_duration}),
                  &#x27;buttons&#x27;: {
                    &#x27;confirm&#x27;: metaScore.Locale.t(&#x27;editor.onDetailsOverlaySubmit.update.diffferent.yes&#x27;, &#x27;Yes&#x27;),
                    &#x27;cancel&#x27;: metaScore.Locale.t(&#x27;editor.onDetailsOverlaySubmit.update.diffferent.no&#x27;, &#x27;No&#x27;)
                  },
                  &#x27;autoShow&#x27;: true
                })
                .addListener(&#x27;buttonclick&#x27;, function(evt){
                  if(evt.detail.action === &#x27;confirm&#x27;){
                    callback();
                  }
                });
              }
            }
            else{
              callback();
            }
          }, this));
        }
        else{
          callback();
        }
        break;
    }
  };

  /**
   * Window hashchange event callback
   *
   * @method onWindowHashChange
   * @private
   * @param {HashChangeEvent} evt The event object
   */
  Editor.prototype.onWindowHashChange = function(evt){
    var callback = metaScore.Function.proxy(this.loadPlayerFromHash, this),
      oldURL = evt.oldURL;
  
    if(this.getPlayer()){
      new metaScore.editor.overlay.Alert({
          &#x27;text&#x27;: metaScore.Locale.t(&#x27;editor.onWindowHashChange.alert.msg&#x27;, &#x27;Are you sure you want to open another guide ?&lt;br/&gt;&lt;strong&gt;Any unsaved data will be lost.&lt;/strong&gt;&#x27;),
          &#x27;buttons&#x27;: {
            &#x27;confirm&#x27;: metaScore.Locale.t(&#x27;editor.onWindowHashChange.alert.yes&#x27;, &#x27;Yes&#x27;),
            &#x27;cancel&#x27;: metaScore.Locale.t(&#x27;editor.onWindowHashChange.alert.no&#x27;, &#x27;No&#x27;)
          },
          &#x27;autoShow&#x27;: true
        })
        .addListener(&#x27;buttonclick&#x27;, function(evt){
          if(evt.detail.action === &#x27;confirm&#x27;){
            callback();
          }
          else{
            window.history.replaceState(null, null, oldURL);
          }
        });
    }
    else{
      callback();
    }
    
    evt.preventDefault();
  };

  /**
   * Window beforeunload event callback
   *
   * @method onWindowBeforeUnload
   * @private
   * @param {Event} evt The event object
   */
  Editor.prototype.onWindowBeforeUnload = function(evt){  
    if(this.hasOwnProperty(&#x27;player&#x27;)){
      evt.returnValue = metaScore.Locale.t(&#x27;editor.onWindowBeforeUnload.msg&#x27;, &#x27;Any unsaved data will be lost.&#x27;);
    }
  };

  /**
   * Updates the editing state
   *
   * @method setEditing
   * @param {Boolean} editing The new state
   * @param {Boolean} sticky Whether the new state is persistent or temporary
   * @chainable
   */
  Editor.prototype.setEditing = function(editing, sticky){
    var player = this.getPlayer();
  
    metaScore.editing = editing !== false;

    if(sticky !== false){
      this.persistentEditing = metaScore.editing;
    }

    metaScore.Object.each(this.panels, function(key, panel){
      if(metaScore.editing){
        panel.enable();
      }
      else{
        panel.disable();
      }
    });

    this.toggleClass(&#x27;editing&#x27;, metaScore.editing);

    if(player){
      player.toggleClass(&#x27;editing&#x27;, metaScore.editing);
    }
    
    this.toggleSidebarResizer();
    
    return this;
    
  };

  /**
   * Toggles the activation of the sidebar resizer
   *
   * @method toggleSidebarResizer
   * @chainable
   */
  Editor.prototype.toggleSidebarResizer = function(){
    if(!this.hasClass(&#x27;editing&#x27;) || this.hasClass(&#x27;sidebar-hidden&#x27;)){
      this.sidebar_resizer.disable();
    }
    else{
      this.sidebar_resizer.enable();
    }
    
    return this;
  };

  /**
   * Loads a player from the location hash
   *
   * @method loadPlayerFromHash
   * @chainable
   */
  Editor.prototype.loadPlayerFromHash = function(){
    var hash, match;
    
    hash = window.location.hash;

    if(match = hash.match(/(#|&amp;)guide=(\d+)(:(\d+))?/)){
      this.loadPlayer(match[2], match[4]);
    }
    
    return this;
  };

  /**
   * Updates the states of the mainmenu buttons
   *
   * @method updateMainmenu
   * @chainable 
   */
  Editor.prototype.updateMainmenu = function(){
    var hasPlayer = this.hasOwnProperty(&#x27;player&#x27;);

    this.mainmenu.toggleButton(&#x27;edit&#x27;, hasPlayer);
    this.mainmenu.toggleButton(&#x27;save-draft&#x27;, hasPlayer);
    this.mainmenu.toggleButton(&#x27;save-copy&#x27;, hasPlayer);
    this.mainmenu.toggleButton(&#x27;publish&#x27;, hasPlayer);
    this.mainmenu.toggleButton(&#x27;delete&#x27;, hasPlayer);
    //this.mainmenu.toggleButton(&#x27;download&#x27;, hasPlayer);

    this.mainmenu.toggleButton(&#x27;undo&#x27;, this.history.hasUndo());
    this.mainmenu.toggleButton(&#x27;redo&#x27;, this.history.hasRedo());
    this.mainmenu.toggleButton(&#x27;revert&#x27;, hasPlayer);
    
    return this;
  };

  /**
   * Updates the selector of the block panel
   *
   * @method updateBlockSelector
   * @chainable 
   */
  Editor.prototype.updateBlockSelector = function(){
    var toolbar = this.panels.block.getToolbar(),
      selector = toolbar.getSelector(),
      block, label;
  
    selector
      .clear()
      .addOption(null, &#x27;&#x27;);
        
    this.getPlayer().getComponents(&#x27;.media.video, .controller, .block&#x27;).each(function(index, dom){
      if(dom._metaScore){
        block = dom._metaScore;
        
        if(block.instanceOf(&#x27;Block&#x27;)){
          if(block.getProperty(&#x27;synched&#x27;)){
            label = metaScore.Locale.t(&#x27;editor.blockSelectorOptionLabelSynched&#x27;, &#x27;!name (synched)&#x27;, {&#x27;!name&#x27;: block.getName()});
          }
          else{
            label = metaScore.Locale.t(&#x27;editor.blockSelectorOptionLabelNotSynched&#x27;, &#x27;!name (not synched)&#x27;, {&#x27;!name&#x27;: block.getName()});
          }
        }
        else{
          label = block.getName();
        }
        
        selector.addOption(block.getId(), label);
      }
    }, this);
    
    block = this.panels.block.getComponent();
    selector.setValue(block ? block.getId() : null, true);
    
    return this;
  };

  /**
   * Updates the selector of the page panel
   *
   * @method updatePageSelector
   * @chainable 
   */
  Editor.prototype.updatePageSelector = function(){
    var block = this.panels.block.getComponent(),
      page = this.panels.page.getComponent(),
      toolbar = this.panels.page.getToolbar(),
      selector = toolbar.getSelector();
  
    selector.clear();
  
    if(block.instanceOf(&#x27;Block&#x27;)){
      this.panels.block.getComponent().getPages().each(function(index, page){
        selector.addOption(page._metaScore.getId(), index+1);
      }, this);
    }
    
    selector.setValue(page ? page.getId() : null, true);
    
    return this;
  };

  /**
   * Updates the selector of the element panel
   *
   * @method updateElementSelector
   * @chainable 
   */
  Editor.prototype.updateElementSelector = function(){
    var block = this.panels.block.getComponent(),
      page = this.panels.page.getComponent(),
      toolbar = this.panels.element.getToolbar(),
      selector = toolbar.getSelector(),
      synched = block.getProperty(&#x27;synched&#x27;),
      element, out_of_range,
      page_start_time, page_end_time,
      element_start_time, element_end_time,
      rindex, optgroups = {};
      
    // clear the selector
    selector.clear();
    
    // fill the list of optgroups
    if(page.instanceOf(&#x27;Page&#x27;)){    
      if(synched){
        page_start_time = page.getProperty(&#x27;start-time&#x27;);
        page_end_time = page.getProperty(&#x27;end-time&#x27;);
      }
      
      page.getElements().each(function(index, dom){
        element = dom._metaScore;
        out_of_range = false;
        
        if(synched){
          element_start_time = element.getProperty(&#x27;start-time&#x27;);
          element_end_time = element.getProperty(&#x27;end-time&#x27;);
          
          out_of_range = ((element_start_time !== null) &amp;&amp; (element_start_time &lt; page_start_time)) || ((element_end_time !== null) &amp;&amp; (element_end_time &gt; page_end_time));
        }
        
        rindex = element.getProperty(&#x27;r-index&#x27;) || 0;
        
        if(!(rindex in optgroups)){
          optgroups[rindex] = [];
        }
        
        optgroups[rindex].push({
          &#x27;element&#x27;: element,
          &#x27;out_of_range&#x27;: out_of_range
        });
      }, this);
    }
    
    // create the optgroups and their options
    metaScore.Array.each(Object.keys(optgroups).sort(), function(index, rindex){
      var options = optgroups[rindex],
        optgroup, sortFn = metaScore.Array.naturalSort(true);
        
      // sort options by element names
      options.sort(function(a, b){
        return sortFn(a.element.getName(), b.element.getName());
      });
    
      // create the optgroup
      optgroup = selector.addGroup(metaScore.Locale.t(&#x27;editor.elementSelectorGroupLabel&#x27;, &#x27;Reading index !rindex&#x27;, {&#x27;!rindex&#x27;: rindex})).attr(&#x27;data-rindex&#x27;, rindex);
      
      // create the options
      metaScore.Array.each(options, function(index, option){      
        var element = option.element,
          out_of_range = option.out_of_range;
          
        selector
          .addOption(element.getId(), (out_of_range ? &#x27;*&#x27; : &#x27;&#x27;) + element.getName(), optgroup)
          .toggleClass(&#x27;out-of-range&#x27;, out_of_range);
      }, this);
    }, this);
    
    element = this.panels.element.getComponent();
    
    selector.setValue(element ? element.getId() : null, true);
    
    return this;
  };

  /**
   * Get the player instance if any
   *
   * @method getPlayer
   * @return {Player} The player instance
   */
  Editor.prototype.getPlayer = function(){  
    return this.player;  
  };

  /**
   * Loads a player by guide id and vid
   *
   * @method loadPlayer
   * @param {Number} id The guide&#x27;s id
   * @param {Number} vid The guide&#x27;s revision id 
   * @chainable 
   */
  Editor.prototype.loadPlayer = function(id, vid){
    var url = this.configs.player_url + id;
    
    url += &quot;?in-editor&quot;;
    
    if(vid){
      url += &quot;&amp;vid=&quot;+ vid;
    }
  
    this.loadmask = new metaScore.editor.overlay.LoadMask({
      &#x27;autoShow&#x27;: true
    });
    
    this.player_frame.get(0).contentWindow.location.replace(url);
    
    return this;
  };

  /**
   * Removes the player
   *
   * @method removePlayer
   * @chainable 
   */
  Editor.prototype.removePlayer = function(){    
    delete this.player;

    this.player_frame.get(0).contentWindow.location.replace(&#x27;about:blank&#x27;);
    this.panels.block.unsetComponent();
    this.updateMainmenu();
    
    return this;
  };

  /**
   * Opens the guide selector
   *
   * @method openGuideSelector
   * @chainable 
   */
  Editor.prototype.openGuideSelector = function(){
    new metaScore.editor.overlay.GuideSelector({
        &#x27;url&#x27;: this.configs.api_url +&#x27;guide.json&#x27;,
        &#x27;autoShow&#x27;: true
      })
      .addListener(&#x27;submit&#x27;, metaScore.Function.proxy(this.onGuideSelectorSubmit, this));
    
    return this;
  };

  /**
   * Creates a new guide
   *
   * @method createGuide
   * @param {Object} details The guide&#x27;s data
   * @param {GuideDetails} overlay The overlay instance used to create the guide
   * @chainable 
   */
  Editor.prototype.createGuide = function(details, overlay){
    var data = new FormData(),
      options;
    
    // append values from the details overlay
    metaScore.Object.each(details, function(key, value){
      if(key === &#x27;thumbnail&#x27; || key === &#x27;media&#x27;){
        data.append(&#x27;files[&#x27;+ key +&#x27;]&#x27;, value.object);
      }
      else{
        data.append(key, value);
      }
    });

    // prepare the Ajax options object
    options = metaScore.Object.extend({
      &#x27;data&#x27;: data,
      &#x27;dataType&#x27;: &#x27;json&#x27;,
      &#x27;success&#x27;: metaScore.Function.proxy(this.onGuideCreateSuccess, this, [overlay]),
      &#x27;error&#x27;: metaScore.Function.proxy(this.onGuideCreateError, this)
    }, this.configs.ajax);

    // add a loading mask
    this.loadmask = new metaScore.editor.overlay.LoadMask({
      &#x27;text&#x27;: metaScore.Locale.t(&#x27;editor.createGuide.LoadMask.text&#x27;, &#x27;Saving...&#x27;),
      &#x27;autoShow&#x27;: true
    });

    metaScore.Ajax.post(this.configs.api_url +&#x27;guide.json&#x27;, options);
    
    return this;
  };

  /**
   * Saves the loaded guide
   *
   * @method saveGuide
   * @param {String} action The action to perform when saving (&#x27;update&#x27; or &#x27;duplicate&#x27;)
   * @param {Boolean} publish Whether to published the new revision
   * @chainable
   */
  Editor.prototype.saveGuide = function(action, publish){
    var player = this.getPlayer(),
      id = player.getId(),
      vid = player.getRevision(),
      components = player.getComponents(&#x27;.media, .controller, .block&#x27;),
      data = new FormData(),
      details = this.detailsOverlay.getValues(),
      blocks = [],
      component, options;
    
    // append the publish flag if true
    if(publish === true){
      data.append(&#x27;publish&#x27;, true);
    }
    
    // append values from the details overlay
    metaScore.Object.each(details, function(key, value){
      if(key === &#x27;thumbnail&#x27; || key === &#x27;media&#x27;){
        data.append(&#x27;files[&#x27;+ key +&#x27;]&#x27;, value.object);
      }
      else{
        data.append(key, value);
      }
    });

    // append blocks data
    components.each(function(index, dom){
      component = dom._metaScore;
    
      if(component.instanceOf(&#x27;Media&#x27;)){
        data.append(&#x27;blocks[]&#x27;, JSON.stringify(metaScore.Object.extend({&#x27;type&#x27;: &#x27;media&#x27;}, component.getProperties())));
      }
      else if(component.instanceOf(&#x27;Controller&#x27;)){
        data.append(&#x27;blocks[]&#x27;, JSON.stringify(metaScore.Object.extend({&#x27;type&#x27;: &#x27;controller&#x27;}, component.getProperties())));
      }
      else if(component.instanceOf(&#x27;Block&#x27;)){
        data.append(&#x27;blocks[]&#x27;, JSON.stringify(component.getProperties()));
      }
    }, this);

    // prepare the Ajax options object
    options = metaScore.Object.extend({
      &#x27;data&#x27;: data,
      &#x27;dataType&#x27;: &#x27;json&#x27;,
      &#x27;success&#x27;: metaScore.Function.proxy(this.onGuideSaveSuccess, this),
      &#x27;error&#x27;: metaScore.Function.proxy(this.onGuideSaveError, this)
    }, this.configs.ajax);

    // add a loading mask
    this.loadmask = new metaScore.editor.overlay.LoadMask({
      &#x27;text&#x27;: metaScore.Locale.t(&#x27;editor.saveGuide.LoadMask.text&#x27;, &#x27;Saving...&#x27;),
      &#x27;autoShow&#x27;: true
    });

    metaScore.Ajax.post(this.configs.api_url +&#x27;guide/&#x27;+ id +&#x27;/&#x27;+ action +&#x27;.json?vid=&#x27;+ vid, options);
    
    return this;
  };

  /**
   * Get a media file&#x27;s duration in centiseconds
   *
   * @method getMediaFileDuration
   */
  Editor.prototype.getMediaFileDuration = function(file, callback){  
    var media = new metaScore.Dom(&#x27;&lt;audio/&gt;&#x27;, {&#x27;src&#x27;: file})
      .addListener(&#x27;loadedmetadata&#x27;, function(evt){
        var duration = parseFloat(media.get(0).duration) * 100;
        
        callback(duration);
      });
  };

  return Editor;

})();
    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
