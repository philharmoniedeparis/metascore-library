/*! metaScore - v0.0.2 - 2015-01-21 - Oussama Mubarak */
(function(t){"use strict";var e=t.metaScore;e.Editor=function(){function t(n){this.configs=this.getConfigs(n),t.parent.call(this,"<div/>",{"class":"metaScore-editor"}),this.configs.container&&this.appendTo(this.configs.container),this.h_ruler=new e.Dom("<div/>",{"class":"ruler horizontal"}).appendTo(this),this.v_ruler=new e.Dom("<div/>",{"class":"ruler vertical"}).appendTo(this),this.workspace=new e.Dom("<div/>",{"class":"workspace"}).appendTo(this),this.mainmenu=(new e.editor.MainMenu).appendTo(this),this.sidebar=new e.Dom("<div/>",{"class":"sidebar"}).appendTo(this),this.panels={},this.panels.block=(new e.editor.panel.Block).appendTo(this.sidebar),this.panels.page=(new e.editor.panel.Page).appendTo(this.sidebar),this.panels.element=(new e.editor.panel.Element).appendTo(this.sidebar),this.panels.text=(new e.editor.panel.Text).appendTo(this.sidebar),this.grid=new e.Dom("<div/>",{"class":"grid"}).appendTo(this.workspace),this.version=new e.Dom("<div/>",{"class":"version",text:"metaScore v."+e.getVersion()+" r."+e.getRevision()}).appendTo(this.workspace),this.history=new e.editor.History,this.detailsOverlay=new e.editor.overlay.GuideInfo,this.addDelegate(".timefield","valuein",e.Function.proxy(this.onTimeFieldIn,this)).addDelegate(".timefield","valueout",e.Function.proxy(this.onTimeFieldOut,this)),this.mainmenu.addDelegate("button[data-action]:not(.disabled)","click",e.Function.proxy(this.onMainmenuClick,this)).addDelegate(".time","valuechange",e.Function.proxy(this.onMainmenuTimeFieldChange,this)).addDelegate(".r-index","valuechange",e.Function.proxy(this.onMainmenuRindexFieldChange,this)),this.panels.block.addListener("componentset",e.Function.proxy(this.onBlockSet,this)).addListener("componentunset",e.Function.proxy(this.onBlockUnset,this)).addListener("valueschange",e.Function.proxy(this.onBlockPanelValueChange,this)).getToolbar().addDelegate(".buttons [data-action]","click",e.Function.proxy(this.onBlockPanelToolbarClick,this)),this.panels.page.addListener("componentset",e.Function.proxy(this.onPageSet,this)).addListener("componentunset",e.Function.proxy(this.onPageUnset,this)).addListener("valueschange",e.Function.proxy(this.onPagePanelValueChange,this)).getToolbar().addDelegate(".buttons [data-action]","click",e.Function.proxy(this.onPagePanelToolbarClick,this)),this.panels.element.addListener("componentset",e.Function.proxy(this.onElementSet,this)).addListener("componentunset",e.Function.proxy(this.onElementUnset,this)).addListener("valueschange",e.Function.proxy(this.onElementPanelValueChange,this)).getToolbar().addDelegate(".buttons [data-action]","click",e.Function.proxy(this.onElementPanelToolbarClick,this)),this.history.addListener("add",e.Function.proxy(this.onHistoryAdd,this)).addListener("undo",e.Function.proxy(this.onHistoryUndo,this)).addListener("redo",e.Function.proxy(this.onHistoryRedo,this)),this.detailsOverlay.addListener("submit",e.Function.proxy(this.onDetailsOverlaySubmit,this)),new e.Dom("body").addListener("keydown",e.Function.proxy(this.onKeydown,this)).addListener("keyup",e.Function.proxy(this.onKeyup,this)),new e.Dom(window).addListener("beforeunload",e.Function.proxy(this.onBeforeUnload,this)),this.updateMainmenu(),this.setEditing(!1),this.loadPlayerFromHash()}return e.Dom.extend(t),t.defaults={ajax:{}},t.prototype.setEditing=function(t,n){e.editing=t!==!1,n!==!1&&(this.persistentEditing=e.editing),e.Object.each(this.panels,function(t,n){e.editing?n.enable():n.disable()}),this.toggleClass("editing",e.editing),this.player&&this.player.toggleClass("editing",e.editing)},t.prototype.loadPlayerFromHash=function(){var t;(t=window.location.hash.match(/(#|&)guide=(\d+)/))&&this.addPlayer(t[2])},t.prototype.onGuideSaveSuccess=function(){this.loadmask.hide(),delete this.loadmask},t.prototype.onGuideSaveError=function(){this.loadmask.hide(),delete this.loadmask,new e.editor.overlay.Alert({text:e.Locale.t("editor.onGuideSaveError.msg","An error occured while trying to save the guide. Please try again."),buttons:{ok:e.Locale.t("editor.onGuideSaveError.ok","OK")},autoShow:!0})},t.prototype.onGuideDeleteConfirm=function(){var t,n=this.player.getId();t=e.Object.extend({},{dataType:"json",method:"DELETE",success:e.Function.proxy(this.onGuideDeleteSuccess,this),error:e.Function.proxy(this.onGuideDeleteError,this)},this.configs.ajax),this.loadmask=new e.editor.overlay.LoadMask({autoShow:!0}),e.Ajax.send(this.configs.api_url+"guide/"+n+".json",t)},t.prototype.onGuideDeleteSuccess=function(){this.removePlayer(),this.loadmask.hide(),delete this.loadmask},t.prototype.onGuideDeleteError=function(){this.loadmask.hide(),delete this.loadmask,new e.editor.overlay.Alert({text:e.Locale.t("editor.onGuideDeleteError.msg","An error occured while trying to delete the guide. Please try again."),buttons:{ok:e.Locale.t("editor.onGuideSaveError.ok","OK")},autoShow:!0})},t.prototype.onGuideRevertConfirm=function(){this.addPlayer(this.player.getId())},t.prototype.onPlayerKeydown=t.prototype.onKeydown=function(t){switch(t.keyCode){case 18:t.repeat||(this.setEditing(!this.persistentEditing,!1),t.preventDefault());break;case 90:t.ctrlKey&&(this.history.undo(),t.preventDefault());break;case 89:t.ctrlKey&&(this.history.redo(),t.preventDefault())}},t.prototype.onPlayerKeyup=t.prototype.onKeyup=function(t){switch(t.keyCode){case 18:this.setEditing(this.persistentEditing,!1),t.preventDefault()}},t.prototype.onMainmenuClick=function(t){switch(e.Dom.data(t.target,"action")){case"new":break;case"open":this.hasOwnProperty("player")?new e.editor.overlay.Alert({text:e.Locale.t("editor.onMainmenuClick.open.msg","Are you sure you want to open another guide ?<br/><strong>Any unsaved data will be lost.</strong>"),buttons:{confirm:e.Locale.t("editor.onMainmenuClick.open.yes","Yes"),cancel:e.Locale.t("editor.onMainmenuClick.open.no","No")},autoShow:!0}).addListener("confirmclick",e.Function.proxy(this.openGuideSelector,this)):this.openGuideSelector();break;case"edit":this.detailsOverlay.show();break;case"save":this.saveGuide();break;case"download":break;case"delete":new e.editor.overlay.Alert({text:e.Locale.t("editor.onMainmenuClick.delete.msg","Are you sure you want to delete this guide ?"),buttons:{confirm:e.Locale.t("editor.onMainmenuClick.delete.yes","Yes"),cancel:e.Locale.t("editor.onMainmenuClick.delete.no","No")},autoShow:!0}).addListener("confirmclick",e.Function.proxy(this.onGuideDeleteConfirm,this));break;case"revert":new e.editor.overlay.Alert({text:e.Locale.t("editor.onMainmenuClick.revert.msg","Are you sure you want to revert back to the last saved version ?<br/><strong>Any unsaved data will be lost.</strong>"),buttons:{confirm:e.Locale.t("editor.onMainmenuClick.revert.yes","Yes"),cancel:e.Locale.t("editor.onMainmenuClick.revert.no","No")},autoShow:!0}).addListener("confirmclick",e.Function.proxy(this.onGuideRevertConfirm,this));break;case"undo":this.history.undo();break;case"redo":this.history.redo();break;case"edit-toggle":this.setEditing(!e.editing);break;case"settings":break;case"help":}},t.prototype.onMainmenuTimeFieldChange=function(t){var e=t.target._metaScore,n=e.getValue();this.player.media.setTime(n)},t.prototype.onMainmenuRindexFieldChange=function(t){var e=t.target._metaScore,n=e.getValue();this.player.setReadingIndex(n,!0)},t.prototype.onTimeFieldIn=function(t){var e=t.target._metaScore,n=this.player.media.getTime();e.setValue(n)},t.prototype.onTimeFieldOut=function(t){var e=t.target._metaScore,n=e.getValue();this.player.media.setTime(n)},t.prototype.onBlockSet=function(t){var n=t.detail.component;n instanceof e.player.component.Block&&(this.panels.page.setComponent(n.getActivePage(),!0),this.panels.page.getToolbar().toggleMenuItem("new",!0),this.panels.element.getToolbar().toggleMenuItem("Cursor",!0).toggleMenuItem("Image",!0).toggleMenuItem("Text",!0)),t.stopPropagation()},t.prototype.onBlockUnset=function(){this.panels.page.unsetComponent(),this.panels.page.getToolbar().toggleMenuItem("new",!1)},t.prototype.onBlockPanelValueChange=function(t){var n=t.detail.component,i=t.detail.old_values,o=t.detail.new_values;this.history.add({undo:e.Function.proxy(this.panels.block.updateProperties,this.panels.block,[n,i]),redo:e.Function.proxy(this.panels.block.updateProperties,this.panels.block,[n,o])})},t.prototype.onBlockPanelToolbarClick=function(t){var n,i,o,s;switch(e.Dom.data(t.target,"action")){case"new":i=this.player.addBlock(),this.history.add({undo:e.Function.proxy(i.remove,this),redo:e.Function.proxy(this.addBlock,this,[i])});break;case"delete":i=this.panels.block.getComponent(),i&&(i.remove(),this.panels.block.unsetComponent(),this.history.add({undo:e.Function.proxy(this.addBlock,this,[i]),redo:e.Function.proxy(i.remove,this)}));break;case"previous":n=this.player.getComponents(["media","controller","block"]),o=n.count(),o>0&&(s=n.index(".selected")-1,0>s&&(s=o-1),i=n.get(s)._metaScore,this.panels.block.setComponent(i));break;case"next":n=this.player.getComponents(["media","controller","block"]),o=n.count(),o>0&&(s=n.index(".selected")+1,s>=o&&(s=0),i=n.get(s)._metaScore,this.panels.block.setComponent(i))}t.stopPropagation()},t.prototype.onPageSet=function(t){var e=t.detail.component,n=e.parents().parents().get(0)._metaScore;this.panels.block.setComponent(n),this.panels.page.getToolbar().toggleMenuItem("new",!0),this.panels.element.getToolbar().toggleMenuItem("Cursor",!0).toggleMenuItem("Image",!0).toggleMenuItem("Text",!0),t.stopPropagation()},t.prototype.onPageUnset=function(){this.panels.element.unsetComponent(),this.panels.element.getToolbar().toggleMenuItem("Cursor",!1).toggleMenuItem("Image",!1).toggleMenuItem("Text",!1)},t.prototype.onPagePanelValueChange=function(t){var n=t.detail.component,i=t.detail.old_values,o=t.detail.new_values;this.history.add({undo:e.Function.proxy(this.panels.page.updateProperties,this.panels.page,[n,i]),redo:e.Function.proxy(this.panels.page.updateProperties,this.panels.page,[n,o])})},t.prototype.onPagePanelToolbarClick=function(t){var n,i,o,s,a;switch(e.Dom.data(t.target,"action")){case"new":n=this.panels.block.getComponent(),i=this.addPage(n),this.history.add({undo:e.Function.proxy(i.remove,this),redo:e.Function.proxy(this.addPage,this,[n,i])});break;case"delete":n=this.panels.block.getComponent(),i=this.panels.page.getComponent(),i&&(n.removePage(i),this.panels.page.unsetComponent(),this.history.add({undo:e.Function.proxy(this.addPage,this,[n,i]),redo:e.Function.proxy(i.remove,this)}));break;case"previous":n=this.panels.block.getComponent(),n&&(o=new e.Dom(".page",n),s=o.count(),s>0&&(a=o.index(".selected")-1,0>a&&(a=s-1),i=o.get(a)._metaScore,n.setActivePage(i)));break;case"next":n=this.panels.block.getComponent(),n&&(o=new e.Dom(".page",n),s=o.count(),s>0&&(a=o.index(".selected")+1,a>=s&&(a=0),i=o.get(a)._metaScore,n.setActivePage(i)))}t.stopPropagation()},t.prototype.onElementSet=function(t){var e=t.detail.component,n=e.parents().get(0)._metaScore,i=n.parents().parents().get(0)._metaScore;this.panels.page.setComponent(n),this.panels.block.setComponent(i),"Text"===e.getProperty("type")&&this.panels.text.setComponent(e),t.stopPropagation()},t.prototype.onElementUnset=function(t){this.panels.text.unsetComponent(),t.stopPropagation()},t.prototype.onElementPanelValueChange=function(t){var n=t.detail.component,i=t.detail.old_values,o=t.detail.new_values;this.history.add({undo:e.Function.proxy(this.panels.element.updateProperties,this.panels.element,[n,i]),redo:e.Function.proxy(this.panels.element.updateProperties,this.panels.element,[n,o])})},t.prototype.onElementPanelToolbarClick=function(t){var n,i,o,s,a,r=e.Dom.data(t.target,"action");switch(r){case"Cursor":case"Image":case"Text":n=this.panels.page.getComponent(),i=this.addElement(n,{type:r}),this.history.add({undo:e.Function.proxy(i.remove,this),redo:e.Function.proxy(this.addElement,this,[n,i])});break;case"delete":n=this.panels.page.getComponent(),i=this.panels.element.getComponent(),i&&(i.remove(),this.panels.element.unsetComponent(),this.history.add({undo:e.Function.proxy(this.addElement,this,[n,i]),redo:e.Function.proxy(i.remove,this)}));break;case"previous":n=this.panels.page.getComponent(),n&&(o=new e.Dom(".element",n),s=o.count(),s>0&&(a=o.index(".selected")-1,0>a&&(a=s-1),i=o.get(a)._metaScore,this.panels.element.setComponent(i)));break;case"next":n=this.panels.page.getComponent(),n&&(o=new e.Dom(".element",n),s=o.count(),s>0&&(a=o.index(".selected")+1,a>=s&&(a=0),i=o.get(a)._metaScore,this.panels.element.setComponent(i)))}},t.prototype.onPlayerTimeUpdate=function(t){var e=t.detail.media.getTime();this.mainmenu.timefield.setValue(e,!0)},t.prototype.onPlayerReadingIndex=function(t){var e=t.detail.value;this.mainmenu.rindexfield.setValue(e,!0)},t.prototype.onPlayerMediaAdd=function(t){var e=t.detail.media;this.panels.block.getToolbar().addComponent(e)},t.prototype.onPlayerControllerAdd=function(t){var e=t.detail.controller;this.panels.block.getToolbar().addComponent(e)},t.prototype.onPlayerBlockAdd=function(t){var e=t.detail.block;this.panels.block.getToolbar().addComponent(e)},t.prototype.onPlayerLoadSuccess=function(t){var n=t.detail.player,i=t.detail.data;this.player=n,this.player.addListener("click",e.Function.proxy(this.onPlayerClick,this)).addListener("keydown",e.Function.proxy(this.onPlayerKeydown,this)).addListener("keyup",e.Function.proxy(this.onPlayerKeyup,this)).addListener("timeupdate",e.Function.proxy(this.onPlayerTimeUpdate,this)).addListener("rindex",e.Function.proxy(this.onPlayerReadingIndex,this)).addDelegate(".metaScore-component","click",e.Function.proxy(this.onComponentClick,this)).addDelegate(".metaScore-component.block","pageactivate",e.Function.proxy(this.onBlockPageActivated,this)),this.setEditing(!0),this.updateMainmenu(),this.detailsOverlay.setValues(i),window.history.replaceState(null,null,"#guide="+this.player.getId()),this.loadmask.hide(),delete this.loadmask},t.prototype.onPlayerLoadError=function(){this.loadmask.hide(),delete this.loadmask,new e.editor.overlay.Alert({text:e.Locale.t("editor.onPlayerLoadError.msg","An error occured while trying to load the guide. Please try again."),buttons:{ok:e.Locale.t("editor.onPlayerLoadError.ok","OK")},autoShow:!0})},t.prototype.onComponentClick=function(t,n){var i;e.editing===!0&&(i=n._metaScore,i instanceof e.player.component.Block?this.panels.block.setComponent(i):i instanceof e.player.component.Controller?this.panels.block.setComponent(i):i instanceof e.player.component.Media?this.panels.block.setComponent(i):i instanceof e.player.component.Page?this.panels.page.setComponent(i):i instanceof e.player.component.Element&&this.panels.element.setComponent(i))},t.prototype.onPlayerClick=function(t){e.editing===!0&&(this.panels.block.unsetComponent(),t.stopPropagation())},t.prototype.onBlockPageActivated=function(t){e.editing===!0&&this.panels.page.setComponent(t.detail.page)},t.prototype.onHistoryAdd=function(){this.updateMainmenu()},t.prototype.onHistoryUndo=function(){this.updateMainmenu()},t.prototype.onHistoryRedo=function(){this.updateMainmenu()},t.prototype.onDetailsOverlaySubmit=function(t){var e=t.detail.values;this.player.updateCSS(e.css)},t.prototype.onBeforeUnload=function(t){this.hasOwnProperty("player")&&(t.returnValue=e.Locale.t("editor.onBeforeUnload.msg","Any unsaved data will be lost."))},t.prototype.updateMainmenu=function(){var t=this.hasOwnProperty("player");this.mainmenu.toggleButton("edit",t),this.mainmenu.toggleButton("save",t),this.mainmenu.toggleButton("delete",t),this.mainmenu.toggleButton("download",t),this.mainmenu.toggleButton("undo",this.history.hasUndo()),this.mainmenu.toggleButton("redo",this.history.hasRedo()),this.mainmenu.toggleButton("revert",t)},t.prototype.addPlayer=function(t){this.loadmask=new e.editor.overlay.LoadMask({autoShow:!0}),this.removePlayer(),new e.Player({container:this.workspace,url:this.configs.api_url+"guide/"+t+".json"}).addClass("in-editor").addListener("mediaadd",e.Function.proxy(this.onPlayerMediaAdd,this)).addListener("controlleradd",e.Function.proxy(this.onPlayerControllerAdd,this)).addListener("blockadd",e.Function.proxy(this.onPlayerBlockAdd,this)).addListener("loadsuccess",e.Function.proxy(this.onPlayerLoadSuccess,this)).addListener("loaderror",e.Function.proxy(this.onPlayerLoadError,this))},t.prototype.removePlayer=function(){this.player&&(this.player.remove(),delete this.player),this.panels.block.unsetComponent(),this.updateMainmenu()},t.prototype.addBlock=function(t){return t instanceof e.player.component.Block||(t=this.player.addBlock(t)),this.panels.block.setComponent(t),t},t.prototype.addPage=function(t,n){return n instanceof e.player.component.Page||(n=t.addPage(n)),this.panels.page.setComponent(n),n},t.prototype.addElement=function(t,n){return n instanceof e.player.component.Element||(n=t.addElement(n)),this.panels.element.setComponent(n),n},t.prototype.openGuideSelector=function(){new e.editor.overlay.GuideSelector({url:this.configs.api_url+"guide.json",autoShow:!0}).addListener("select",e.Function.proxy(this.openGuide,this))},t.prototype.openGuide=function(t){this.addPlayer(t.detail.guide.id)},t.prototype.saveGuide=function(){var t,n,i=this.player.getComponents(),o=this.player.getId(),s=this.detailsOverlay.getValues();i.each(function(n,i){t=i._metaScore,t instanceof e.player.component.Media?s.media=t.getProperties():t instanceof e.player.component.Controller?s.controller=t.getProperties():t instanceof e.player.component.Block&&("blocks"in s||(s.blocks=[]),s.blocks.push(t.getProperties()))},this),n=e.Object.extend({},{data:JSON.stringify(s),dataType:"json",success:e.Function.proxy(this.onGuideSaveSuccess,this),error:e.Function.proxy(this.onGuideSaveError,this)},this.configs.ajax),this.loadmask=new e.editor.overlay.LoadMask({autoShow:!0}),e.Ajax.put(this.configs.api_url+"guide/"+o+".json",n)},t}(),e.namespace("editor").Button=function(){function t(t){this.configs=this.getConfigs(t),e.Dom.call(this,"<button/>"),this.disabled=!1,this.configs.label&&this.setLabel(this.configs.label),this.addListener("click",e.Function.proxy(this.onClick,this))}return t.defaults={label:null},e.Dom.extend(t),t.prototype.onClick=function(t){this.disabled&&t.stopPropagation()},t.prototype.setLabel=function(t){return void 0===this.label&&(this.label=new e.Dom("<span/>",{"class":"label"}).appendTo(this)),this.label.text(t),this},t.prototype.disable=function(){return this.disabled=!0,this.addClass("disabled"),this},t.prototype.enable=function(){return this.disabled=!1,this.removeClass("disabled"),this},t}(),e.namespace("editor").DropDownMenu=function(){function t(t){this.configs=this.getConfigs(t),e.Dom.call(this,"<ul/>",{"class":"dropdown-menu"})}return e.Dom.extend(t),t.prototype.addItem=function(t,n){var i=new e.Dom("<li/>",{"data-action":t,text:n}).appendTo(this);return i},t.prototype.toggleItem=function(t,e){return this.child('[data-action="'+t+'"]').toggleClass("disabled",e===!1),this},t}(),e.namespace("editor").Field=function(){function t(t){this.configs=this.getConfigs(t),e.Dom.call(this,"<div/>",{"class":"field"}),this.setupUI(),this.get(0)._metaScore=this,this.disabled=!1,null!==this.configs.value&&this.setValue(this.configs.value),this.configs.disabled&&this.disable()}return t.defaults={value:null,disabled:!1},e.Dom.extend(t),t.prototype.setupUI=function(){var t="field-"+e.String.uuid(5);this.configs.label&&(this.label=new e.Dom("<label/>",{"for":t,text:this.configs.label}).appendTo(this)),this.input_wrapper=new e.Dom("<div/>",{"class":"input-wrapper"}).appendTo(this),this.input=new e.Dom("<input/>",{type:"text",id:t}).addListener("change",e.Function.proxy(this.onChange,this)).appendTo(this.input_wrapper)},t.prototype.onChange=function(){this.value=this.input.val(),this.triggerEvent("valuechange",{field:this,value:this.value},!0,!1)},t.prototype.setValue=function(t,e){this.input.val(t),this.value=t,e!==!0&&this.input.triggerEvent("change")},t.prototype.getValue=function(){return this.value},t.prototype.disable=function(){return this.disabled=!0,this.addClass("disabled"),this.input.attr("disabled","disabled"),this},t.prototype.enable=function(){return this.disabled=!1,this.removeClass("disabled"),this.input.attr("disabled",null),this},t}(),e.namespace("editor").History=function(){function t(e){this.configs=this.getConfigs(e),t.parent.call(this),this.commands=[],this.index=-1,this.executing=!1}return t.defaults={max_commands:30},e.Evented.extend(t),t.prototype.execute=function(t,e){return t&&e in t&&(this.executing=!0,t[e](t),this.executing=!1),this},t.prototype.add=function(t){return this.executing?this:(this.commands.splice(this.index+1,this.commands.length-this.index),this.commands.push(t),this.commands.length>this.configs.max_commands&&(this.commands=this.commands.slice(-1*this.configs.max_commands)),this.index=this.commands.length-1,this.triggerEvent("add",{command:t}),this)},t.prototype.undo=function(){var t=this.commands[this.index];return t?(this.execute(t,"undo"),this.index-=1,this.triggerEvent("undo",{command:t}),this):this},t.prototype.redo=function(){var t=this.commands[this.index+1];return t?(this.execute(t,"redo"),this.index+=1,this.triggerEvent("redo",{command:t}),this):this},t.prototype.clear=function(){var t=this.commands.length;this.commands=[],this.index=-1,t>0&&this.triggerEvent("clear")},t.prototype.hasUndo=function(){return-1!==this.index},t.prototype.hasRedo=function(){return this.index<this.commands.length-1},t}(),e.namespace("editor").MainMenu=function(){function t(){t.parent.call(this,"<div/>",{"class":"main-menu clearfix"}),this.setupUI()}return e.Dom.extend(t),t.prototype.setupUI=function(){var t,n;t=new e.Dom("<div/>",{"class":"left"}).appendTo(this),n=new e.Dom("<div/>",{"class":"right"}).appendTo(this),new e.Dom("<div/>",{"class":"logo-philharmonie"}).appendTo(t),(new e.editor.Button).attr({title:e.Locale.t("editor.MainMenu.new","New")}).data("action","new").appendTo(t),(new e.editor.Button).attr({title:e.Locale.t("editor.MainMenu.open","Open")}).data("action","open").appendTo(t),(new e.editor.Button).attr({title:e.Locale.t("editor.MainMenu.edit","Edit")}).data("action","edit").appendTo(t),(new e.editor.Button).attr({title:e.Locale.t("editor.MainMenu.save","Save")}).data("action","save").appendTo(t),(new e.editor.Button).attr({title:e.Locale.t("editor.MainMenu.delete","Delete")}).data("action","delete").appendTo(t),(new e.editor.Button).attr({title:e.Locale.t("editor.MainMenu.download","Download")}).data("action","download").appendTo(t),this.timefield=(new e.editor.field.Time).attr({title:e.Locale.t("editor.MainMenu.time","Time")}).addClass("time").appendTo(t),this.rindexfield=new e.editor.field.Number({min:0}).attr({title:e.Locale.t("editor.MainMenu.r-index","Reading index")}).addClass("r-index").appendTo(t),(new e.editor.Button).attr({title:e.Locale.t("editor.MainMenu.edit-toggle","Toggle edit mode")}).data("action","edit-toggle").appendTo(t),(new e.editor.Button).attr({title:e.Locale.t("editor.MainMenu.revert","Revert")}).data("action","revert").appendTo(t),(new e.editor.Button).attr({title:e.Locale.t("editor.MainMenu.undo","Undo")}).data("action","undo").appendTo(t),(new e.editor.Button).attr({title:e.Locale.t("editor.MainMenu.redo","Redo")}).data("action","redo").appendTo(t),(new e.editor.Button).attr({title:e.Locale.t("editor.MainMenu.settings","Settings")}).data("action","settings").appendTo(n),(new e.editor.Button).attr({title:e.Locale.t("editor.MainMenu.help","Help")}).data("action","help").appendTo(n)},t.prototype.toggleButton=function(t,e){return this.child('[data-action="'+t+'"]').toggleClass("disabled",e===!1),this},t}(),e.namespace("editor").Overlay=function(){function t(n){this.configs=this.getConfigs(n),t.parent.call(this,"<div/>",{"class":"overlay clearfix"}),this.configs.modal&&(this.mask=new e.Dom("<div/>",{"class":"overlay-mask"})),this.configs.autoShow&&this.show(),this.configs.toolbar&&(this.toolbar=new e.editor.overlay.Toolbar({title:this.configs.title}).appendTo(this),this.toolbar.addButton("close").addListener("click",e.Function.proxy(this.onCloseClick,this))),this.contents=new e.Dom("<div/>",{"class":"contents"}).appendTo(this),this.configs.draggable&&(this.draggable=new e.Draggable({target:this,handle:this.configs.toolbar?this.toolbar:this}))}return t.defaults={parent:".metaScore-editor",modal:!0,draggable:!0,autoShow:!1,toolbar:!1,title:""},e.Dom.extend(t),t.prototype.show=function(){return this.configs.modal&&this.mask.appendTo(this.configs.parent),this.appendTo(this.configs.parent),this},t.prototype.hide=function(){return this.configs.modal&&this.mask.remove(),this.remove(),this},t.prototype.getToolbar=function(){return this.toolbar},t.prototype.getContents=function(){return this.contents},t.prototype.onCloseClick=function(){this.hide()},t}(),e.namespace("editor").Panel=function(){function t(n){this.configs=this.getConfigs(n),t.parent.call(this,"<div/>",{"class":"panel"}),this.onComponentDragStart=e.Function.proxy(this.onComponentDragStart,this),this.onComponentDrag=e.Function.proxy(this.onComponentDrag,this),this.onComponentDragEnd=e.Function.proxy(this.onComponentDragEnd,this),this.onComponentResizeStart=e.Function.proxy(this.onComponentResizeStart,this),this.onComponentResize=e.Function.proxy(this.onComponentResize,this),this.onComponentResizeEnd=e.Function.proxy(this.onComponentResizeEnd,this),this.toolbar=new e.editor.panel.Toolbar(this.configs.toolbarConfigs).appendTo(this),this.toolbar.getTitle().addListener("click",e.Function.proxy(this.toggleState,this)),this.contents=new e.Dom("<div/>",{"class":"fields"}).appendTo(this),this.addDelegate(".field","valuechange",e.Function.proxy(this.onFieldValueChange,this)).unsetComponent()}return t.defaults={toolbarConfigs:{buttons:["previous","next"]}},e.Dom.extend(t),t.prototype.setupFields=function(t){var n,i;return this.fields={},this.contents.empty(),e.Object.each(t,function(t,o){o.editable!==!1&&(n=o.configs||{},i=new e.editor.field[o.type](n).data("name",t).appendTo(this.contents),this.fields[t]=i)},this),this},t.prototype.getToolbar=function(){return this.toolbar},t.prototype.getField=function(t){return void 0===t?this.fields:this.fields[t]},t.prototype.enableFields=function(){e.Object.each(this.fields,function(t,e){e.enable()},this)},t.prototype.showField=function(t){this.getField(t).show()},t.prototype.hideField=function(t){this.getField(t).hide()},t.prototype.toggleState=function(){this.toggleClass("collapsed")},t.prototype.disable=function(){this.addClass("disabled")},t.prototype.enable=function(){this.removeClass("disabled")},t.prototype.getComponent=function(){return this.component},t.prototype.getDraggable=function(){return!1},t.prototype.getResizable=function(){return!1},t.prototype.setComponent=function(t,n){return t!==this.getComponent()&&(this.unsetComponent(!0),this.component=t,this.setupFields(this.component.configs.properties).updateFieldValues(this.getValues(Object.keys(this.getField())),!0).updateDraggable().updateResizable().addClass("has-component").getToolbar().setComponent(t,!0),t instanceof e.player.component.Controller||this.getToolbar().toggleMenuItem("delete",!0),t.addClass("selected"),n!==!0&&this.triggerEvent("componentset",{component:t},!1)),this},t.prototype.unsetComponent=function(t){var e=this.getComponent();return this.removeClass("has-component").getToolbar().toggleMenuItem("delete",!1),e&&(this.updateDraggable(!1).updateResizable(!1).getToolbar().setComponent(null,!0),e.removeClass("selected"),delete this.component,t!==!0&&this.triggerEvent("componentunset",{component:e},!1)),this},t.prototype.updateDraggable=function(t){var n=this.getComponent();return void 0===t&&(t=this.getDraggable()),t?n._draggable||(n._draggable=new e.Draggable(t),n.addListener("dragstart",this.onComponentDragStart).addListener("drag",this.onComponentDrag).addListener("dragend",this.onComponentDragEnd)):n._draggable&&(n._draggable.destroy(),delete n._draggable,n.removeListener("dragstart",this.onComponentDragStart).removeListener("drag",this.onComponentDrag).removeListener("dragend",this.onComponentDragEnd)),this.toggleFields(["x","y"],t),this},t.prototype.updateResizable=function(t){var n=this.getComponent();return void 0===t&&(t=this.getResizable()),t?n._resizable||(n._resizable=new e.Resizable(t),n.addListener("resizestart",this.onComponentResizeStart).addListener("resize",this.onComponentResize).addListener("resizeend",this.onComponentResizeEnd)):n._resizable&&(n._resizable.destroy(),delete n._resizable,n.removeListener("resizestart",this.onComponentResizeStart).removeListener("resize",this.onComponentResize).removeListener("resizeend",this.onComponentResizeEnd)),this.toggleFields(["width","height"],t),this},t.prototype.onComponentDragStart=function(){var t=["x","y"];this._beforeDragValues=this.getValues(t)},t.prototype.onComponentDrag=function(){var t=["x","y"];this.updateFieldValues(t,!0)},t.prototype.onComponentDragEnd=function(){var t=this.getComponent(),e=["x","y"];this.updateFieldValues(e,!0),this.triggerEvent("valueschange",{component:t,old_values:this._beforeDragValues,new_values:this.getValues(e)},!1),delete this._beforeDragValues},t.prototype.onComponentResizeStart=function(){var t=["x","y","width","height"];this._beforeResizeValues=this.getValues(t)},t.prototype.onComponentResize=function(){var t=["x","y","width","height"];this.updateFieldValues(t,!0)},t.prototype.onComponentResizeEnd=function(){var t=this.getComponent(),e=["x","y","width","height"];this.updateFieldValues(e,!0),this.triggerEvent("valueschange",{component:t,old_values:this._beforeResizeValues,new_values:this.getValues(e)},!1),delete this._beforeResizeValues},t.prototype.onFieldValueChange=function(t){var e,n,i,o=this.getComponent();o&&(e=t.detail.field.data("name"),n=t.detail.value,i=this.getValues([e]),o.setProperty(e,n),this.triggerEvent("valueschange",{component:o,old_values:i,new_values:this.getValues([e])},!1))},t.prototype.updateFieldValue=function(t,e,n){this.getField(t).setValue(e,n)},t.prototype.updateFieldValues=function(t,n){return e.Var.is(t,"array")?e.Array.each(t,function(t,e){this.updateFieldValue(e,this.getValue(e),n)},this):e.Object.each(t,function(t,e){this.updateFieldValue(t,e,n)},this),this},t.prototype.updateProperties=function(t,n){return e.Object.each(n,function(e,n){this.getField(e).disabled||t.setProperty(e,n)},this),this.updateFieldValues(n,!0),this},t.prototype.toggleFields=function(t,n){var i;return e.Array.each(t,function(t,e){(i=this.getField(e))&&(n?i.enable():i.disable())},this),this},t.prototype.getValue=function(t){return this.getComponent().getProperty(t)},t.prototype.getValues=function(t){var n={};return t=t||Object.keys(this.getField()),e.Array.each(t,function(t,e){this.getField(e).disabled||(n[e]=this.getValue(e))},this),n},t}(),e.namespace("editor.field").Boolean=function(){function t(e){this.configs=this.getConfigs(e),t.parent.call(this,this.configs),this.addClass("booleanfield"),this.configs.checked&&this.input.attr("checked","checked")}return t.defaults={value:!1,checked_value:!0,unchecked_value:!1,checked:!1},e.editor.Field.extend(t),t.prototype.setupUI=function(){var t="field-"+e.String.uuid(5);this.configs.label&&(this.label=new e.Dom("<label/>",{"for":t,text:this.configs.label}).appendTo(this)),this.input_wrapper=new e.Dom("<div/>",{"class":"input-wrapper"}).appendTo(this),this.input=new e.Dom("<input/>",{type:"checkbox",id:t}).addListener("change",e.Function.proxy(this.onChange,this)).appendTo(this.input_wrapper)},t.prototype.onChange=function(){this.value=this.input.is(":checked")?this.configs.checked_value:this.configs.unchecked_value,this.triggerEvent("valuechange",{field:this,value:this.value},!0,!1)},t.prototype.setValue=function(t,e){this.input.attr("checked",t===this.configs.checked_value?"checked":null),e!==!0&&this.input.triggerEvent("change")},t}(),e.namespace("editor.field").BorderRadius=function(){function t(e){this.configs=this.getConfigs(e),t.parent.call(this,this.configs),this.addClass("borderradiusrfield")}return e.editor.Field.extend(t),t.prototype.setupUI=function(){t.parent.prototype.setupUI.call(this),this.input.attr("readonly","readonly").addListener("click",e.Function.proxy(this.onClick,this)),this.overlay=(new e.editor.overlay.BorderRadius).addListener("submit",e.Function.proxy(this.onOverlaySubmit,this)),this.clear=new e.Dom("<button/>",{text:".","data-action":"clear"}).addListener("click",e.Function.proxy(this.onClearClick,this)).appendTo(this.input_wrapper)
},t.prototype.setValue=function(e,n){t.parent.prototype.setValue.call(this,e,n),this.input.attr("title",e)},t.prototype.onClick=function(){this.disabled||this.overlay.setValue(this.value).show()},t.prototype.onOverlaySubmit=function(t){var e=t.detail.value;t.detail.overlay,this.setValue(e)},t.prototype.onClearClick=function(){this.setValue("0px")},t}(),e.namespace("editor.field").Buttons=function(){function t(n){this.configs=this.getConfigs(n),this.onClick=e.Function.proxy(this.onClick,this),t.parent.call(this,this.configs),this.addClass("buttonsfield")}return t.defaults={buttons:{}},e.editor.Field.extend(t),t.prototype.setValue=function(){},t.prototype.setupUI=function(){var t=this;this.configs.label&&(this.label=new e.Dom("<label/>",{text:this.configs.label}).appendTo(this)),this.input_wrapper=new e.Dom("<div/>",{"class":"input-wrapper"}).appendTo(this),e.Object.each(this.configs.buttons,function(n,i){new e.Dom("<button/>",i).addListener("click",function(){t.triggerEvent("valuechange",{field:t,value:n},!0,!1)}).appendTo(this.input_wrapper)},this)},t}(),e.namespace("editor.field").Color=function(){function t(e){this.configs=this.getConfigs(e),t.parent.call(this,this.configs),this.addClass("colorfield")}return t.defaults={value:{r:255,g:255,b:255,a:1}},e.editor.Field.extend(t),t.prototype.setupUI=function(){t.parent.prototype.setupUI.call(this),this.input.attr("readonly","readonly").addListener("click",e.Function.proxy(this.onClick,this)),this.clear=new e.Dom("<button/>",{text:".","data-action":"clear"}).addListener("click",e.Function.proxy(this.onClearClick,this)).appendTo(this.input_wrapper),this.overlay=(new e.editor.overlay.ColorSelector).addListener("select",e.Function.proxy(this.onColorSelect,this))},t.prototype.setValue=function(t,n){var i;this.value=e.Color.parse(t),i="rgba("+this.value.r+","+this.value.g+","+this.value.b+","+this.value.a+")",this.input.attr("title",i).css("background-color",i),n!==!0&&this.triggerEvent("valuechange",{field:this,value:this.value},!0,!1)},t.prototype.onClick=function(){this.disabled||this.overlay.setValue(e.Object.copy(this.value)).show()},t.prototype.onColorSelect=function(t){var e=t.detail.value;t.detail.overlay,this.setValue(e)},t.prototype.onClearClick=function(){this.setValue(null)},t}(),e.namespace("editor.field").Image=function(){function t(e){this.configs=this.getConfigs(e),t.parent.call(this,this.configs),this.addClass("imagefield")}return e.editor.Field.extend(t),t.prototype.setupUI=function(){t.parent.prototype.setupUI.call(this),this.input.attr("readonly","readonly").addListener("click",e.Function.proxy(this.onClick,this)),this.clear=new e.Dom("<button/>",{text:".","data-action":"clear"}).addListener("click",e.Function.proxy(this.onClearClick,this)).appendTo(this.input_wrapper)},t.prototype.setValue=function(e,n){t.parent.prototype.setValue.call(this,e,n),this.input.attr("title",e)},t.prototype.onClick=function(){this.disabled||Drupal.media.popups.mediaBrowser(e.Function.proxy(this.onFileSelect,this))},t.prototype.onClearClick=function(){this.setValue(null)},t.prototype.onFileSelect=function(t){t.length>0&&this.setValue(t[0].url+"?fid="+t[0].fid)},t}(),e.namespace("editor.field").Number=function(){function t(e){this.configs=this.getConfigs(e),t.parent.call(this,this.configs),this.addClass("numberfield")}return t.defaults={value:0,min:null,max:null},e.editor.Field.extend(t),t.prototype.setupUI=function(){var t="field-"+e.String.uuid(5);this.configs.label&&(this.label=new e.Dom("<label/>",{"for":t,text:this.configs.label}).appendTo(this)),this.input_wrapper=new e.Dom("<div/>",{"class":"input-wrapper"}).appendTo(this),this.input=new e.Dom("<input/>",{type:"number",id:t,min:this.configs.min,max:this.configs.max,step:this.configs.step}).addListener("change",e.Function.proxy(this.onChange,this)).appendTo(this.input_wrapper)},t}(),e.namespace("editor.field").Select=function(){function t(e){this.configs=this.getConfigs(e),t.parent.call(this,this.configs),this.addClass("selectfield")}return t.defaults={options:{}},e.editor.Field.extend(t),t.prototype.setupUI=function(){var t="field-"+e.String.uuid(5);this.configs.label&&(this.label=new e.Dom("<label/>",{"for":t,text:this.configs.label}).appendTo(this)),this.input_wrapper=new e.Dom("<div/>",{"class":"input-wrapper"}).appendTo(this),this.input=new e.Dom("<select/>",{id:t}).addListener("change",e.Function.proxy(this.onChange,this)).appendTo(this.input_wrapper),e.Object.each(this.configs.options,function(t,e){this.addOption(t,e)},this)},t.prototype.addOption=function(t,n){return this.input.append(new e.Dom("<option/>",{value:t,text:n})),this},t.prototype.removeOption=function(t){return this.input.child('[value="'+t+'"]').remove(),this},t}(),e.namespace("editor.field").Text=function(){function t(e){this.configs=this.getConfigs(e),t.parent.call(this,this.configs),this.addClass("textfield")}return t.defaults={value:""},e.editor.Field.extend(t),t}(),e.namespace("editor.field").Textarea=function(){function t(e){this.configs=this.getConfigs(e),t.parent.call(this,this.configs),this.addClass("textareafield")}return t.defaults={value:""},e.editor.Field.extend(t),t.prototype.setupUI=function(){var t="field-"+e.String.uuid(5);this.configs.label&&(this.label=new e.Dom("<label/>",{"for":t,text:this.configs.label}).appendTo(this)),this.input_wrapper=new e.Dom("<div/>",{"class":"input-wrapper"}).appendTo(this),this.input=new e.Dom("<textarea/>",{id:t}).addListener("change",e.Function.proxy(this.onChange,this)).appendTo(this.input_wrapper)},t}(),e.namespace("editor.field").Time=function(){function t(e){this.configs=this.getConfigs(e),t.parent.call(this,this.configs),this.addClass("timefield")}return t.defaults={value:0,min:0,max:null,checkbox:!1,inButton:!1,outButton:!1},e.editor.Field.extend(t),t.prototype.setupUI=function(){var t;this.configs.label&&(this.label=new e.Dom("<label/>",{text:this.configs.label}).appendTo(this)),this.input_wrapper=new e.Dom("<div/>",{"class":"input-wrapper"}).appendTo(this),this.configs.checkbox&&(this.checkbox=new e.Dom("<input/>",{type:"checkbox"}).addListener("change",e.Function.proxy(this.onInput,this)).appendTo(this.input_wrapper)),this.hours=new e.Dom("<input/>",{type:"number","class":"hours"}).addListener("input",e.Function.proxy(this.onInput,this)).appendTo(this.input_wrapper),new e.Dom("<span/>",{text:":","class":"separator"}).appendTo(this.input_wrapper),this.minutes=new e.Dom("<input/>",{type:"number","class":"minutes"}).addListener("input",e.Function.proxy(this.onInput,this)).appendTo(this.input_wrapper),new e.Dom("<span/>",{text:":","class":"separator"}).appendTo(this.input_wrapper),this.seconds=new e.Dom("<input/>",{type:"number","class":"seconds"}).addListener("input",e.Function.proxy(this.onInput,this)).appendTo(this.input_wrapper),new e.Dom("<span/>",{text:".","class":"separator"}).appendTo(this.input_wrapper),this.centiseconds=new e.Dom("<input/>",{type:"number","class":"centiseconds"}).addListener("input",e.Function.proxy(this.onInput,this)).appendTo(this.input_wrapper),(this.configs.inButton||this.configs.outButton)&&(t=new e.Dom("<div/>",{"class":"buttons"}).appendTo(this.input_wrapper),this.configs.inButton&&(this.in=new e.Dom("<button/>",{text:".","data-action":"in"}).addListener("click",e.Function.proxy(this.onInClick,this)).appendTo(t)),this.configs.outButton&&(this.out=new e.Dom("<button/>",{text:".","data-action":"out"}).addListener("click",e.Function.proxy(this.onOutClick,this)).appendTo(t))),this.addListener("change",e.Function.proxy(this.onChange,this))},t.prototype.onChange=function(){this.triggerEvent("valuechange",{field:this,value:this.value},!0,!1)},t.prototype.onInput=function(t){var e,n,i,o,s=this.isActive();s?(e=parseInt(this.centiseconds.val(),10),n=parseInt(this.seconds.val(),10),i=parseInt(this.minutes.val(),10),o=parseInt(this.hours.val(),10),this.setValue(10*e+1e3*n+6e4*i+36e5*o)):this.setValue(null),t.stopPropagation()},t.prototype.onInClick=function(){this.triggerEvent("valuein")},t.prototype.onOutClick=function(){this.triggerEvent("valueout")},t.prototype.setValue=function(t,e){var n,i,o,s;t=parseFloat(t),isNaN(t)?(this.value=null,this.centiseconds.val(0),this.seconds.val(0),this.minutes.val(0),this.hours.val(0),this.disabled||(this.hours.attr("disabled","disabled"),this.minutes.attr("disabled","disabled"),this.seconds.attr("disabled","disabled"),this.centiseconds.attr("disabled","disabled"),this.in&&this.in.attr("disabled","disabled"),this.out&&this.out.attr("disabled","disabled")),this.checkbox&&this.checkbox.attr("checked",null)):(this.value=t,null!==this.configs.min&&(this.value=Math.max(this.value,this.configs.min)),null!==this.configs.max&&(this.value=Math.min(this.value,this.configs.max)),n=parseInt(this.value/10%100,10),i=parseInt(this.value/1e3%60,10),o=parseInt(this.value/6e4%60,10),s=parseInt(this.value/36e5,10),this.disabled||(this.hours.attr("disabled",null),this.minutes.attr("disabled",null),this.seconds.attr("disabled",null),this.centiseconds.attr("disabled",null),this.in&&this.in.attr("disabled",null),this.out&&this.out.attr("disabled",null)),this.centiseconds.val(n),this.seconds.val(i),this.minutes.val(o),this.hours.val(s),this.checkbox&&this.checkbox.attr("checked","checked")),e!==!0&&this.triggerEvent("change")},t.prototype.isActive=function(){return!this.checkbox||this.checkbox.is(":checked")},t.prototype.disable=function(){return this.disabled=!0,this.checkbox&&this.checkbox.attr("disabled","disabled"),this.hours.attr("disabled","disabled"),this.minutes.attr("disabled","disabled"),this.seconds.attr("disabled","disabled"),this.centiseconds.attr("disabled","disabled"),this.in&&this.in.attr("disabled","disabled"),this.out&&this.out.attr("disabled","disabled"),this.addClass("disabled"),this},t.prototype.enable=function(){var t=this.isActive();return this.disabled=!1,this.checkbox&&this.checkbox.attr("disabled",null),this.hours.attr("disabled",t?null:"disabled"),this.minutes.attr("disabled",t?null:"disabled"),this.seconds.attr("disabled",t?null:"disabled"),this.centiseconds.attr("disabled",t?null:"disabled"),this.in&&this.in.attr("disabled",t?null:"disabled"),this.out&&this.out.attr("disabled",t?null:"disabled"),this.removeClass("disabled"),this},t}(),e.namespace("editor.panel").Block=function(){function t(e){t.parent.call(this,e)}return t.defaults={toolbarConfigs:e.Object.extend({},e.editor.Panel.defaults.toolbarConfigs,{title:e.Locale.t("editor.panel.Block.title","Block"),menuItems:{"new":e.Locale.t("editor.panel.Block.menuItems.new","Add a new block"),"delete":e.Locale.t("editor.panel.Block.menuItems.delete","Delete the active block")}})},e.editor.Panel.extend(t),t.prototype.getDraggable=function(){var t=this.getComponent();return t instanceof e.player.component.Controller?{target:t,handle:t.child(".timer"),container:t.parents(),limits:{top:0,left:0}}:t instanceof e.player.component.Media?{target:t,handle:t.child("video"),container:t.parents(),limits:{top:0,left:0}}:t instanceof e.player.component.Block?{target:t,handle:t.child(".pager"),container:t.parents(),limits:{top:0,left:0}}:!1},t.prototype.getResizable=function(){var t=this.getComponent();return t instanceof e.player.component.Controller?!1:{target:t,container:t.parents()}},t}(),e.namespace("editor.panel").Element=function(){function t(e){t.parent.call(this,e)}return t.defaults={toolbarConfigs:e.Object.extend({},e.editor.Panel.defaults.toolbarConfigs,{title:e.Locale.t("editor.panel.Element.title","Element"),menuItems:{Cursor:e.Locale.t("editor.panel.Element.menuItems.Cursor","Add a new cursor"),Image:e.Locale.t("editor.panel.Element.menuItems.Image","Add a new image"),Text:e.Locale.t("editor.panel.Element.menuItems.Text","Add a new text element"),"delete":e.Locale.t("editor.panel.Element.menuItems.delete","Delete the active element")}})},e.editor.Panel.extend(t),t.prototype.getDraggable=function(){var t=this.getComponent();return{target:t,handle:t,container:t.parents()}},t.prototype.getResizable=function(){var t=this.getComponent();return{target:t,container:t.parents()}},t}(),e.namespace("editor.panel").Page=function(){function t(e){t.parent.call(this,e)}return t.defaults={toolbarConfigs:e.Object.extend({},e.editor.Panel.defaults.toolbarConfigs,{title:e.Locale.t("editor.panel.Page.title","Page"),menuItems:{"new":e.Locale.t("editor.panel.Page.menuItems.new","Add a new page"),"delete":e.Locale.t("editor.panel.Page.menuItems.delete","Delete the active page")}})},e.editor.Panel.extend(t),t}(),e.namespace("editor.panel").Text=function(){function t(n){t.parent.call(this,n),this.onComponentContentsClick=e.Function.proxy(this.onComponentContentsClick,this),this.onComponentContentsDblClick=e.Function.proxy(this.onComponentContentsDblClick,this)}return t.defaults={toolbarConfigs:e.Object.extend({},e.editor.Panel.defaults.toolbarConfigs,{title:e.Locale.t("editor.panel.Text.title","Text"),buttons:[],selector:!1}),properties:{"fore-color":{type:"Color",configs:{label:e.Locale.t("editor.panel.Text.fore-color","Font color")},setter:function(t){var n=e.Color.parse(t);this.execCommand("foreColor","rgba("+n.r+","+n.g+","+n.b+","+n.a+")")}},"back-color":{type:"Color",configs:{label:e.Locale.t("editor.panel.Text.back-color","Background color")},setter:function(t){var n=e.Color.parse(t);this.execCommand("backColor","rgba("+n.r+","+n.g+","+n.b+","+n.a+")")}},font:{type:"Select",configs:{label:e.Locale.t("editor.panel.Text.font","Font"),options:{"Georgia, serif":"Georgia",'"Times New Roman", Times, serif':"Times New Roman","Arial, Helvetica, sans-serif":"Arial",'"Comic Sans MS", cursive, sans-serif':"Comic Sans MS","Impact, Charcoal, sans-serif":"Impact",'"Lucida Sans Unicode", "Lucida Grande", sans-serif':"Lucida Sans Unicode","Tahoma, Geneva, sans-serif":"Tahoma","Verdana, Geneva, sans-serif":"Verdana",'"Courier New", Courier, monospace':"Courier New",'"Lucida Console", Monaco, monospace':"Lucida Console"}},setter:function(t){this.execCommand("fontName",t)}},"font-style":{type:"Buttons",configs:{label:e.Locale.t("editor.panel.Text.font-style","Font style"),buttons:{bold:{"data-action":"bold",title:e.Locale.t("editor.panel.Text.font-style.bold","Bold")},italic:{"data-action":"italic",title:e.Locale.t("editor.panel.Text.font-style.italic","Italic")}}},setter:function(t){this.execCommand(t)}},"font-style2":{type:"Buttons",configs:{label:"&nbsp;",buttons:{strikeThrough:{"data-action":"strikethrough",title:e.Locale.t("editor.panel.Text.font-style.strikeThrough","Strikethrough")},underline:{"data-action":"underline",title:e.Locale.t("editor.panel.Text.font-style.underline","Underline")},subscript:{"data-action":"subscript",title:e.Locale.t("editor.panel.Text.font-style.subscript","Subscript")},superscript:{"data-action":"superscript",title:e.Locale.t("editor.panel.Text.font-style.superscript","Superscript")}}},setter:function(t){this.execCommand(t)}},link:{type:"Buttons",configs:{label:e.Locale.t("editor.panel.Text.link","Link"),buttons:{link:{"data-action":"link",title:e.Locale.t("editor.panel.Text.link.link","Add/Modify")},unlink:{"data-action":"unlink",title:e.Locale.t("editor.panel.Text.link.unlink","Remove")}}},setter:function(t){if("link"===t){var n=this.getSelectedElement();new e.editor.overlay.LinkEditor({link:n&&e.Dom.is(n,"a")?n:null,autoShow:!0}).addListener("submit",e.Function.proxy(this.onLinkOverlaySubmit,this))}else this.execCommand(t)}}}},e.editor.Panel.extend(t),t.prototype.onFieldValueChange=function(t){var e,n,i,o=this.getComponent();o&&(e=t.detail.field.data("name"),n=t.detail.value,i=this.getValues([e]),e in this.configs.properties&&"setter"in this.configs.properties[e]&&this.configs.properties[e].setter.call(this,n),this.triggerEvent("valueschange",{component:o,old_values:i,new_values:this.getValues([e])},!1))},t.prototype.setComponent=function(t,e){return t!==this.getComponent()&&(this.unsetComponent(!0),this.component=t,this.addClass("has-component"),t.contents.addListener("dblclick",this.onComponentContentsDblClick)),e!==!0&&this.triggerEvent("componentset",{component:t},!1),this},t.prototype.unsetComponent=function(t){var e=this.getComponent();return this.removeClass("has-component"),e&&(e.contents.attr("contenteditable","null").removeListener("dblclick",this.onComponentContentsDblClick).removeListener("click",this.onComponentContentsClick),this.component=null,t!==!0&&this.triggerEvent("componentunset",{component:e},!1)),this},t.prototype.onComponentContentsDblClick=function(){var t=this.getComponent();t._draggable&&t._draggable.disable(),t.contents.attr("contenteditable","true").removeListener("dblclick",this.onComponentContentsDblClick).addListener("click",this.onComponentContentsClick),this.execCommand("styleWithCSS",!0),this.setupFields(this.configs.properties),this.enable(),this.updateFieldValues(this.getValues(Object.keys(this.getField())),!0)},t.prototype.onComponentContentsClick=function(t){t.stopPropagation()},t.prototype.onLinkOverlaySubmit=function(t){var e=t.detail.url;this.execCommand("createLink",e)},t.prototype.getSelectedElement=function(){var t,e,n=this.getComponent(),i=n.contents.get(0),o=i.ownerDocument;return o.selection?(t=o.selection,e=t.createRange().parentElement()):(t=o.getSelection(),t.rangeCount>0&&(e=t.getRangeAt(0).startContainer.parentNode)),e},t.prototype.execCommand=function(t,e){var n=this.getComponent(),i=n.contents.get(0),o=i.ownerDocument;return i.focus(),o.execCommand(t,!1,e)},t}(),e.namespace("editor.panel").Toolbar=function(){function t(n){this.configs=this.getConfigs(n),t.parent.call(this,"<div/>",{"class":"toolbar clearfix"}),this.title=new e.Dom("<div/>",{"class":"title",text:this.configs.title}).appendTo(this),this.buttons=new e.Dom("<div/>",{"class":"buttons"}).appendTo(this),e.Array.each(this.configs.buttons,function(t,e){this.addButton(e)},this),this.configs.selector&&(this.selector=(new e.editor.field.Select).addClass("selector").addOption(null,"").appendTo(this)),e.Var.isEmpty(this.configs.menuItems)||(this.menu=new e.editor.DropDownMenu,e.Object.each(this.configs.menuItems,function(t,e){this.menu.addItem(t,e)},this),this.addButton("menu").append(this.menu))}return t.defaults={title:"",buttons:[],selector:!1,menuItems:{}},e.Dom.extend(t),t.prototype.getToggle=function(){return this.toggle},t.prototype.getTitle=function(){return this.title},t.prototype.getSelector=function(){return this.selector},t.prototype.getMenu=function(){return this.menu},t.prototype.addButton=function(t){var n=(new e.editor.Button).data("action",t).appendTo(this.buttons);return n},t.prototype.getButton=function(t){return this.buttons.children('[data-action="'+t+'"]')},t.prototype.addComponent=function(t){this.selector&&this.selector.addOption(t.getId(),t.getName())},t.prototype.setComponent=function(t,e){this.selector&&this.selector.setValue(t?t.getId():null,e)},t.prototype.toggleMenuItem=function(t,e){var n=this.getMenu();return n&&n.toggleItem(t,e),this},t}(),e.namespace("editor.overlay").Alert=function(){function t(n){this.configs=this.getConfigs(n),t.parent.call(this,this.configs),this.addClass("alert"),this.text=new e.Dom("<div/>",{"class":"text"}).appendTo(this.contents),this.configs.text&&this.setText(this.configs.text),this.buttons=new e.Dom("<div/>",{"class":"buttons"}).addDelegate("button","click",e.Function.proxy(this.onButtonClick,this)).appendTo(this.contents),this.configs.buttons&&e.Object.each(this.configs.buttons,function(t,e){this.addButton(t,e)},this)}return t.defaults={draggable:!1,text:"",buttons:[]},e.editor.Overlay.extend(t),t.prototype.setText=function(t){this.text.text(t)},t.prototype.addButton=function(t,n){var i=(new e.editor.Button).setLabel(n).data("action",t).appendTo(this.buttons);return i},t.prototype.onButtonClick=function(t){var n=new e.Dom(t.target).data("action");this.hide(),this.triggerEvent(n+"click",{alert:this},!1),t.stopPropagation()},t}(),e.namespace("editor.overlay").BorderRadius=function(){function t(e){this.configs=this.getConfigs(e),t.parent.call(this,this.configs),this.addClass("border-radius"),this.setupUI()}return t.defaults={toolbar:!0,title:e.Locale.t("editor.overlay.BorderRadius.title","Border Radius")},e.editor.Overlay.extend(t),t.prototype.setupUI=function(){var t=this.getContents();this.fields={},this.buttons={},this.preview=new e.Dom("<div/>",{"class":"preview"}).appendTo(t),this.fields.tlw=new e.editor.field.Number({min:0}).addClass("tlw").addListener("valuechange",e.Function.proxy(this.onValueChange,this)).appendTo(this.preview),this.fields.tlh=new e.editor.field.Number({min:0}).addListener("valuechange",e.Function.proxy(this.onValueChange,this)).addClass("tlh").appendTo(this.preview),this.fields.trw=new e.editor.field.Number({min:0}).addListener("valuechange",e.Function.proxy(this.onValueChange,this)).addClass("trw").appendTo(this.preview),this.fields.trh=new e.editor.field.Number({min:0}).addListener("valuechange",e.Function.proxy(this.onValueChange,this)).addClass("trh").appendTo(this.preview),this.fields.brw=new e.editor.field.Number({min:0}).addListener("valuechange",e.Function.proxy(this.onValueChange,this)).addClass("brw").appendTo(this.preview),this.fields.brh=new e.editor.field.Number({min:0}).addListener("valuechange",e.Function.proxy(this.onValueChange,this)).addClass("brh").appendTo(this.preview),this.fields.blw=new e.editor.field.Number({min:0}).addListener("valuechange",e.Function.proxy(this.onValueChange,this)).addClass("blw").appendTo(this.preview),this.fields.blh=new e.editor.field.Number({min:0}).addListener("valuechange",e.Function.proxy(this.onValueChange,this)).addClass("blh").appendTo(this.preview),this.buttons.apply=new e.editor.Button({label:"Apply"}).addClass("apply").addListener("click",e.Function.proxy(this.onApplyClick,this)).appendTo(t),this.buttons.cancel=new e.editor.Button({label:"Cancel"}).addClass("cancel").addListener("click",e.Function.proxy(this.onCancelClick,this)).appendTo(t)},t.prototype.onValueChange=function(){var t="";t+=this.fields.tlw.getValue()+"px ",t+=this.fields.trw.getValue()+"px ",t+=this.fields.brw.getValue()+"px ",t+=this.fields.blw.getValue()+"px ",t+="/ ",t+=this.fields.tlh.getValue()+"px ",t+=this.fields.trh.getValue()+"px ",t+=this.fields.brh.getValue()+"px ",t+=this.fields.blh.getValue()+"px",this.preview.css("border-radius",t)},t.prototype.setValue=function(t){var n,i={tlw:0,tlh:0,trw:0,trh:0,blw:0,blh:0,brw:0,brh:0};return this.preview.css("border-radius",t),(n=this.preview.css("border-top-left-radius",void 0,!0).match(/(\d*)px/g))&&(n.length>1?(i.tlw=n[0],i.tlh=n[1]):i.tlw=i.tlh=n[0]),(n=this.preview.css("border-top-right-radius",void 0,!0).match(/(\d*)px/g))&&(n.length>1?(i.trw=n[0],i.trh=n[1]):i.trw=i.trh=n[0]),(n=this.preview.css("border-bottom-left-radius",void 0,!0).match(/(\d*)px/g))&&(n.length>1?(i.blw=n[0],i.blh=n[1]):i.blw=i.blh=n[0]),(n=this.preview.css("border-bottom-right-radius",void 0,!0).match(/(\d*)px/g))&&(n.length>1?(i.brw=n[0],i.brh=n[1]):i.brw=i.brh=n[0]),e.Object.each(this.fields,function(t,e){e.setValue(parseInt(i[t],10),!0)}),this},t.prototype.getValue=function(){return this.preview.css("border-radius")},t.prototype.onApplyClick=function(){this.triggerEvent("submit",{overlay:this,value:this.getValue()},!0,!1),this.hide()},t.prototype.onCancelClick=t.prototype.onCloseClick,t}(),e.namespace("editor.overlay").ColorSelector=function(){function t(n){this.configs=this.getConfigs(n),t.parent.call(this,this.configs),this.addClass("color-selector"),this.onGradientMousemove=e.Function.proxy(this.onGradientMousemove,this),this.onAlphaMousemove=e.Function.proxy(this.onAlphaMousemove,this),this.setupUI()}return t.defaults={parent:".metaScore-editor",draggable:!1},e.editor.Overlay.extend(t),t.prototype.setupUI=function(){this.gradient=new e.Dom("<div/>",{"class":"gradient"}).appendTo(this.contents),this.gradient.canvas=new e.Dom("<canvas/>",{width:"255",height:"255"}).addListener("click",e.Function.proxy(this.onGradientClick,this)).addListener("mousedown",e.Function.proxy(this.onGradientMousedown,this)).addListener("mouseup",e.Function.proxy(this.onGradientMouseup,this)).appendTo(this.gradient),this.gradient.position=new e.Dom("<div/>",{"class":"position"}).appendTo(this.gradient),this.alpha=new e.Dom("<div/>",{"class":"alpha"}).appendTo(this.contents),this.alpha.canvas=new e.Dom("<canvas/>",{width:"20",height:"255"}).addListener("click",e.Function.proxy(this.onAlphaClick,this)).addListener("mousedown",e.Function.proxy(this.onAlphaMousedown,this)).addListener("mouseup",e.Function.proxy(this.onAlphaMouseup,this)).appendTo(this.alpha),this.alpha.position=new e.Dom("<div/>",{"class":"position"}).appendTo(this.alpha),this.controls=new e.Dom("<div/>",{"class":"controls"}).appendTo(this.contents),this.controls.r=new e.Dom("<input/>",{type:"number",min:"0",max:"255",name:"r"}).addListener("input",e.Function.proxy(this.onControlInput,this)),new e.Dom("<div/>",{"class":"control-wrapper"}).append(new e.Dom("<label/>",{text:"R","for":"r"})).append(this.controls.r).appendTo(this.controls),this.controls.g=new e.Dom("<input/>",{type:"number",min:"0",max:"255",name:"g"}).addListener("input",e.Function.proxy(this.onControlInput,this)),new e.Dom("<div/>",{"class":"control-wrapper"}).append(new e.Dom("<label/>",{text:"G","for":"g"})).append(this.controls.g).appendTo(this.controls),this.controls.b=new e.Dom("<input/>",{type:"number",min:"0",max:"255",name:"b"}).addListener("input",e.Function.proxy(this.onControlInput,this)),new e.Dom("<div/>",{"class":"control-wrapper"}).append(new e.Dom("<label/>",{text:"B","for":"b"})).append(this.controls.b).appendTo(this.controls),this.controls.a=new e.Dom("<input/>",{type:"number",min:"0",max:"1",step:"0.01",name:"a"}).addListener("input",e.Function.proxy(this.onControlInput,this)),new e.Dom("<div/>",{"class":"control-wrapper"}).append(new e.Dom("<label/>",{text:"A","for":"a"})).append(this.controls.a).appendTo(this.controls),this.controls.current=new e.Dom("<canvas/>"),new e.Dom("<div/>",{"class":"canvas-wrapper current"}).append(this.controls.current).appendTo(this.controls),this.controls.previous=new e.Dom("<canvas/>"),new e.Dom("<div/>",{"class":"canvas-wrapper previous"}).append(this.controls.previous).appendTo(this.controls),this.controls.cancel=new e.editor.Button({label:"Cancel"}).addClass("cancel").addListener("click",e.Function.proxy(this.onCancelClick,this)).appendTo(this.controls),this.controls.apply=new e.editor.Button({label:"Apply"}).addClass("apply").addListener("click",e.Function.proxy(this.onApplyClick,this)).appendTo(this.controls),this.fillGradient()},t.prototype.setValue=function(t){return this.previous_value=t,this.fillPrevious(),this.updateValue(t),this},t.prototype.updateValue=function(t,n,i,o){var s;this.value=this.value||{},e.Var.is(t,"object")||(t=e.Color.parse(t)),"r"in t&&(this.value.r=parseInt(t.r,10)),"g"in t&&(this.value.g=parseInt(t.g,10)),"b"in t&&(this.value.b=parseInt(t.b,10)),"a"in t&&(this.value.a=parseFloat(t.a)),n!==!1&&this.fillAlpha(),o!==!1&&(this.controls.r.val(this.value.r),this.controls.g.val(this.value.g),this.controls.b.val(this.value.b),this.controls.a.val(this.value.a)),i!==!1&&(s=e.Color.rgb2hsv(this.value),this.gradient.position.css("left",255*(1-s.h)+"px"),this.gradient.position.css("top",127.5*s.s+127.5*(1-s.v/255)+"px"),this.alpha.position.css("top",255*(1-this.value.a)+"px")),this.fillCurrent()},t.prototype.fillPrevious=function(){var t=this.controls.previous.get(0).getContext("2d");t.fillStyle="rgba("+this.previous_value.r+","+this.previous_value.g+","+this.previous_value.b+","+this.previous_value.a+")",t.clearRect(0,0,t.canvas.width,t.canvas.height),t.fillRect(0,0,t.canvas.width,t.canvas.height)},t.prototype.fillCurrent=function(){var t=this.controls.current.get(0).getContext("2d");t.fillStyle="rgba("+this.value.r+","+this.value.g+","+this.value.b+","+this.value.a+")",t.clearRect(0,0,t.canvas.width,t.canvas.height),t.fillRect(0,0,t.canvas.width,t.canvas.height)},t.prototype.fillGradient=function(){var t,e=this.gradient.canvas.get(0).getContext("2d");t=e.createLinearGradient(0,0,e.canvas.width,0),t.addColorStop(0,"rgb(255, 0, 0)"),t.addColorStop(.15,"rgb(255, 0, 255)"),t.addColorStop(.33,"rgb(0, 0, 255)"),t.addColorStop(.49,"rgb(0, 255, 255)"),t.addColorStop(.67,"rgb(0, 255, 0)"),t.addColorStop(.84,"rgb(255, 255, 0)"),t.addColorStop(1,"rgb(255, 0, 0)"),e.fillStyle=t,e.fillRect(0,0,e.canvas.width,e.canvas.height),t=e.createLinearGradient(0,0,0,e.canvas.height),t.addColorStop(0,"rgba(255, 255, 255, 1)"),t.addColorStop(.5,"rgba(255, 255, 255, 0)"),t.addColorStop(.5,"rgba(0, 0, 0, 0)"),t.addColorStop(1,"rgba(0, 0, 0, 1)"),e.fillStyle=t,e.fillRect(0,0,e.canvas.width,e.canvas.height)},t.prototype.fillAlpha=function(){var t,e=this.alpha.canvas.get(0).getContext("2d");t=e.createLinearGradient(0,0,0,e.canvas.height),t.addColorStop(0,"rgb("+this.value.r+","+this.value.g+","+this.value.b+")"),t.addColorStop(1,"transparent"),e.fillStyle=t,e.clearRect(0,0,e.canvas.width,e.canvas.height),e.fillRect(0,0,e.canvas.width,e.canvas.height)},t.prototype.onControlInput=function(){this.updateValue({r:this.controls.r.val(),g:this.controls.g.val(),b:this.controls.b.val(),a:this.controls.a.val()},!0,!0,!1)},t.prototype.onGradientMousedown=function(t){this.gradient.canvas.addListener("mousemove",this.onGradientMousemove),t.stopPropagation()},t.prototype.onGradientMouseup=function(t){this.gradient.canvas.removeListener("mousemove",this.onGradientMousemove),t.stopPropagation()},t.prototype.onGradientClick=function(t){var e=t.target.getBoundingClientRect(),n=t.pageX-e.left,i=t.pageY-e.top,o=this.gradient.canvas.get(0).getContext("2d"),s=o.getImageData(n,i,1,1),a=this.value;this.gradient.position.css("left",n+"px"),this.gradient.position.css("top",i+"px"),a.r=s.data[0],a.g=s.data[1],a.b=s.data[2],this.updateValue(a,!0,!1),t.stopPropagation()},t.prototype.onGradientMousemove=t.prototype.onGradientClick,t.prototype.onAlphaMousedown=function(t){this.alpha.canvas.addListener("mousemove",this.onAlphaMousemove),t.stopPropagation()},t.prototype.onAlphaMouseup=function(t){this.alpha.canvas.removeListener("mousemove",this.onAlphaMousemove),t.stopPropagation()},t.prototype.onAlphaClick=function(t){var e=t.target.getBoundingClientRect(),n=t.pageY-e.top,i=this.alpha.canvas.get(0).getContext("2d"),o=i.getImageData(0,n,1,1),s=this.value;this.alpha.position.css("top",n+"px"),s.a=Math.round(100*(o.data[3]/255))/100,this.updateValue(s,!1,!1),t.stopPropagation()},t.prototype.onAlphaMousemove=t.prototype.onAlphaClick,t.prototype.onApplyClick=function(){this.triggerEvent("select",{overlay:this,value:this.value},!0,!1),this.hide()},t.prototype.onCancelClick=function(){this.hide()},t}(),e.namespace("editor.overlay").GuideInfo=function(){function t(e){this.configs=this.getConfigs(e),t.parent.call(this,this.configs),this.addClass("guide-details"),this.setupUI()}return t.defaults={toolbar:!0,title:e.Locale.t("editor.overlay.GuideInfo.title","Guide Info")},e.editor.Overlay.extend(t),t.prototype.setupUI=function(){var t=this.getContents();this.fields={},this.buttons={},this.fields.title=new e.editor.field.Text({label:e.Locale.t("editor.overlay.GuideInfo.fields.title","Title")}).appendTo(t),this.fields.description=new e.editor.field.Textarea({label:e.Locale.t("editor.overlay.GuideInfo.fields.description","Description")}).appendTo(t),this.fields.css=new e.editor.field.Textarea({label:e.Locale.t("editor.overlay.GuideInfo.fields.css","CSS")}).appendTo(t),this.buttons.apply=new e.editor.Button({label:"Apply"}).addClass("apply").addListener("click",e.Function.proxy(this.onApplyClick,this)).appendTo(t),this.buttons.cancel=new e.editor.Button({label:"Cancel"}).addClass("cancel").addListener("click",e.Function.proxy(this.onCancelClick,this)).appendTo(t)},t.prototype.setValues=function(t){this.fields.title.setValue(t.title||null),this.fields.description.setValue(t.description||null),this.fields.css.setValue(t.css||null)},t.prototype.getValues=function(){return{title:this.fields.title.getValue(),description:this.fields.description.getValue(),css:this.fields.css.getValue()}},t.prototype.onApplyClick=function(){this.triggerEvent("submit",{overlay:this,values:this.getValues()},!0,!1),this.hide()
},t.prototype.onCancelClick=t.prototype.onCloseClick=function(){this.setValues(this.previousValues),this.hide()},t.prototype.show=function(){return this.previousValues=this.getValues(),t.parent.prototype.show.call(this)},t}(),e.namespace("editor.overlay").GuideSelector=function(){function t(e){this.configs=this.getConfigs(e),t.parent.call(this,this.configs),this.addClass("guide-selector")}return t.defaults={toolbar:!0,title:e.Locale.t("editor.overlay.GuideSelector.title","Select a guide"),emptyText:e.Locale.t("editor.overlay.GuideSelector.emptyText","No guides available"),url:null},e.editor.Overlay.extend(t),t.prototype.show=function(){this.loadmask=new e.editor.overlay.LoadMask({autoShow:!0}),e.Ajax.get(this.configs.url,{success:e.Function.proxy(this.onLoadSuccess,this),error:e.Function.proxy(this.onLoadError,this)})},t.prototype.onLoadSuccess=function(t){var n,i,o=this.getContents(),s=JSON.parse(t.response);n=new e.Dom("<table/>",{"class":"guides"}).appendTo(o),e.Var.isEmpty(s)?o.text(this.configs.emptyText):e.Object.each(s,function(t,o){i=new e.Dom("<tr/>",{"class":"guide guide-"+o.id}).addListener("click",e.Function.proxy(this.onGuideClick,this,[o])).appendTo(n),new e.Dom("<td/>",{"class":"thumbnail"}).append(new e.Dom("<img/>",{src:o.thumbnail})).appendTo(i),new e.Dom("<td/>",{"class":"details"}).append(new e.Dom("<h1/>",{"class":"title",text:o.title})).append(new e.Dom("<p/>",{"class":"description",text:o.description})).append(new e.Dom("<h2/>",{"class":"author",text:o.author.name})).appendTo(i)},this),this.loadmask.hide(),delete this.loadmask,this.configs.modal&&this.mask.appendTo(this.configs.parent),this.appendTo(this.configs.parent)},t.prototype.onLoadError=function(){},t.prototype.onGuideClick=function(t){this.triggerEvent("select",{overlay:this,guide:t},!0,!1),this.hide()},t}(),e.namespace("editor.overlay").LinkEditor=function(){function t(e){this.configs=this.getConfigs(e),t.parent.call(this,this.configs),this.addClass("link-editor"),this.setupUI(),this.toggleFields(),this.configs.link&&this.setValuesFromLink(this.configs.link)}return t.defaults={toolbar:!0,title:e.Locale.t("editor.overlay.LinkEditor.title","Link Editor"),link:null},e.editor.Overlay.extend(t),t.prototype.setupUI=function(){var t=this.getContents();this.fields={},this.buttons={},this.fields.type=new e.editor.field.Select({label:e.Locale.t("editor.overlay.LinkEditor.fields.type","Type"),options:{url:e.Locale.t("editor.overlay.LinkEditor.fields.type.url","URL"),page:e.Locale.t("editor.overlay.LinkEditor.fields.type.page","Page"),time:e.Locale.t("editor.overlay.LinkEditor.fields.type.time","Time")}}).addListener("valuechange",e.Function.proxy(this.onTypeChange,this)).appendTo(t),this.fields.url=new e.editor.field.Text({label:e.Locale.t("editor.overlay.LinkEditor.fields.url","URL")}).appendTo(t),this.fields.page=new e.editor.field.Number({label:e.Locale.t("editor.overlay.LinkEditor.fields.page","Page")}).appendTo(t),this.fields.inTime=new e.editor.field.Time({label:e.Locale.t("editor.overlay.LinkEditor.fields.in-time","Start time"),inButton:!0}).appendTo(t),this.fields.outTime=new e.editor.field.Time({label:e.Locale.t("editor.overlay.LinkEditor.fields.out-time","End time"),inButton:!0}).appendTo(t),this.fields.rIndex=new e.editor.field.Number({label:e.Locale.t("editor.overlay.LinkEditor.fields.r-index","Reading index")}).appendTo(t),this.buttons.apply=new e.editor.Button({label:"Apply"}).addClass("apply").addListener("click",e.Function.proxy(this.onApplyClick,this)).appendTo(t),this.buttons.cancel=new e.editor.Button({label:"Cancel"}).addClass("cancel").addListener("click",e.Function.proxy(this.onCancelClick,this)).appendTo(t)},t.prototype.setValuesFromLink=function(t){var e;(e=t.hash.match(/^#p=(\d+)/))?(this.fields.type.setValue("page"),this.fields.page.setValue(e[1])):(e=t.hash.match(/^#t=(\d+),(\d+)&r=(\d+)/))?(this.fields.type.setValue("time"),this.fields.inTime.setValue(e[1]),this.fields.outTime.setValue(e[2]),this.fields.rIndex.setValue(e[3])):(this.fields.type.setValue("url"),this.fields.url.setValue(t.href))},t.prototype.toggleFields=function(){var t=this.fields.type.getValue();switch(t){case"page":this.fields.url.hide(),this.fields.page.show(),this.fields.inTime.hide(),this.fields.outTime.hide(),this.fields.rIndex.hide();break;case"time":this.fields.url.hide(),this.fields.page.hide(),this.fields.inTime.show(),this.fields.outTime.show(),this.fields.rIndex.show();break;default:this.fields.url.show(),this.fields.page.hide(),this.fields.inTime.hide(),this.fields.outTime.hide(),this.fields.rIndex.hide()}},t.prototype.onTypeChange=function(){this.toggleFields()},t.prototype.onApplyClick=function(){var t,e=this.fields.type.getValue();switch(e){case"page":t="#p="+this.fields.page.getValue();break;case"time":t="#t="+this.fields.inTime.getValue()+","+this.fields.outTime.getValue(),t+="&r="+this.fields.rIndex.getValue();break;default:t=this.fields.url.getValue()}this.triggerEvent("submit",{overlay:this,url:t},!0,!1),this.hide()},t.prototype.onCancelClick=function(){this.hide()},t}(),e.namespace("editor.overlay").LoadMask=function(){function t(n){this.configs=this.getConfigs(n),t.parent.call(this,this.configs),this.addClass("loadmask"),this.text=new e.Dom("<div/>",{"class":"text",text:this.configs.text}).appendTo(this.contents)}return t.defaults={draggable:!1,text:e.Locale.t("editor.overlay.LoadMask.text","Loading...")},e.editor.Overlay.extend(t),t}(),e.namespace("editor.overlay").Toolbar=function(){function t(n){this.configs=this.getConfigs(n),t.parent.call(this,"<div/>",{"class":"toolbar clearfix"}),this.title=new e.Dom("<div/>",{"class":"title"}).appendTo(this),this.buttons=new e.Dom("<div/>",{"class":"buttons"}).appendTo(this),this.configs.title&&this.title.text(this.configs.title)}return t.defaults={title:null},e.Dom.extend(t),t.prototype.getTitle=function(){return this.title},t.prototype.addButton=function(t){var n=(new e.editor.Button).data("action",t).appendTo(this.buttons);return n},t.prototype.getButton=function(t){return this.buttons.children('[data-action="'+t+'"]')},t}()})(this);