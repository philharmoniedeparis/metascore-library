/*! metaScore - v0.0.1 - 2014-08-28 - Oussama Mubarak */
(function(t){"use strict";var e={version:"0.0.1"};(function(){function t(e){e.parent instanceof Function&&(t.apply(this,[e.parent]),this.super=i(this,n(this,this.constructor))),e.apply(this,arguments)}function i(t,e){for(var i in t)"super"!==i&&t[i]instanceof Function&&(e[i]=t[i].super||n(t,t[i]));return e}function n(t,e){var i=t.super;return e.super=function(){return t.super=i,e.apply(t,arguments)}}e.Base=function(){},e.Base.extend=function a(e){function n(){t!==arguments[0]&&(t.apply(this,[e]),i(this,this),this.initializer instanceof Function&&this.initializer.apply(this),this.constructor.apply(this,arguments))}return n.prototype=new this(t),n.prototype.constructor=n,n.toString=function(){return""+e},n.extend=function(t){return t.parent=e,a.apply(n,arguments)},n},e.Base=e.Base.extend(function(){this.constructor=function(){},this.initConfig=function(t){t=t||{},this.configs=this.defaults?e.Object.extend({},this.defaults,t):t}})})(),Element&&function(t){t.matches=t.matchesSelector=t.matchesSelector||t.webkitMatchesSelector||t.mozMatchesSelector||t.msMatchesSelector||t.oMatchesSelector||function(t){for(var e=(this.parentNode||this.document).querySelectorAll(t),i=-1;e[++i]&&e[i]!==this;);return!!e[i]}}(Element.prototype),e.Evented=e.Base.extend(function(){var t={};this.addListener=function(e,i){return t[e]===void 0&&(t[e]=[]),t[e].push(i),this},this.removeListener=function(e,i){if(t[e]instanceof Array)for(var n=t[e],a=0,s=n.length;s>a;a++)if(n[a]===i){n.splice(a,1);break}return this},this.triggerEvent=function(i,n,a,s){var o,r;return t[i]instanceof Array&&(o=t[i],r={target:this,type:i,detail:n,bubbles:a!==!1,cancelable:s!==!1},e.Object.each(o,function(t,e){e.call(this,r)},this)),this}}),e.Ajax=e.Base.extend(function(){}),e.Ajax.createXHR=function(){var t,e,i,n=["MSXML2.XMLHttp.5.0","MSXML2.XMLHttp.4.0","MSXML2.XMLHttp.3.0","MSXML2.XMLHttp","Microsoft.XMLHttp"];if("undefined"!=typeof XMLHttpRequest)return t=new XMLHttpRequest;if(window.ActiveXObject)for(e=0,i=n.length;i>e;e++)try{return t=new ActiveXObject(n[e])}catch(a){}throw Error("XMLHttp object could be created.")},e.Ajax.send=function(t,i){var n,a=e.Ajax.createXHR(),s=[],o={method:"GET",headers:[],async:!0,data:{},complete:null,success:null,error:null,scope:this};return i=e.Object.extend(function(){},o,i),e.Object.each(i.data,function(t,e){s.push(encodeURIComponent(t)+"="+encodeURIComponent(e))}),s.length>0&&("POST"===i.method?(n=s.join("&"),i.headers["Content-type"]="application/x-www-form-urlencoded"):t+="?"+s.join("&")),a.open(i.method,t,i.async),e.Object.each(i.headers,function(t,e){a.setRequestHeader(t,e)}),a.onreadystatechange=function(){4===a.readyState&&(e.Var.is(i.complete,"function")&&i.complete.call(i.scope,a),a.status>=200&&300>status||304===status?e.Var.is(i.success,"function")&&i.success.call(i.scope,a):e.Var.is(i.error,"function")&&i.error.call(i.scope,a))},a.send(n),a},e.Ajax.get=function(t,i){return e.Object.extend(i,{method:"GET"}),e.Ajax.send(t,i)},e.Ajax.post=function(t,i){return e.Object.extend(i,{method:"POST"}),e.Ajax.send(t,i)},e.Array=e.Base.extend(function(){}),e.Array.inArray=function(t,e){var i,n=0;if(e){if(e.indexOf)return e.indexOf(t);for(i=e.length;i>n;n++)if(n in e&&e[n]===t)return n}return-1},e.Array.copy=function(t){return[].concat(t)},e.Array.shuffle=function(t){var i=e.Array.copy(t);return i.sort(function(){return(0|3*Math.random())-1}),i},e.Array.unique=function(t){for(var e=[],i=t.length,n=0;i>n;n++){for(var a=n+1;i>a;a++)t[n]===t[a]&&(a=++n);e.push(t[n])}return e},e.Array.each=function(t,e,i){for(var n,a=0,s=t.length,o=void 0!==i;s>a&&(n=e.call(o?i:t[a],a,t[a]),n!==!1);a++);return t},e.Array.remove=function(t,i){for(var n=e.Array.inArray(i,t);n>-1;)t.splice(n,1),n=e.Array.inArray(i,t);return t},e.Dom=e.Base.extend(function(){this.constructor=function(){var t;this.elements=[],arguments.length>0&&((t=e.Dom.elementsFromString.apply(this,arguments))?(this.add(t),arguments.length>1&&this.attr(arguments[1])):(t=e.Dom.selectElements.apply(this,arguments))&&(this.add(t),arguments.length>2&&this.attr(arguments[2])))},this.add=function(t){if(t.hasOwnProperty("length"))for(var e=0;t.length>e;e++)this.elements.push(t[e]);else this.elements.push(t)},this.count=function(){return this.elements.length},this.get=function(t){return this.elements[t]},this.filter=function(t){var i=[];return e.Array.each(this.elements,function(n,a){e.Dom.is(a,t)&&i.push(a)},this),this.elements=i,this},this.index=function(t){var i=-1;return e.Array.each(this.elements,function(n,a){return e.Dom.is(a,t)?(i=n,!1):void 0},this),i},this.child=function(t){var i,n=new e.Dom;return e.Array.each(this.elements,function(a,s){return(i=e.Dom.selectElement.call(this,t,s))?(n.add(i),!1):void 0},this),n},this.children=function(t){var i=new e.Dom;return e.Array.each(this.elements,function(n,a){i.add(e.Dom.selectElements.call(this,t,a))},this),i},this.parents=function(t){var i=new e.Dom;return e.Array.each(this.elements,function(t,e){i.add(e.parentElement)},this),t&&i.filter(t),i},this.addClass=function(t){return e.Array.each(this.elements,function(i,n){e.Dom.addClass(n,t)},this),this},this.removeClass=function(t){return e.Array.each(this.elements,function(i,n){e.Dom.removeClass(n,t)},this),this},this.toggleClass=function(t,i){return e.Array.each(this.elements,function(n,a){e.Dom.toggleClass(a,t,i)},this),this},this.addListener=function(t,i,n){return e.Array.each(this.elements,function(a,s){e.Dom.addListener(s,t,i,n)},this),this},this.addDelegate=function(t,i,n,a,s){return a=a||this,this.addListener(i,function(i){e.Dom.is(i.target,t)&&n.call(a,i)},s)},this.removeListener=function(t,i,n){return e.Array.each(this.elements,function(a,s){e.Dom.removeListener(s,t,i,n)},this),this},this.triggerEvent=function(t,i,n,a){var s=!0;return e.Array.each(this.elements,function(o,r){s=e.Dom.triggerEvent(r,t,i,n,a)&&s},this),s},this.text=function(t){return void 0===t?e.Dom.text(this.get(0)):(e.Array.each(this.elements,function(i,n){e.Dom.text(n,t)},this),void 0)},this.val=function(t){return void 0!==t?(e.Array.each(this.elements,function(i,n){e.Dom.val(n,t)},this),this):e.Dom.val(this.get(0))},this.attr=function(t,i){return void 0!==i||e.Var.is(t,"object")?(e.Array.each(this.elements,function(n,a){e.Dom.attr(a,t,i)},this),this):e.Dom.attr(this.get(0),t)},this.css=function(t,i){return void 0!==i?(e.Array.each(this.elements,function(n,a){e.Dom.css(a,t,i)},this),this):e.Dom.css(this.get(0),t)},this.data=function(t,i){return void 0!==i?(e.Array.each(this.elements,function(n,a){e.Dom.data(a,t,i)},this),this):e.Dom.data(this.get(0),t)},this.append=function(t){return t instanceof e.Dom&&(t=t.elements),e.Dom.append(this.get(0),t),this},this.appendTo=function(t){return t instanceof e.Dom||(t=new e.Dom(t)),t=t.get(0),e.Array.each(this.elements,function(i,n){e.Dom.append(t,n)},this),this},this.empty=function(){return e.Array.each(this.elements,function(t,i){e.Dom.empty(i)},this),this},this.show=function(){return e.Array.each(this.elements,function(){this.css("display","initial")},this),this},this.hide=function(){return e.Array.each(this.elements,function(){this.css("display","none")},this),this},this.remove=function(){return this.triggerEvent("beforeremove")!==!1&&e.Array.each(this.elements,function(t,i){var n=i.parentElement;e.Dom.remove(i),e.Dom.triggerEvent(n,"childremoved",{child:i})},this),this},this.is=function(t){var i;return e.Array.each(this.elements,function(n,a){return i=e.Dom.is(a,t)},this),i}}),e.Dom.stringRe=/^<(.)+>$/,e.Dom.camelRe=/-([\da-z])/gi,e.Dom.camelReplaceFn=function(t,e){return e.toUpperCase()},e.Dom.camel=function(t){return t.replace(e.Dom.camelRe,e.Dom.camelReplaceFn)},e.Dom.bubbleEvents={click:!0,submit:!0,mousedown:!0,mousemove:!0,mouseup:!0,mouseover:!0,mouseout:!0,transitionend:!0},e.Dom.selectElement=function(t,i){var n;return i||(i=document),n=e.Var.is(t,"string")?i.querySelector(t):t.length?t[0]:t},e.Dom.selectElements=function(t,i){var n;return i||(i=document),n=e.Var.is(t,"string")?i.querySelectorAll(t):t.length?t:[t]},e.Dom.elementsFromString=function(t){var e,i,n,a={option:[1,"<select multiple='multiple'>","</select>"],optgroup:[1,"<select multiple='multiple'>","</select>"],legend:[1,"<fieldset>","</fieldset>"],area:[1,"<map>","</map>"],param:[1,"<object>","</object>"],thead:[1,"<table>","</table>"],tbody:[1,"<table>","</table>"],tfoot:[1,"<table>","</table>"],colgroup:[1,"<table>","</table>"],caption:[1,"<table>","</table>"],tr:[2,"<table><tbody>","</tbody></table>"],col:[2,"<table><tbody></tbody><colgroup>","</colgroup></table>"],th:[3,"<table><tbody><tr>","</tr></tbody></table>"],td:[3,"<table><tbody><tr>","</tr></tbody></table>"],_default:[1,"<div>","</div>"]},s=document.createElement("div"),o=/<\s*\w.*?>/g.exec(t);if(null!=o){for(e=o[0].replace(/</g,"").replace(/\/?>/g,""),i=a[e]||a._default,t=i[1]+t+i[2],s.innerHTML=t,n=i[0];n--;)s=s.lastChild;return s.childNodes}return null},e.Dom.hasClass=function(t,e){return t.classList.contains(e)},e.Dom.addClass=function(t,e){for(var i=e.split(" "),n=0,a=i.length;a>n;n++)t.classList.add(i[n])},e.Dom.removeClass=function(t,e){for(var i=e.split(" "),n=0,a=i.length;a>n;n++)t.classList.remove(i[n])},e.Dom.toggleClass=function(t,e,i){var n=e.split(" "),a=0,s=n.length;if(void 0===i)for(;s>a;a++)t.classList.toggle(n[a]);else for(;s>a;a++)t.classList.toggle(n[a],i)},e.Dom.addListener=function(t,i,n,a){return void 0===a&&(a=e.Dom.bubbleEvents.hasOwnProperty("type")?e.Dom.bubbleEvents[i]:!1),t.addEventListener(i,n,a)},e.Dom.removeListener=function(t,i,n,a){return void 0===a&&(a=e.Dom.bubbleEvents.hasOwnProperty("type")?e.Dom.bubbleEvents[i]:!1),t.removeEventListener(i,n,a)},e.Dom.triggerEvent=function(t,e,i,n,a){var s=new CustomEvent(e,{detail:i,bubbles:n!==!1,cancelable:a!==!1});return t.dispatchEvent(s)},e.Dom.text=function(t,e){return void 0!==e&&(t.innerHTML=e),t.innerHTML},e.Dom.val=function(t,e){return void 0!==e&&(t.value=e),t.value},e.Dom.attr=function(t,i,n){if(e.Var.is(i,"object"))e.Object.each(i,function(i,n){e.Dom.attr(t,i,n)},this);else switch(i){case"class":this.addClass(t,n);break;case"text":this.text(t,n);break;default:if(null!==n)return void 0!==n&&t.setAttribute(i,n),t.getAttribute(i);t.removeAttribute(i)}},e.Dom.css=function(t,e,i){var n,a;return n=this.camel(e),void 0!==i&&(t.style[n]=i),a=window.getComputedStyle(t),a.getPropertyValue(e)},e.Dom.data=function(t,e,i){return e=this.camel(e),null===i?delete t.dataset[e]:void 0!==i&&(t.dataset[e]=i),t.dataset[e]},e.Dom.append=function(t,i){e.Var.is(i,"array")||(i=[i]),e.Array.each(i,function(e,i){t.appendChild(i)},this)},e.Dom.empty=function(t){for(;t.firstChild;)t.removeChild(t.firstChild)},e.Dom.remove=function(t){t.parentElement.removeChild(t)},e.Dom.is=function(t,e){return t.matches(e)},e.Draggable=e.Base.extend(function(){var t,i,n,a;this.constructor=function(a,s,o){t=a,i=s,n=o||new e.Dom("body"),this.enable()},this.onMouseDown=function(e){a={left:parseInt(t.css("left"),10)-e.clientX,top:parseInt(t.css("top"),10)-e.clientY},n.addListener("mouseup",this.onMouseUp).addListener("mousemove",this.onMouseMove),t.addClass("dragging").triggerEvent("dragstart",null,!1,!0),e.stopPropagation()},this.onMouseMove=function(e){var i=e.clientX+a.left,n=e.clientY+a.top;t.css("left",i+"px").css("top",n+"px").triggerEvent("drag",null,!1,!0),e.stopPropagation()},this.onMouseUp=function(e){n.removeListener("mousemove",this.onMouseMove).removeListener("mouseup",this.onMouseUp),t.removeClass("dragging").triggerEvent("dragend",null,!1,!0),e.stopPropagation()},this.enable=function(){return t.addClass("draggable"),i.addListener("mousedown",this.onMouseDown),this},this.disable=function(){return t.removeClass("draggable"),i.removeListener("mousedown",this.onMouseDown),this},this.destroy=function(){return this.disable(),this}}),e.Function=e.Base.extend(function(){}),e.Function.proxy=function(t,i){return e.Var.type(t,"function")?function(){return t.apply(i||this,arguments)}:void 0},e.Function.emptyFn=function(){},e.Object=e.Base.extend(function(){}),e.Object.extend=function(){for(var t,e,i,n,a=arguments[0]||{},s=1,o=arguments.length;o>s;s++)if(null!=(t=arguments[s]))for(e in t)i=a[e],n=t[e],i!==n&&void 0!==n&&(a[e]=n);return a},e.Object.copy=function(t){return e.Object.extend({},t)},e.Object.each=function(t,e,i){var n,a,s=void 0!==i;for(n in t)if(t.hasOwnProperty(n)&&(a=e.call(s?i:t[n],n,t[n]),a===!1))break;return t},e.Resizable=e.Base.extend(function(){var t,i,n,a;this.constructor=function(a,s){t=a,i=s||new e.Dom("body"),n={},n.top=new e.Dom("<div/>",{"class":"resize-handle"}).data("direction","top").appendTo(t),n.right=new e.Dom("<div/>",{"class":"resize-handle"}).data("direction","right").appendTo(t),n.bottom=new e.Dom("<div/>",{"class":"resize-handle"}).data("direction","bottom").appendTo(t),n.left=new e.Dom("<div/>",{"class":"resize-handle"}).data("direction","left").appendTo(t),n.top_left=new e.Dom("<div/>",{"class":"resize-handle"}).data("direction","top-left").appendTo(t),n.top_right=new e.Dom("<div/>",{"class":"resize-handle"}).data("direction","top-right").appendTo(t),n.bottom_left=new e.Dom("<div/>",{"class":"resize-handle"}).data("direction","bottom-left").appendTo(t),n.bottom_right=new e.Dom("<div/>",{"class":"resize-handle"}).data("direction","bottom-right").appendTo(t),this.enable()},this.onMouseDown=function(e){a={handle:e.target,x:e.clientX,y:e.clientY,left:parseInt(t.css("left"),10),top:parseInt(t.css("top"),10),w:parseInt(t.css("width"),10),h:parseInt(t.css("height"),10)},i.addListener("mousemove",this.onMouseMove).addListener("mouseup",this.onMouseUp),t.addClass("resizing").triggerEvent("resizestart",null,!1,!0),e.stopPropagation()},this.onMouseMove=function(i){var n,s,o,r,l=new e.Dom(a.handle);switch(l.data("direction")){case"top":s=a.h-i.clientY+a.y,o=a.top+i.clientY-a.y;break;case"right":n=a.w+i.clientX-a.x;break;case"bottom":s=a.h+i.clientY-a.y;break;case"left":n=a.w-i.clientX+a.x,r=a.left+i.clientX-a.x;break;case"top-left":n=a.w-i.clientX+a.x,s=a.h-i.clientY+a.y,o=a.top+i.clientY-a.y,r=a.left+i.clientX-a.x;break;case"top-right":n=a.w+i.clientX-a.x,s=a.h-i.clientY+a.y,o=a.top+i.clientY-a.y;break;case"bottom-left":n=a.w-i.clientX+a.x,s=a.h+i.clientY-a.y,r=a.left+i.clientX-a.x;break;case"bottom-right":n=a.w+i.clientX-a.x,s=a.h+i.clientY-a.y}void 0!==o&&t.css("top",o+"px"),void 0!==r&&t.css("left",r+"px"),t.css("width",n+"px").css("height",s+"px").triggerEvent("resize",null,!1,!0),i.stopPropagation()},this.onMouseUp=function(e){i.removeListener("mousemove",this.onMouseMove).removeListener("mouseup",this.onMouseUp),t.removeClass("resizing").triggerEvent("resizeend",null,!1,!0),e.stopPropagation()},this.enable=function(){return e.Object.each(n,function(t,e){e.addListener("mousedown",this.onMouseDown)},this),t.addClass("resizable"),this},this.disable=function(){return e.Object.each(n,function(t,e){e.removeListener("mousedown",this.onMouseDown)},this),t.removeClass("resizable"),this},this.destroy=function(){return this.disable(),e.Object.each(n,function(t,e){e.remove()},this),this}}),e.String=e.Base.extend(function(){}),e.String.capitalize=function(t){return t.replace(/(?:^|\s)\S/g,function(t){return t.toUpperCase()})},e.String.t=function(t,i){return e.formatString(t,i)},e.formatString=function(t,i){return e.Object.each(i,function(e){t=t.replace(e,i[e])},this),t},e.String.uuid=function(t,e){var i,n=["0","1","2","3","4","5","6","7","8","9","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z"],a=[];if(e=e||n.length,t)for(i=0;t>i;i++)a[i]=n[0|Math.random()*e];else{var s;for(a[8]=a[13]=a[18]=a[23]="-",a[14]="4",i=0;36>i;i++)a[i]||(s=0|16*Math.random(),a[i]=n[19===i?8|3&s:s])}return a.join("")},e.Var=e.Base.extend(function(){}),e.Var.classes2types={"[object Boolean]":"boolean","[object Number]":"number","[object String]":"string","[object Function]":"function","[object Array]":"array","[object Date]":"date","[object RegExp]":"regexp","[object Object]":"object"},e.Var.type=function(t){return null==t?t+"":e.Var.classes2types[Object.prototype.toString.call(t)]||"object"},e.Var.is=function(t,i){return e.Var.type(t)===i.toLowerCase()},e.Editor=e.Dom.extend(function(){var t,i,n,a,s,o,r,l,d,c,h,u;this.constructor=function(p){this.super("<div/>",{"class":"metaScore-editor"}),this.initConfig(p),this.configs.container&&this.appendTo(this.configs.container),t=new e.Dom("<div/>",{"class":"workspace"}).appendTo(this),i=(new e.Editor.MainMenu).appendTo(this),n=new e.Dom("<div/>",{"class":"sidebar"}).appendTo(this),a=(new e.Editor.Panel.Block).appendTo(n),s=(new e.Editor.Panel.Page).appendTo(n),o=(new e.Editor.Panel.Element).appendTo(n),r=new e.Dom("<iframe/>",{"class":"player-wrapper"}).appendTo(t),l=new e.Dom(r.get(0).contentDocument.head),d=new e.Dom(r.get(0).contentDocument.body).addClass("metaScore-player-wrapper"),c=new e.Player,h=new e.Dom("<div/>",{"class":"grid"}).appendTo(t),u=new e.Editor.History,this.configs.palyer_css&&e.Array.each(this.configs.palyer_css,function(t,e){this.addPlayerCSS(e)},this),i.addDelegate("button[data-action]:not(.disabled)","click",this.onMainmenuClick,this),a.addListener("blockset",this.onBlockSet).addListener("blockunset",this.onBlockUnset).addListener("valueschange",this.onBlockPanelValueChange).getToolbar().addDelegate(".buttons [data-action]","click",this.onBlockPanelToolbarClick,this),s.addListener("pageset",this.onPageSet).addListener("pageunset",this.onPageUnset).getToolbar().addDelegate(".buttons [data-action]","click",this.onPagePanelToolbarClick,this),o.addListener("elementset",this.onElementSet).getToolbar().addDelegate(".buttons [data-action]","click",this.onElementPanelToolbarClick,this),d.addDelegate(".metaScore-block .element","elementclick",this.onElementClick,this).addDelegate(".metaScore-block .page","pageclick",this.onPageClick,this).addDelegate(".metaScore-block","blockclick",this.onBlockClick,this).addListener("click",this.onPlayerClick).addDelegate(".metaScore-block","pageactivated",this.onPageActivated,this).addListener("childremoved",this.onPlayerChildRemoved).addListener("keydown",this.onKeydown).addListener("keyup",this.onKeyup),u.addListener("add",this.onHistoryAdd).addListener("undo",this.onHistoryUndo).addListener("redo",this.onHistoryRedo),new e.Dom("body").addListener("keydown",this.onKeydown).addListener("keyup",this.onKeyup),a.unsetBlock()},this.addPlayerCSS=function(t){new e.Dom("<link/>",{rel:"stylesheet",type:"text/css",href:t}).appendTo(l)},this.addBlock=function(t){return t||(t=new e.Player.Block,this.addPage(t)),t.appendTo(d),a.setBlock(t),u.add({undo:e.Function.proxy(function(){this.removeBlock(t)},this),redo:e.Function.proxy(function(){this.addBlock(t)},this)}),t},this.removeBlock=function(t){t=t||a.getBlock(),t.remove()},this.addPage=function(t){var i;return t=t||a.getBlock(),i=new e.Player.Page,t.addPage(i),i},this.removePage=function(){var t;(t=s.getPage())&&t.remove()},this.addElement=function(t,i){var n;return i=i||s.getPage(),n=new e.Player.Element[t],i.addElement(n),o.setElement(n),n},this.removeElement=function(){var t;(t=o.getElement())&&t.remove()},this.openGuide=function(t){console.log(t),console.log(this)},this.onKeydown=function(t){switch(t.keyCode){case 18:d.addClass("alt-down");break;case 90:t.ctrlKey&&u.undo();break;case 89:t.ctrlKey&&u.redo()}},this.onKeyup=function(t){switch(t.keyCode){case 18:d.removeClass("alt-down")}},this.onMainmenuClick=function(t){switch(e.Dom.data(t.target,"action")){case"new":break;case"open":new e.Editor.Popup.GuideSelector({url:this.configs.api_url+"guide.json",selectCallback:this.openGuide}).show();break;case"save":break;case"download":break;case"delete":break;case"revert":break;case"undo":u.undo();break;case"redo":u.redo();break;case"edit":break;case"settings":break;case"help":}},this.onBlockSet=function(t){var e=t.detail.block;s.setPage(e.getActivePage(),!0),s.getMenu().enableItems('[data-action="new"]'),o.getMenu().enableItems('[data-action="new"]'),t.stopPropagation()},this.onBlockUnset=function(t){s.unsetPage(),s.getMenu().disableItems('[data-action="new"]'),t.stopPropagation()},this.onBlockPanelValueChange=function(t){var e=t.detail.block,i=t.detail.old_values,n=t.detail.new_values;u.add({undo:function(){a.updateBlockProperties(e,i)},redo:function(){a.updateBlockProperties(e,n)}})},this.onBlockPanelToolbarClick=function(t){switch(e.Dom.data(t.target,"action")){case"new":this.addBlock();break;case"delete":this.removeBlock()}t.stopPropagation()},this.onPageSet=function(t){var i=t.detail.page,n=new e.Player.Block(i.parents().parents().get(0));a.setBlock(n,!0),s.getMenu().enableItems('[data-action="new"]'),o.getMenu().enableItems('[data-action="new"]'),t.stopPropagation()},this.onPageUnset=function(t){o.unsetElement(),o.getMenu().disableItems('[data-action="new"]'),t.stopPropagation()},this.onPagePanelToolbarClick=function(t){switch(e.Dom.data(t.target,"action")){case"new":this.addPage();break;case"delete":this.removePage()}t.stopPropagation()},this.onElementSet=function(t){var i=t.detail.element,n=new e.Player.Page(i.parents().get(0)),o=new e.Player.Block(n.parents().parents().get(0));s.setPage(n,!0),a.setBlock(o,!0),t.stopPropagation()},this.onElementPanelToolbarClick=function(t){switch(e.Dom.data(t.target,"action")){case"new":this.addElement(e.Dom.data(t.target,"type"));break;case"delete":this.removePage()}t.stopPropagation()},this.onElementClick=function(t){o.setElement(t.detail.element),t.stopPropagation()},this.onPageClick=function(t){s.setPage(t.detail.page),o.unsetElement(),t.stopPropagation()},this.onBlockClick=function(t){a.setBlock(t.detail.block),t.stopPropagation()},this.onPlayerClick=function(t){a.unsetBlock(),t.stopPropagation()},this.onPageActivated=function(t){var e=t.detail.page;s.setPage(e)},this.onPlayerChildRemoved=function(t){var i,n=t.detail.child;e.Dom.is(n,".page")?(i=new e.Player.Block(t.target.parentElement),0===i.getPageCount()&&this.addPage(i),i.setActivePage(0)):e.Dom.is(n,".metaScore-block")&&(i=a.getBlock(),i&&n===i.get(0)&&a.unsetBlock())},this.onHistoryAdd=function(){i.enableItems('[data-action="undo"]'),i.disableItems('[data-action="redo"]')},this.onHistoryUndo=function(){u.hasUndo()?i.enableItems('[data-action="undo"]'):i.disableItems('[data-action="undo"]'),i.enableItems('[data-action="redo"]')},this.onHistoryRedo=function(){u.hasRedo()?i.enableItems('[data-action="redo"]'):i.disableItems('[data-action="redo"]'),i.enableItems('[data-action="undo"]')}}),e.Editor.Button=e.Dom.extend(function(){var t;this.disabled=!1,this.defaults={label:null},this.constructor=function(t){var e=this;this.super("<button/>"),this.initConfig(t),this.configs.label&&this.setLabel(this.configs.label),this.addListener("click",function(t){e.disabled&&t.stopPropagation()})},this.setLabel=function(i){void 0===t&&(t=new e.Dom("<span/>",{"class":"label"}).appendTo(this)),t.text(i)},this.disable=function(){return this.disabled=!0,this.addClass("disabled"),this},this.enable=function(){return this.disabled=!1,this.removeClass("disabled"),this}}),e.Editor.DropDownMenu=e.Dom.extend(function(){this.constructor=function(t){this.super("<ul/>",{"class":"dropdown-menu"}),this.initConfig(t)},this.addItem=function(t){var i=new e.Dom("<li/>",t).appendTo(this);return i},this.enableItems=function(t){var e=this.children(t);return e.removeListener("click",this.preventClick).removeClass("disabled"),e},this.disableItems=function(t){var e=this.children(t);return e.addListener("click",this.preventClick).addClass("disabled"),e},this.preventClick=function(t){t.stopPropagation()}}),e.Editor.Field=e.Dom.extend(function(){this.defaults={value:null,disabled:!1},this.tag="<input/>",this.attributes={type:"text","class":"field"},this.constructor=function(t){this.super(this.tag,this.attributes),this.initConfig(t),null!==this.configs.value&&this.setValue(this.configs.value),this.configs.disabled&&this.disable(),this.addListener("change",this.onChange)},this.onChange=function(){this.value=this.val(),this.triggerEvent("valuechange",{field:this,value:this.value},!0,!1)},this.setValue=function(t){this.val(t)},this.disable=function(){return this.disabled=!0,this.addClass("disabled"),this.attr("disabled","disabled"),this},this.enable=function(){return this.disabled=!1,this.removeClass("disabled"),this.attr("disabled",null),this}}),e.Editor.History=e.Evented.extend(function(){var t=[],e=-1,i=!1;this.defaults={max_commands:30},this.constructor=function(t){this.initConfig(t)},this.execute=function(t,e){return t&&t.hasOwnProperty(e)&&(i=!0,t[e](t),i=!1),this},this.add=function(n){return i?this:(t.splice(e+1,t.length-e),t.push(n),t.length>this.configs.max_commands&&(t=t.slice(-1*this.configs.max_commands)),e=t.length-1,this.triggerEvent("add",{command:n}),this)},this.undo=function(){var i=t[e];return i?(this.execute(i,"undo"),e-=1,this.triggerEvent("undo",{command:i}),this):this},this.redo=function(){var i=t[e+1];return i?(this.execute(i,"redo"),e+=1,this.triggerEvent("redo",{command:i}),this):this},this.clear=function(){var i=t.length;t=[],e=-1,i>0&&this.triggerEvent("clear")},this.hasUndo=function(){return-1!==e},this.hasRedo=function(){return t.length-1>e}}),e.Editor.MainMenu=e.Dom.extend(function(){this.constructor=function(){this.super("<div/>",{"class":"main-menu clearfix"}),this.setupUI()},this.setupUI=function(){var t,i;t=new e.Dom("<div/>",{"class":"left"}).appendTo(this),i=new e.Dom("<div/>",{"class":"right"}).appendTo(this),(new e.Editor.Button).attr({title:e.String.t("New")}).data("action","new").appendTo(t),(new e.Editor.Button).attr({title:e.String.t("Open")}).data("action","open").appendTo(t),(new e.Editor.Button).attr({title:e.String.t("edit")}).data("action","edit").appendTo(t),(new e.Editor.Button).attr({title:e.String.t("save")}).data("action","save").appendTo(t),(new e.Editor.Button).attr({title:e.String.t("download")}).data("action","download").appendTo(t),(new e.Editor.Button).attr({title:e.String.t("delete")}).data("action","delete").appendTo(t),(new e.Editor.Field.TimeField).attr({title:e.String.t("time")}).data("action","time").appendTo(t),(new e.Editor.Button).attr({title:e.String.t("revert")}).data("action","revert").appendTo(t),(new e.Editor.Button).attr({title:e.String.t("undo")}).data("action","undo").appendTo(t),(new e.Editor.Button).attr({title:e.String.t("redo")}).data("action","redo").appendTo(t),(new e.Editor.Button).attr({title:e.String.t("settings")}).data("action","settings").appendTo(i),(new e.Editor.Button).attr({title:e.String.t("help")}).data("action","help").appendTo(i)},this.enableItems=function(t){var e=this.children(t);return e.removeClass("disabled"),e},this.disableItems=function(t){var e=this.children(t);return e.addClass("disabled"),e}}),e.Editor.Overlay=e.Dom.extend(function(){var t;this.defaults={parent:".metaScore-editor",modal:!0,draggable:!0},this.constructor=function(i){this.super("<div/>",{"class":"overlay clearfix"}),this.initConfig(i),this.configs.modal&&(this.mask=new e.Dom("<div/>",{"class":"overlay-mask"})),this.configs.draggable&&(t=new e.Draggable(this,this))},this.show=function(){this.configs.modal&&this.mask.appendTo(this.configs.parent),this.appendTo(this.configs.parent)},this.hide=function(){this.configs.modal&&this.mask.remove(),this.remove()}}),e.Editor.Panel=e.Dom.extend(function(){var t,i,n={};this.defaults={title:"",fields:{}},this.constructor=function(n){this.super("<div/>",{"class":"panel"}),this.initConfig(n),t=new e.Editor.Toolbar({title:this.configs.title}).appendTo(this),t.getTitle().addListener("click",this.toggleState),i=new e.Dom("<table/>",{"class":"fields"}).appendTo(this),this.setupFields()},this.setupFields=function(){var t,a,s,o;e.Object.each(this.configs.fields,function(r,l){t=new e.Dom("<tr/>",{"class":"field-wrapper "+r}).appendTo(i),a="field-"+e.String.uuid(5),s=l.configs||{},n[r]=o=new l.type(s).attr("id",a),o.data("name",r),new e.Dom("<td/>").appendTo(t).append(new e.Dom("<label/>",{text:l.label,"for":a})),new e.Dom("<td/>").appendTo(t).append(o)},this)},this.getToolbar=function(){return t},this.getField=function(t){return void 0===t?n:n[t]},this.enableFields=function(){e.Object.each(n,function(t,e){e.enable()},this)},this.disableFields=function(){e.Object.each(n,function(t,e){e.disable()},this)},this.showFields=function(t){t?i.children("tr.field-wrapper."+t.join(", tr.field-wrapper.")).show():i.children("tr.field-wrapper").show()},this.hideFields=function(t){t?i.children("tr.field-wrapper."+t.join(", tr.field-wrapper.")).hide():i.children("tr.field-wrapper").hide()},this.toggleState=function(){this.toggleClass("collapsed")}}),e.Editor.Popup=e.Editor.Overlay.extend(function(){var t,i;this.defaults={title:"",parent:".metaScore-editor",modal:!0,draggable:!1},this.constructor=function(n){this.super(n),this.addClass("popup"),t=new e.Editor.Toolbar({title:this.configs.title}).appendTo(this),t.addButton().data("action","close").addListener("click",this.onCloseClick),i=new e.Dom("<div/>",{"class":"contents"}).appendTo(this)},this.getToolbar=function(){return t},this.getContents=function(){return i},this.onCloseClick=function(){this.hide()}}),e.Editor.Toolbar=e.Dom.extend(function(){var t,i;this.defaults={title:null},this.constructor=function(n){this.super("<div/>",{"class":"toolbar clearfix"}),this.initConfig(n),t=new e.Dom("<div/>",{"class":"title"}).appendTo(this),i=new e.Dom("<div/>",{"class":"buttons"}).appendTo(this),this.configs.title&&t.text(this.configs.title)},this.getTitle=function(){return t},this.addButton=function(t){return new e.Editor.Button(t).appendTo(i)}}),e.Editor.Field.BooleanField=e.Editor.Field.extend(function(){this.defaults={value:!0,unchecked_value:!1,checked:!1,disabled:!1},this.attributes={type:"checkbox","class":"field booleanfield"},this.constructor=function(t){this.super(t),this.configs.checked&&this.attr("checked","checked")},this.onChange=function(){this.value=this.is(":checked")?this.val():this.configs.unchecked_value,this.triggerEvent("valuechange",{field:this,value:this.value},!0,!1)},this.setChecked=function(t){this.attr("checked",t?"checked":"")}}),e.Editor.Field.TimeField=e.Editor.Field.extend(function(){var t,i,n,a;this.defaults={value:0,disabled:!1,min:0,max:null},this.tag="<div/>",this.attributes={"class":"field timefield"},this.constructor=function(s){t=new e.Dom("<input/>",{type:"number","class":"hours"}),i=new e.Dom("<input/>",{type:"number","class":"minutes"}),n=new e.Dom("<input/>",{type:"number","class":"seconds"}),a=new e.Dom("<input/>",{type:"number","class":"centiseconds"}),this.super(s),t.addListener("input",this.onInput).appendTo(this),new e.Dom("<span/>",{text:":","class":"separator"}).appendTo(this),i.addListener("input",this.onInput).appendTo(this),new e.Dom("<span/>",{text:":","class":"separator"}).appendTo(this),n.addListener("input",this.onInput).appendTo(this),new e.Dom("<span/>",{text:".","class":"separator"}).appendTo(this),a.addListener("input",this.onInput).appendTo(this)},this.onInput=function(e){var s=parseInt(a.val(),10),o=parseInt(n.val(),10),r=parseInt(i.val(),10),l=parseInt(t.val(),10);e.stopPropagation(),this.setValue(10*s+1e3*o+6e4*r+36e5*l)},this.setValue=function(e){var s,o,r,l;this.value=e,null!==this.configs.min&&(this.value=Math.max(this.value,this.configs.min)),null!==this.configs.max&&(this.value=Math.min(this.value,this.configs.max)),s=parseInt(this.value/10%100,10),o=parseInt(this.value/1e3%60,10),r=parseInt(this.value/6e4%60,10),l=parseInt(this.value/36e5,10),a.val(s),n.val(o),i.val(r),t.val(l),this.triggerEvent("valuechange",{field:this,value:this.value},!0,!1)},this.getValue=function(){return this.value},this.disable=function(){return this.disabled=!0,t.attr("disabled","disabled"),i.attr("disabled","disabled"),n.attr("disabled","disabled"),a.attr("disabled","disabled"),this.addClass("disabled"),this},this.enable=function(){return this.disabled=!1,t.attr("disabled",null),i.attr("disabled",null),n.attr("disabled",null),a.attr("disabled",null),this.removeClass("disabled"),this
}}),e.Editor.Field.ColorField=e.Editor.Field.extend(function(){var t,i,n;this.defaults={value:{r:255,g:255,b:255,a:1},disabled:!1},this.tag="<div/>",this.attributes={"class":"field colorfield"},this.constructor=function(n){t=(new e.Editor.Button).addListener("click",this.onClick),i=(new e.Editor.Overlay).addClass("colorfield-overlay"),i.gradient=new e.Dom("<div/>",{"class":"gradient"}).appendTo(i),i.gradient.canvas=new e.Dom("<canvas/>",{width:"255",height:"255"}).addListener("click",this.onGradientClick).addListener("mousedown",this.onGradientMousedown).addListener("mouseup",this.onGradientMouseup).appendTo(i.gradient),i.gradient.position=new e.Dom("<div/>",{"class":"position"}).appendTo(i.gradient),i.alpha=new e.Dom("<div/>",{"class":"alpha"}).appendTo(i),i.alpha.canvas=new e.Dom("<canvas/>",{width:"20",height:"255"}).addListener("click",this.onAlphaClick).addListener("mousedown",this.onAlphaMousedown).addListener("mouseup",this.onAlphaMouseup).appendTo(i.alpha),i.alpha.position=new e.Dom("<div/>",{"class":"position"}).appendTo(i.alpha),i.controls=new e.Dom("<div/>",{"class":"controls"}).appendTo(i),i.controls.r=new e.Dom("<input/>",{type:"number",min:"0",max:"255",name:"r"}).addListener("input",this.onControlInput),new e.Dom("<div/>",{"class":"control-wrapper"}).append(new e.Dom("<label/>",{text:"R","for":"r"})).append(i.controls.r).appendTo(i.controls),i.controls.g=new e.Dom("<input/>",{type:"number",min:"0",max:"255",name:"g"}).addListener("input",this.onControlInput),new e.Dom("<div/>",{"class":"control-wrapper"}).append(new e.Dom("<label/>",{text:"G","for":"g"})).append(i.controls.g).appendTo(i.controls),i.controls.b=new e.Dom("<input/>",{type:"number",min:"0",max:"255",name:"b"}).addListener("input",this.onControlInput),new e.Dom("<div/>",{"class":"control-wrapper"}).append(new e.Dom("<label/>",{text:"B","for":"b"})).append(i.controls.b).appendTo(i.controls),i.controls.a=new e.Dom("<input/>",{type:"number",min:"0",max:"1",step:"0.01",name:"a"}).addListener("input",this.onControlInput),new e.Dom("<div/>",{"class":"control-wrapper"}).append(new e.Dom("<label/>",{text:"A","for":"a"})).append(i.controls.a).appendTo(i.controls),i.controls.current=new e.Dom("<canvas/>"),new e.Dom("<div/>",{"class":"canvas-wrapper current"}).append(i.controls.current).appendTo(i.controls),i.controls.previous=new e.Dom("<canvas/>"),new e.Dom("<div/>",{"class":"canvas-wrapper previous"}).append(i.controls.previous).appendTo(i.controls),i.controls.cancel=new e.Editor.Button({label:"Cancel"}).addClass("cancel").addListener("click",this.onCancelClick).appendTo(i.controls),i.controls.apply=new e.Editor.Button({label:"Apply"}).addClass("apply").addListener("click",this.onApplyClick).appendTo(i.controls),i.mask.addListener("click",this.onApplyClick),this.super(n),new e.Dom("<div/>",{"class":"icon"}).appendTo(this),t.appendTo(this),this.fillGradient()},this.setValue=function(n,a,s,o){var r;this.value=this.value||{},e.Var.is(n,"object")||(n=this.parseColor(n)),n.hasOwnProperty("r")&&(this.value.r=parseInt(n.r,10)),n.hasOwnProperty("g")&&(this.value.g=parseInt(n.g,10)),n.hasOwnProperty("b")&&(this.value.b=parseInt(n.b,10)),n.hasOwnProperty("a")&&(this.value.a=parseFloat(n.a)),a!==!1&&this.fillAlpha(),o!==!1&&(i.controls.r.val(this.value.r),i.controls.g.val(this.value.g),i.controls.b.val(this.value.b),i.controls.a.val(this.value.a)),s!==!1&&(r=this.rgb2hsv(this.value),i.gradient.position.css("left",255*(1-r.h)+"px"),i.gradient.position.css("top",127.5*r.s+127.5*(1-r.v/255)+"px"),i.alpha.position.css("top",255*(1-this.value.a)+"px")),this.fillCurrent(),t.css("background-color","rgba("+this.value.r+","+this.value.g+","+this.value.b+","+this.value.a+")")},this.onClick=function(){this.disabled||(n=e.Object.copy(this.value),this.fillPrevious(),i.show())},this.onControlInput=function(){this.setValue({r:i.controls.r.val(),g:i.controls.g.val(),b:i.controls.b.val(),a:i.controls.a.val()},!0,!0,!1)},this.onCancelClick=function(t){this.setValue(n),i.hide(),t.stopPropagation()},this.onApplyClick=function(t){i.hide(),this.triggerEvent("valuechange",{field:this,value:this.value},!0,!1),t.stopPropagation()},this.fillPrevious=function(){var t=i.controls.previous.get(0).getContext("2d");t.fillStyle="rgba("+n.r+","+n.g+","+n.b+","+n.a+")",t.clearRect(0,0,t.canvas.width,t.canvas.height),t.fillRect(0,0,t.canvas.width,t.canvas.height)},this.fillCurrent=function(){var t=i.controls.current.get(0).getContext("2d");t.fillStyle="rgba("+this.value.r+","+this.value.g+","+this.value.b+","+this.value.a+")",t.clearRect(0,0,t.canvas.width,t.canvas.height),t.fillRect(0,0,t.canvas.width,t.canvas.height)},this.fillGradient=function(){var t,e=i.gradient.canvas.get(0).getContext("2d");t=e.createLinearGradient(0,0,e.canvas.width,0),t.addColorStop(0,"rgb(255, 0, 0)"),t.addColorStop(.15,"rgb(255, 0, 255)"),t.addColorStop(.33,"rgb(0, 0, 255)"),t.addColorStop(.49,"rgb(0, 255, 255)"),t.addColorStop(.67,"rgb(0, 255, 0)"),t.addColorStop(.84,"rgb(255, 255, 0)"),t.addColorStop(1,"rgb(255, 0, 0)"),e.fillStyle=t,e.fillRect(0,0,e.canvas.width,e.canvas.height),t=e.createLinearGradient(0,0,0,e.canvas.height),t.addColorStop(0,"rgba(255, 255, 255, 1)"),t.addColorStop(.5,"rgba(255, 255, 255, 0)"),t.addColorStop(.5,"rgba(0, 0, 0, 0)"),t.addColorStop(1,"rgba(0, 0, 0, 1)"),e.fillStyle=t,e.fillRect(0,0,e.canvas.width,e.canvas.height)},this.fillAlpha=function(){var t,e=i.alpha.canvas.get(0).getContext("2d");t=e.createLinearGradient(0,0,0,e.canvas.height),t.addColorStop(0,"rgb("+this.value.r+","+this.value.g+","+this.value.b+")"),t.addColorStop(1,"transparent"),e.fillStyle=t,e.clearRect(0,0,e.canvas.width,e.canvas.height),e.fillRect(0,0,e.canvas.width,e.canvas.height)},this.onGradientMousedown=function(t){i.gradient.canvas.addListener("mousemove",this.onGradientMousemove),t.stopPropagation()},this.onGradientMouseup=function(t){i.gradient.canvas.removeListener("mousemove",this.onGradientMousemove),t.stopPropagation()},this.onGradientClick=this.onGradientMousemove=function(t){var e=t.target.getBoundingClientRect(),n=t.pageX-e.left,a=t.pageY-e.top,s=i.gradient.canvas.get(0).getContext("2d"),o=s.getImageData(n,a,1,1),r=this.value;i.gradient.position.css("left",n+"px"),i.gradient.position.css("top",a+"px"),r.r=o.data[0],r.g=o.data[1],r.b=o.data[2],this.setValue(r,!0,!1),t.stopPropagation()},this.onAlphaMousedown=function(t){i.alpha.canvas.addListener("mousemove",this.onAlphaMousemove),t.stopPropagation()},this.onAlphaMouseup=function(t){i.alpha.canvas.removeListener("mousemove",this.onAlphaMousemove),t.stopPropagation()},this.onAlphaClick=this.onAlphaMousemove=function(t){var e=t.target.getBoundingClientRect(),n=t.pageY-e.top,a=i.alpha.canvas.get(0).getContext("2d"),s=a.getImageData(0,n,1,1),o=this.value;i.alpha.position.css("top",n+"px"),o.a=Math.round(100*(s.data[3]/255))/100,this.setValue(o,!1,!1),t.stopPropagation()},this.rgb2hsv=function(t){var e,i,n,a=t.r,s=t.g,o=t.b,r=Math.max(a,s,o),l=Math.min(a,s,o),d=r-l;if(i=0===r?0:d/r,n=r,r===l)e=0;else{switch(r){case a:e=(s-o)/d+(o>s?6:0);break;case s:e=(o-a)/d+2;break;case o:e=(a-s)/d+4}e/=6}return{h:e,s:i,v:n}},this.parseColor=function(t){var e,i={};return t=t.replace(/\s\s*/g,""),(e=/^#([\da-fA-F]{2})([\da-fA-F]{2})([\da-fA-F]{2})/.exec(t))?(i.r=parseInt(e[1],16),i.g=parseInt(e[2],16),i.b=parseInt(e[3],16),i.a=1):(e=/^#([\da-fA-F])([\da-fA-F])([\da-fA-F])/.exec(t))?(i.r=17*parseInt(e[1],16),i.g=17*parseInt(e[2],16),i.b=17*parseInt(e[3],16),i.a=1):(e=/^rgba\(([\d]+),([\d]+),([\d]+),([\d]+|[\d]*.[\d]+)\)/.exec(t))?(i.r=+e[1],i.g=+e[2],i.b=+e[3],i.a=+e[4]):(e=/^rgb\(([\d]+),([\d]+),([\d]+)\)/.exec(t))&&(i.r=+e[1],i.g=+e[2],i.b=+e[3],i.a=1),i}}),e.Editor.Field.CornerField=e.Editor.Field.extend(function(){this.defaults={value:null,disabled:!1},this.constructor=function(t){this.super(t)}}),e.Editor.Field.ImageField=e.Editor.Field.extend(function(){var t;this.defaults={value:null,disabled:!1},this.attributes={type:"file","class":"field imagefield"},this.constructor=function(t){this.super(t),this.addListener("change",this.onFileSelect,!1)},this.setValue=function(t,e){this.value=t,e!==!1&&this.triggerEvent("valuechange",{field:this,value:this.value},!1,!0)},this.onFileSelect=function(e){var i=e.target.files;t=i.length>0&&i[0].type.match("image.*")?i[0]:null},this.getBase64=function(i){var n;t&&(n=new FileReader,n.onload=e.Function.proxy(function(t){i.call(this,t.target.result,t)},this),n.readAsDataURL(t))}}),e.Editor.Field.IntegerField=e.Editor.Field.extend(function(){this.defaults={value:0,disabled:!1,min:null,max:null},this.attributes={type:"number","class":"field integerfield"},this.constructor=function(t){this.super(t)}}),e.Editor.Field.SelectField=e.Editor.Field.extend(function(){this.defaults={value:null,disabled:!1,options:{}},this.tag="<select/>",this.attributes={"class":"field selectfield"},this.constructor=function(t){this.super(t),this.setOptions(this.configs.options)},this.setOptions=function(t){e.Object.each(t,function(t,i){this.append(new e.Dom("<option/>",{text:i,value:t}))},this)},this.setValue=function(t){this.val(t),this.triggerEvent("valuechange",{field:this,value:this.value},!0,!1)},this.getValue=function(){return this.value},this.disable=function(){return this.disabled=!0,this.attr("disabled","disabled").addClass("disabled"),this},this.enable=function(){return this.disabled=!1,this.attr("disabled",null).removeClass("disabled"),this}}),e.Editor.Field.TimeField=e.Editor.Field.extend(function(){var t,i,n,a;this.defaults={value:0,disabled:!1,min:0,max:null},this.tag="<div/>",this.attributes={"class":"field timefield"},this.constructor=function(s){t=new e.Dom("<input/>",{type:"number","class":"hours"}),i=new e.Dom("<input/>",{type:"number","class":"minutes"}),n=new e.Dom("<input/>",{type:"number","class":"seconds"}),a=new e.Dom("<input/>",{type:"number","class":"centiseconds"}),this.super(s),t.addListener("input",this.onInput).appendTo(this),new e.Dom("<span/>",{text:":","class":"separator"}).appendTo(this),i.addListener("input",this.onInput).appendTo(this),new e.Dom("<span/>",{text:":","class":"separator"}).appendTo(this),n.addListener("input",this.onInput).appendTo(this),new e.Dom("<span/>",{text:".","class":"separator"}).appendTo(this),a.addListener("input",this.onInput).appendTo(this)},this.onInput=function(e){var s=parseInt(a.val(),10),o=parseInt(n.val(),10),r=parseInt(i.val(),10),l=parseInt(t.val(),10);e.stopPropagation(),this.setValue(10*s+1e3*o+6e4*r+36e5*l)},this.setValue=function(e){var s,o,r,l;this.value=e,null!==this.configs.min&&(this.value=Math.max(this.value,this.configs.min)),null!==this.configs.max&&(this.value=Math.min(this.value,this.configs.max)),s=parseInt(this.value/10%100,10),o=parseInt(this.value/1e3%60,10),r=parseInt(this.value/6e4%60,10),l=parseInt(this.value/36e5,10),a.val(s),n.val(o),i.val(r),t.val(l),this.triggerEvent("valuechange",{field:this,value:this.value},!0,!1)},this.getValue=function(){return this.value},this.disable=function(){return this.disabled=!0,t.attr("disabled","disabled"),i.attr("disabled","disabled"),n.attr("disabled","disabled"),a.attr("disabled","disabled"),this.addClass("disabled"),this},this.enable=function(){return this.disabled=!1,t.attr("disabled",null),i.attr("disabled",null),n.attr("disabled",null),a.attr("disabled",null),this.removeClass("disabled"),this}}),e.Editor.Panel.Block=e.Editor.Panel.extend(function(){var t,i;this.defaults={title:e.String.t("Block"),fields:{x:{type:e.Editor.Field.IntegerField,label:e.String.t("X")},y:{type:e.Editor.Field.IntegerField,label:e.String.t("Y")},width:{type:e.Editor.Field.IntegerField,label:e.String.t("Width")},height:{type:e.Editor.Field.IntegerField,label:e.String.t("Height")},"bg-color":{type:e.Editor.Field.ColorField,label:e.String.t("Background color")},"bg-image":{type:e.Editor.Field.ImageField,label:e.String.t("Background image")},synched:{type:e.Editor.Field.BooleanField,label:e.String.t("Synchronized pages ?")}}},this.constructor=function(i){this.super(i),t=new e.Editor.DropDownMenu,t.addItem({text:e.String.t("Add a new block"),"data-action":"new"}),t.addItem({text:e.String.t("Delete the active block"),"data-action":"delete"}),this.getToolbar().addButton().data("action","menu").append(t),this.addDelegate(".field","valuechange",this.onFieldValueChange)},this.getMenu=function(){return t},this.getBlock=function(){return i},this.setBlock=function(t,n){return i&&i.get(0)===t.get(0)?void 0:(this.unsetBlock(n),this.enableFields(),this.updateFieldValues(t),this.getMenu().enableItems('[data-action="delete"]'),t._draggable=new e.Draggable(t,t.child(".pager"),t.parents()).enable(),t._resizable=new e.Resizable(t,t.parents()).enable(),t.addListener("dragstart",this.onBlockDragStart).addListener("dragend",this.onBlockDragEnd).addListener("resizestart",this.onBlockResizeStart).addListener("resizeend",this.onBlockResizeEnd).addClass("selected"),n!==!0&&this.triggerEvent("blockset",{block:t}),i=t,this)},this.unsetBlock=function(t){var e=this.getBlock();return this.disableFields(),this.getMenu().disableItems('[data-action="delete"]'),e&&(e._draggable.destroy(),delete e._draggable,e._resizable.destroy(),delete e._resizable,e.removeListener("dragstart",this.onBlockDragStart).removeListener("dragend",this.onBlockDragEnd).removeListener("resizestart",this.onBlockResizeStart).removeListener("resizeend",this.onBlockResizeEnd).removeClass("selected"),i=null),t!==!0&&this.triggerEvent("blockunset",{block:e}),this},this.onBlockDragStart=function(){var t=this.getBlock(),e=["x","y"];this.beforeDragValues=this.getValues(t,e)},this.onBlockDragEnd=function(){var t=this.getBlock(),e=["x","y"];this.updateFieldValues(t,e,!0),this.triggerEvent("valueschange",{block:t,old_values:this.beforeDragValues,new_values:this.getValues(t,e)}),delete this.beforeDragValues},this.onBlockResizeStart=function(){var t=this.getBlock(),e=["x","y","width","height"];this.beforeResizeValues=this.getValues(t,e)},this.onBlockResizeEnd=function(){var t=this.getBlock(),e=["x","y","width","height"];this.updateFieldValues(t,e,!0),this.triggerEvent("valueschange",{block:t,old_values:this.beforeResizeValues,new_values:this.getValues(t,e)}),delete this.beforeResizeValues},this.onFieldValueChange=function(t){var e,i,n,a=this.getBlock();a&&(e=t.detail.field.data("name"),i=t.detail.value,n=this.getValues(a,[e]),this.updateBlockProperty(a,e,i),this.triggerEvent("valueschange",{block:a,old_values:n,new_values:this.getValues(a,[e])}))},this.updateFieldValue=function(t,e,i){var n=this.getField(t);switch(t){case"x":case"y":case"width":case"height":case"bg-color":n.setValue(e);break;case"bg-image":break;case"synched":n.setChecked(e)}i!==!0&&n.triggerEvent("change")},this.updateFieldValues=function(t,i,n){t===this.getBlock()&&(i=i||this.getValues(t,Object.keys(this.getField())),e.Var.is(i,"array")?e.Array.each(i,function(e,i){this.updateFieldValue(i,this.getValue(t,i),n)},this):e.Object.each(i,function(t,e){this.updateFieldValue(t,e,n)},this))},this.updateBlockProperty=function(t,e,i){switch(e){case"x":t.css("left",i+"px");break;case"y":t.css("top",i+"px");break;case"width":t.css("width",i+"px");break;case"height":t.css("height",i+"px");break;case"bg-color":t.css("background-color","rgba("+i.r+","+i.g+","+i.b+","+i.a+")");break;case"bg-image":break;case"synched":t.data("synched",i)}},this.updateBlockProperties=function(t,i){e.Object.each(i,function(e,i){this.updateBlockProperty(t,e,i)},this),this.updateFieldValues(t,i,!0)},this.getValue=function(t,e){var i;switch(e){case"x":i=parseInt(t.css("left"),10);break;case"y":i=parseInt(t.css("top"),10);break;case"width":i=parseInt(t.css("width"),10);break;case"height":i=parseInt(t.css("height"),10);break;case"bg-color":i=t.css("background-color");break;case"bg-image":break;case"synched":i="true"===t.data("synched")}return i},this.getValues=function(t,i){var n={};return i=i||Object.keys(this.getField()),e.Array.each(i,function(e,i){n[i]=this.getValue(t,i)},this),n}}),e.Editor.Panel.Element=e.Editor.Panel.extend(function(){var t,i;this.defaults={title:e.String.t("Element"),fields:{x:{type:e.Editor.Field.IntegerField,label:e.String.t("X")},y:{type:e.Editor.Field.IntegerField,label:e.String.t("Y")},width:{type:e.Editor.Field.IntegerField,label:e.String.t("Width")},height:{type:e.Editor.Field.IntegerField,label:e.String.t("Height")},"r-index":{type:e.Editor.Field.IntegerField,label:e.String.t("Reading index"),configs:{min:0}},"z-index":{type:e.Editor.Field.IntegerField,label:e.String.t("Display index")},"bg-color":{type:e.Editor.Field.ColorField,label:e.String.t("Background color")},"bg-image":{type:e.Editor.Field.ImageField,label:e.String.t("Background image")},"border-width":{type:e.Editor.Field.IntegerField,label:e.String.t("Border width")},"border-color":{type:e.Editor.Field.ColorField,label:e.String.t("Border color")},"rounded-conrners":{type:e.Editor.Field.CornerField,label:e.String.t("Rounded conrners")},"start-time":{type:e.Editor.Field.TimeField,label:e.String.t("Start time")},"end-time":{type:e.Editor.Field.TimeField,label:e.String.t("End time")},"font-family":{type:e.Editor.Field.SelectField,configs:{options:{"Georgia, serif":"Georgia",'"Times New Roman", Times, serif':"Times New Roman","Arial, Helvetica, sans-serif":"Arial",'"Comic Sans MS", cursive, sans-serif':"Comic Sans MS","Impact, Charcoal, sans-serif":"Impact",'"Lucida Sans Unicode", "Lucida Grande", sans-serif':"Lucida Sans Unicode","Tahoma, Geneva, sans-serif":"Tahoma","Verdana, Geneva, sans-serif":"Verdana",'"Courier New", Courier, monospace':"Courier New",'"Lucida Console", Monaco, monospace':"Lucida Console"}},label:e.String.t("Font")}}},this.constructor=function(i){var n;this.super(i),n=this.getToolbar(),n.addButton().data("action","previous"),n.addButton().data("action","next"),t=new e.Editor.DropDownMenu,t.addItem({text:e.String.t("Add a new cursor"),"data-action":"new","data-type":"Cursor"}),t.addItem({text:e.String.t("Add a new image"),"data-action":"new","data-type":"Image"}),t.addItem({text:e.String.t("Add a new text element"),"data-action":"new","data-type":"Text"}),t.addItem({text:e.String.t("Delete the active element"),"data-action":"delete"}),n.addButton().data("action","menu").append(t),this.addDelegate(".field","valuechange",this.onFieldValueChange)},this.getMenu=function(){return t},this.getElement=function(){return i},this.setElement=function(t,n){if(!i||i.get(0)!==t.get(0)){switch(this.unsetElement(i,n),i=t,this.updateValues(),this.enableFields(),this.getMenu().enableItems('[data-action="delete"]'),i._draggable=new e.Draggable(i,i,i.parents()).enable(),i._resizable=new e.Resizable(i,i.parents()).enable(),i.addListener("drag",this.onElementDrag).addListener("resize",this.onElementResize).addClass("selected"),i.data("type")){case"cursor":break;case"image":break;case"text":i.attr("contenteditable","true")}return n!==!0&&this.triggerEvent("elementset",{element:i}),this}},this.unsetElement=function(t,e){if(t=t||this.getElement(),this.disableFields(),this.getMenu().disableItems('[data-action="delete"]'),t){switch(t._draggable.destroy(),delete t._draggable,t._resizable.destroy(),delete t._resizable,t.removeListener("drag",this.onElementDrag).removeListener("resize",this.onElementResize).removeClass("selected"),i.data("type")){case"cursor":break;case"image":break;case"text":i.attr("contenteditable",null)}i=null}return e!==!0&&this.triggerEvent("elementunset",{element:t}),this},this.onElementDrag=function(){this.updateValues(["x","y"])},this.onElementResize=function(){this.updateValues(["x","y","width","height"])},this.onFieldValueChange=function(t){var e=t.detail.field,n=t.detail.value;if(i)switch(e.data("name")){case"x":i.css("left",n+"px");break;case"y":i.css("top",n+"px");break;case"width":i.css("width",n+"px");break;case"height":i.css("height",n+"px");break;case"r-index":i.data("r-index",n);break;case"z-index":i.css("z-index",n);break;case"bg-color":i.css("background-color","rgba("+n.r+","+n.g+","+n.b+","+n.a+")");break;case"bg-image":break;case"border-width":i.css("border-width",n+"px");break;case"border-color":i.css("border-color","rgba("+n.r+","+n.g+","+n.b+","+n.a+")");break;case"rounded-conrners":break;case"start-time":i.data("start-time",n);break;case"end-time":i.data("end-time",n)}},this.updateValue=function(t){var e=this.getField(t);switch(t){case"x":e.setValue(parseInt(i.css("left"),10));break;case"y":e.setValue(parseInt(i.css("top"),10));break;case"width":e.setValue(parseInt(i.css("width"),10));break;case"height":e.setValue(parseInt(i.css("height"),10));break;case"r-index":e.setValue(i.data("r-index")||0);break;case"z-index":e.setValue(parseInt(i.css("z-index"),10));break;case"bg-color":e.setValue(i.css("background-color"));break;case"bg-image":break;case"border-width":e.setValue(parseInt(i.css("border-width"),10));break;case"border-color":e.setValue(i.css("border-color"));break;case"rounded-conrners":break;case"start-time":e.setValue(i.data("start-time")||0);break;case"end-time":e.setValue(i.data("end-time")||0)}},this.updateValues=function(t){void 0===t&&(t=Object.keys(this.getField())),e.Object.each(t,function(t,e){this.updateValue(e)},this)}}),e.Editor.Panel.Page=e.Editor.Panel.extend(function(){var t,i;this.defaults={title:e.String.t("Page"),fields:{"bg-color":{type:e.Editor.Field.ColorField,label:e.String.t("Background color")},"bg-image":{type:e.Editor.Field.ImageField,label:e.String.t("Background image")},"start-time":{type:e.Editor.Field.TimeField,label:e.String.t("Start time")},"end-time":{type:e.Editor.Field.TimeField,label:e.String.t("End time")}}},this.constructor=function(i){this.super(i),t=new e.Editor.DropDownMenu,t.addItem({text:e.String.t("Add a new page"),"data-action":"new"}),t.addItem({text:e.String.t("Delete the active page"),"data-action":"delete"}),this.getToolbar().addButton().data("action","menu").append(t),this.addDelegate(".field","valuechange",this.onFieldValueChange)},this.getMenu=function(){return t},this.getPage=function(){return i},this.setPage=function(t,e){return i&&i.get(0)===t.get(0)?void 0:(this.unsetPage(i,e),i=t,this.updateValues(),this.enableFields(),this.getMenu().enableItems('[data-action="delete"]'),e!==!0&&this.triggerEvent("pageset",{page:i}),this)},this.unsetPage=function(t,e){return t=t||this.getPage(),this.disableFields(),this.getMenu().disableItems('[data-action="delete"]'),t&&(i=null),e!==!0&&this.triggerEvent("pageunset",{page:t}),this},this.onFieldValueChange=function(t){var e=t.detail.field,n=t.detail.value;if(i)switch(e.data("name")){case"bg-color":i.css("background-color","rgba("+n.r+","+n.g+","+n.b+","+n.a+")");break;case"bg_image":case"start-time":i.data("start-time",n);break;case"end-time":i.data("end-time",n)}},this.updateValue=function(t){var e=this.getField(t);switch(t){case"bg-color":e.setValue(i.css("background-color"));break;case"bg-image":break;case"start-time":e.setValue(i.data("start-time")||0);break;case"end-time":e.setValue(i.data("end-time")||0)}},this.updateValues=function(t){void 0===t&&(t=Object.keys(this.getField())),e.Object.each(t,function(t,e){this.updateValue(e)},this)}}),e.Editor.Popup.GuideSelector=e.Editor.Popup.extend(function(){this.defaults={title:e.String.t("Select a guide"),parent:".metaScore-editor",modal:!0,draggable:!1,url:null,selectCallback:e.Function.emptyFn,hideOnSelect:!0},this.constructor=function(t){this.super(t),this.addClass("guide-selector loading"),new e.Dom("<div/>",{"class":"loading",text:e.String.t("Loading...")}).appendTo(this.getContents()),e.Ajax.get(this.configs.url,{success:this.onLoad,error:this.onError})},this.onLoad=function(t){var i,n,a=this.getContents(),s=JSON.parse(t.response);this.removeClass("loading"),a.empty(),i=new e.Dom("<table/>",{"class":"guides"}).appendTo(a),e.Object.each(s,function(t,a){n=new e.Dom("<tr/>",{"class":"guide guide-"+a.id}).addListener("click",e.Function.proxy(function(){this.onGuideClick(a)},this)).appendTo(i),new e.Dom("<td/>",{"class":"thumbnail"}).append(new e.Dom("<img/>",{src:a.thumbnail.url})).appendTo(n),new e.Dom("<td/>",{"class":"details"}).append(new e.Dom("<h1/>",{"class":"title",text:a.title})).append(new e.Dom("<p/>",{"class":"description",text:a.description})).append(new e.Dom("<h2/>",{"class":"author",text:a.author.name})).appendTo(n)},this)},this.onError=function(){},this.onGuideClick=function(t){this.configs.selectCallback(t),this.configs.hideOnSelect&&this.hide()}}),e.Player=e.Base.extend(function(){var t;this.defaults={keyboard:!0},this.constructor=function(i){this.initConfig(i),t=new e.Player.Media}}),e.Player.Block=e.Dom.extend(function(){var t,i;this.constructor=function(n){t=[],n?(this.super(n),t=this.children(".pages"),i=new e.Player.Pager(this.child(".pager").get(0))):(this.super("<div/>",{"class":"metaScore-block"}),t=new e.Dom("<div/>",{"class":"pages"}).appendTo(this),i=(new e.Player.Pager).appendTo(this)),i.addDelegate(".button","click",function(t){var i,n=!e.Dom.hasClass(t.target,"inactive");if(n)switch(i=e.Dom.data(t.target,"action")){case"first":this.setActivePage(0);break;case"previous":this.setActivePage(this.getActivePageIndex()-1);break;case"next":this.setActivePage(this.getActivePageIndex()+1)}t.stopPropagation()},this),this.addListener("click",this.onClick)},this.getPages=function(){return t.children(".page")},this.addPage=function(e){t.append(e),this.setActivePage(this.getPages().count()-1)},this.getActivePage=function(){var t=(this.getPages(),this.getActivePageIndex());return new e.Player.Page(this.getPages().get(t))},this.getActivePageIndex=function(){var t=this.getPages(),e=t.index(".active");return 0>e&&(e=0),e},this.getPageCount=function(){return this.getPages().count()},this.setActivePage=function(t){var i=this.getPages(),n=new e.Player.Page(i.get(t));i.removeClass("active"),n.addClass("active"),this.updatePager(),this.triggerEvent("pageactivated",{index:t,page:n})},this.updatePager=function(){var t=this.getActivePageIndex(),e=this.getPageCount();i.updateCount(t,e)},this.isSynched=function(){return"true"===this.data("synched")},this.onClick=function(t){this.triggerEvent("blockclick",{block:this}),t.stopPropagation()}}),e.Player.CuePoints=e.Base.extend(function(){var t,i;this.constructor=function(e){i=[],t=e,t.addEventListener("timeupdate",this.onMediaTimeUpdate)},this.onMediaTimeUpdate=function(){var n;n=parseFloat(t.currentTime),e.Object.each(i,function(t,e){!e.timer&&n>=e.inTime-.5&&e.inTime>n&&this.setupTimer(e,1e3*(e.inTime-n))})},this.add=function(t){return i.push(t)-1},this.remove=function(t){var e=i[t];this.stop(e,!1),i.splice(t,1)},this.setupTimer=function(t,i){t.timer=setTimeout(e.Function.proxy(this.launch,this,t),i)},this.launch=function(i){i.hasOwnProperty("onStart")&&e.Var.is(i.onStart,"function")&&i.onStart(t)},this.stop=function(i,n){i.hasOwnProperty("timer")&&(clearTimeout(i.timer),delete i.timer),i.hasOwnProperty("interval")&&(clearInterval(i.interval),delete i.interval),n!==!1&&i.hasOwnProperty("onEnd")&&e.Var.is(i.onEnd,"function")&&i.onEnd(t)}}),e.Player.Element=e.Dom.extend(function(){this.constructor=function(t){t?this.super(t):this.super("<div/>",{"class":"element"}),this.addListener("click",this.onClick)},this.onClick=function(t){this.triggerEvent("elementclick",{element:this}),t.stopPropagation()}}),e.Player.Media=e.Dom.extend(function(){this.defaults={type:"video",sources:[]},this.constructor=function(t){console.log(this.super),this.initConfig(t),console.log(this.super)},this.play=function(){},this.pause=function(){},this.stop=function(){},this.setCurrentTime=function(){},this.getCurrentTime=function(){}}),e.Player.Page=e.Dom.extend(function(){this.constructor=function(t){t?this.super(t):this.super("<div/>",{"class":"page"}),this.addListener("click",this.onClick)},this.addElement=function(t){return this.append(t),t},this.onClick=function(t){this.triggerEvent("pageclick",{page:this}),t.stopPropagation()}}),e.Player.Pager=e.Dom.extend(function(){var t,i;this.constructor=function(n){n?(this.super(n),t=this.child(".count"),i=this.child(".buttons"),i.first=i.child('[data-action="first"]'),i.previous=i.child('[data-action="previous"]'),i.next=i.child('[data-action="next"]')):(this.super("<div/>",{"class":"pager"}),t=new e.Dom("<div/>",{"class":"count"}).appendTo(this),i=new e.Dom("<div/>",{"class":"buttons"}).addListener("mousedown",function(t){t.stopPropagation()}).appendTo(this),i.first=new e.Dom("<div/>",{"class":"button","data-action":"first"}).appendTo(i),i.previous=new e.Dom("<div/>",{"class":"button","data-action":"previous"}).appendTo(i),i.next=new e.Dom("<div/>",{"class":"button","data-action":"next"}).appendTo(i))},this.updateCount=function(n,a){t.text(e.String.t("page !current/!count",{"!current":n+1,"!count":a})),i.first.toggleClass("inactive",0===n),i.previous.toggleClass("inactive",0===n),i.next.toggleClass("inactive",n>=a-1)}}),e.Player.Element.Cursor=e.Player.Element.extend(function(){this.constructor=function(t){this.super(t),this.data("type","cursor")}}),e.Player.Element.Image=e.Player.Element.extend(function(){this.constructor=function(t){this.super(t),this.data("type","image")}}),e.Player.Element.Text=e.Player.Element.extend(function(){this.constructor=function(t){this.super(t),this.data("type","text")}}),t.metaScore=e})(this);