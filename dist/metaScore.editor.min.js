/*! metaScore - v0.0.1 - 2014-07-04 - Oussama Mubarak */
(function(e){"use strict";var t={version:"0.0.1",locale:{},loadLocale:function(e,n,i){t.Ajax.get(e,{success:function(e){console.log(e),n.call(i)},error:function(){n.call(i)}})}};(function(e){function t(e){e.parent instanceof Function&&(t.apply(this,[e.parent]),this.super=n(this,i(this,this.constructor))),e.apply(this,arguments)}function n(e,t){for(var n in e)"super"!==n&&e[n]instanceof Function&&(t[n]=e[n].super||i(e,e[n]));return t}function i(e,t){var n=e.super;return t.super=function(){return e.super=n,t.apply(e,arguments)}}e.Base=function(){},e.Base.extend=function a(e){function i(){t!==arguments[0]&&(t.apply(this,[e]),n(this,this),this.initializer instanceof Function&&this.initializer.apply(this),this.constructor.apply(this,arguments))}return i.prototype=new this(t),i.prototype.constructor=i,i.toString=function(){return""+e},i.extend=function(t){return t.parent=e,a.apply(i,arguments)},i},e.Base=e.Base.extend(function(){this.constructor=function(){},this.initConfig=function(t){t=t||{},this.configs=this.defaults?e.Object.extend({},this.defaults,t):t}})})(t),Element&&function(e){e.matches=e.matchesSelector=e.matchesSelector||e.webkitMatchesSelector||e.mozMatchesSelector||e.msMatchesSelector||e.oMatchesSelector||function(e){for(var t=(this.parentNode||this.document).querySelectorAll(e),n=-1;t[++n]&&t[n]!==this;);return!!t[n]}}(Element.prototype),t.Evented=t.Base.extend(function(){var e={};this.addListener=function(t,n){return e[t]===void 0&&(e[t]=[]),e[t].push(n),this},this.removeListener=function(t,n){if(e[t]instanceof Array)for(var i=e[t],a=0,s=i.length;s>a;a++)if(i[a]===n){i.splice(a,1);break}return this},this.triggerEvent=function(n,i,a,s){var o,r;return e[n]instanceof Array&&(o=e[n],r={target:this,type:n,detail:i,bubbles:a!==!1,cancelable:s!==!1},t.Object.each(o,function(e,t){t.call(this,r)},this)),this}}),t.Ajax=t.Base.extend(function(){}),t.Ajax.createXHR=function(){var e,t,n,i=["MSXML2.XMLHttp.5.0","MSXML2.XMLHttp.4.0","MSXML2.XMLHttp.3.0","MSXML2.XMLHttp","Microsoft.XMLHttp"];if("undefined"!=typeof XMLHttpRequest)return e=new XMLHttpRequest;if(window.ActiveXObject)for(t=0,n=i.length;n>t;t++)try{return e=new ActiveXObject(i[t])}catch(a){}throw Error("XMLHttp object could be created.")},t.Ajax.send=function(e,n){var i,a=t.Ajax.createXHR(),s=[],o={method:"GET",headers:[],async:!0,data:{},complete:null,success:null,error:null,scope:this};return n=t.Object.extend(function(){},o,n),t.Object.each(n.data,function(e,t){s.push(encodeURIComponent(e)+"="+encodeURIComponent(t))}),"POST"===n.method?(i=s.join("&"),n.headers["Content-type"]="application/x-www-form-urlencoded"):e+="?"+s.join("&"),a.open(n.method,e,n.async),t.Object.each(n.headers,function(e,t){a.setRequestHeader(e,t)}),a.onreadystatechange=function(){4===a.readyState&&(t.Var.is(n.complete,"function")&&n.complete.call(n.scope,a),a.status>=200&&300>status||304===status?t.Var.is(n.success,"function")&&n.success.call(n.scope,a):t.Var.is(n.error,"function")&&n.error.call(n.scope,a))},a.send(i),a},t.Ajax.get=function(e,n){return t.Object.extend(n,{method:"GET"}),t.Ajax.send(e,n)},t.Ajax.post=function(e,n){return t.Object.extend(n,{method:"POST"}),t.Ajax.send(e,n)},t.Array=t.Base.extend(function(){}),t.Array.inArray=function(e,t){var n,i=0;if(t){if(t.indexOf)return t.indexOf(e);for(n=t.length;n>i;i++)if(i in t&&t[i]===e)return i}return-1},t.Array.copy=function(e){return[].concat(e)},t.Array.shuffle=function(e){var n=t.Array.copy(e);return n.sort(function(){return(0|3*Math.random())-1}),n},t.Array.unique=function(e){for(var t=[],n=e.length,i=0;n>i;i++){for(var a=i+1;n>a;a++)e[i]===e[a]&&(a=++i);t.push(e[i])}return t},t.Array.each=function(e,t,n){for(var i,a=0,s=e.length,o=void 0!==n;s>a&&(i=t.call(o?n:e[a],a,e[a]),i!==!1);a++);return e},t.Array.remove=function(e,n){for(var i=t.Array.inArray(n,e);i>-1;)e.splice(i,1),i=t.Array.inArray(n,e);return e},t.Dom=t.Base.extend(function(){this.constructor=function(){var e;this.elements=[],arguments.length>0&&((e=t.Dom.elementsFromString.apply(this,arguments))?(this.add(e),arguments.length>1&&this.attr(arguments[1])):(e=t.Dom.selectElements.apply(this,arguments))&&(this.add(e),arguments.length>2&&this.attr(arguments[2])))},this.add=function(e){if(e.hasOwnProperty("length"))for(var t=0;e.length>t;t++)this.elements.push(e[t]);else this.elements.push(e)},this.count=function(){return this.elements.length},this.get=function(e){return this.elements[e]},this.filter=function(e){var n=[];return t.Array.each(this.elements,function(i,a){t.Dom.is(a,e)&&n.push(a)},this),this.elements=n,this},this.index=function(e){var n=-1;return t.Array.each(this.elements,function(i,a){return t.Dom.is(a,e)?(n=i,!1):void 0},this),n},this.child=function(e){var n,i=new t.Dom;return t.Array.each(this.elements,function(a,s){return(n=t.Dom.selectElement.call(this,e,s))?(i.add(n),!1):void 0},this),i},this.children=function(e){var n=new t.Dom;return t.Array.each(this.elements,function(i,a){n.add(t.Dom.selectElements.call(this,e,a))},this),n},this.parents=function(e){var n=new t.Dom;return t.Array.each(this.elements,function(e,t){n.add(t.parentElement)},this),e&&n.filter(e),n},this.addClass=function(e){return t.Array.each(this.elements,function(n,i){t.Dom.addClass(i,e)},this),this},this.removeClass=function(e){return t.Array.each(this.elements,function(n,i){t.Dom.removeClass(i,e)},this),this},this.toggleClass=function(e,n){return t.Array.each(this.elements,function(i,a){t.Dom.toggleClass(a,e,n)},this),this},this.addListener=function(e,n,i){return t.Array.each(this.elements,function(a,s){t.Dom.addListener(s,e,n,i)},this),this},this.addDelegate=function(e,n,i,a,s){return a=a||this,this.addListener(n,function(n){t.Dom.is(n.target,e)&&i.call(a,n)},s)},this.removeListener=function(e,n,i){return t.Array.each(this.elements,function(a,s){t.Dom.removeListener(s,e,n,i)},this),this},this.triggerEvent=function(e,n,i,a){var s=!0;return t.Array.each(this.elements,function(o,r){s=t.Dom.triggerEvent(r,e,n,i,a)&&s},this),s},this.text=function(e){return void 0===e?t.Dom.text(this.get(0)):(t.Array.each(this.elements,function(n,i){t.Dom.text(i,e)},this),void 0)},this.val=function(e){return void 0!==e?(t.Array.each(this.elements,function(n,i){t.Dom.val(i,e)},this),this):t.Dom.val(this.get(0))},this.attr=function(e,n){return void 0!==n||t.Var.is(e,"object")?(t.Array.each(this.elements,function(i,a){t.Dom.attr(a,e,n)},this),this):t.Dom.attr(this.get(0),e)},this.css=function(e,n){return void 0!==n?(t.Array.each(this.elements,function(i,a){t.Dom.css(a,e,n)},this),this):t.Dom.css(this.get(0),e)},this.data=function(e,n){return void 0!==n?(t.Array.each(this.elements,function(i,a){t.Dom.data(a,e,n)},this),this):t.Dom.data(this.get(0),e)},this.append=function(e){return e instanceof t.Dom&&(e=e.elements),t.Dom.append(this.get(0),e),this},this.appendTo=function(e){return e instanceof t.Dom||(e=new t.Dom(e)),e=e.get(0),t.Array.each(this.elements,function(n,i){t.Dom.append(e,i)},this),this},this.show=function(){return t.Array.each(this.elements,function(){this.css("display","initial")},this),this},this.hide=function(){return t.Array.each(this.elements,function(){this.css("display","none")},this),this},this.remove=function(){return this.triggerEvent("beforeremove")!==!1&&t.Array.each(this.elements,function(e,n){var i=n.parentElement;t.Dom.remove(n),t.Dom.triggerEvent(i,"childremoved",{child:n})},this),this},this.is=function(e){var n;return t.Array.each(this.elements,function(i,a){return n=t.Dom.is(a,e)},this),n}}),t.Dom.stringRe=/^<(.)+>$/,t.Dom.camelRe=/-([\da-z])/gi,t.Dom.camelReplaceFn=function(e,t){return t.toUpperCase()},t.Dom.camel=function(e){return e.replace(t.Dom.camelRe,t.Dom.camelReplaceFn)},t.Dom.bubbleEvents={click:!0,submit:!0,mousedown:!0,mousemove:!0,mouseup:!0,mouseover:!0,mouseout:!0,transitionend:!0},t.Dom.selectElement=function(e,n){var i;return n||(n=document),i=t.Var.is(e,"string")?n.querySelector(e):e.length?e[0]:e},t.Dom.selectElements=function(e,n){var i;return n||(n=document),i=t.Var.is(e,"string")?n.querySelectorAll(e):e.length?e:[e]},t.Dom.elementsFromString=function(e){var t,n,i,a={option:[1,"<select multiple='multiple'>","</select>"],optgroup:[1,"<select multiple='multiple'>","</select>"],legend:[1,"<fieldset>","</fieldset>"],area:[1,"<map>","</map>"],param:[1,"<object>","</object>"],thead:[1,"<table>","</table>"],tbody:[1,"<table>","</table>"],tfoot:[1,"<table>","</table>"],colgroup:[1,"<table>","</table>"],caption:[1,"<table>","</table>"],tr:[2,"<table><tbody>","</tbody></table>"],col:[2,"<table><tbody></tbody><colgroup>","</colgroup></table>"],th:[3,"<table><tbody><tr>","</tr></tbody></table>"],td:[3,"<table><tbody><tr>","</tr></tbody></table>"],_default:[1,"<div>","</div>"]},s=document.createElement("div"),o=/<\s*\w.*?>/g.exec(e);if(null!=o){for(t=o[0].replace(/</g,"").replace(/\/?>/g,""),n=a[t]||a._default,e=n[1]+e+n[2],s.innerHTML=e,i=n[0];i--;)s=s.lastChild;return s.childNodes}return null},t.Dom.hasClass=function(e,t){return e.classList.contains(t)},t.Dom.addClass=function(e,t){for(var n=t.split(" "),i=0,a=n.length;a>i;i++)e.classList.add(n[i])},t.Dom.removeClass=function(e,t){for(var n=t.split(" "),i=0,a=n.length;a>i;i++)e.classList.remove(n[i])},t.Dom.toggleClass=function(e,t,n){var i=t.split(" "),a=0,s=i.length;if(void 0===n)for(;s>a;a++)e.classList.toggle(i[a]);else for(;s>a;a++)e.classList.toggle(i[a],n)},t.Dom.addListener=function(e,n,i,a){return void 0===a&&(a=t.Dom.bubbleEvents.hasOwnProperty("type")?t.Dom.bubbleEvents[n]:!1),e.addEventListener(n,i,a)},t.Dom.removeListener=function(e,n,i,a){return void 0===a&&(a=t.Dom.bubbleEvents.hasOwnProperty("type")?t.Dom.bubbleEvents[n]:!1),e.removeEventListener(n,i,a)},t.Dom.triggerEvent=function(e,t,n,i,a){var s=new CustomEvent(t,{detail:n,bubbles:i!==!1,cancelable:a!==!1});return e.dispatchEvent(s)},t.Dom.text=function(e,t){return void 0!==t&&(e.innerHTML=t),e.innerHTML},t.Dom.val=function(e,t){return void 0!==t&&(e.value=t),e.value},t.Dom.attr=function(e,n,i){if(t.Var.is(n,"object"))t.Object.each(n,function(n,i){t.Dom.attr(e,n,i)},this);else switch(n){case"class":this.addClass(e,i);break;case"text":this.text(e,i);break;default:if(null!==i)return void 0!==i&&e.setAttribute(n,i),e.getAttribute(n);e.removeAttribute(n)}},t.Dom.css=function(e,t,n){var i,a;return i=this.camel(t),void 0!==n&&(e.style[i]=n),a=window.getComputedStyle(e),a.getPropertyValue(t)},t.Dom.data=function(e,t,n){return t=this.camel(t),null===n?delete e.dataset[t]:void 0!==n&&(e.dataset[t]=n),e.dataset[t]},t.Dom.append=function(e,n){t.Var.is(n,"array")||(n=[n]),t.Array.each(n,function(t,n){e.appendChild(n)},this)},t.Dom.remove=function(e){e.parentElement.removeChild(e)},t.Dom.is=function(e,t){return e.matches(t)},t.Draggable=t.Base.extend(function(){var e,n,i,a;this.constructor=function(a,s,o){e=a,n=s,i=o||new t.Dom("body"),this.enable()},this.onMouseDown=function(t){a={left:parseInt(e.css("left"),10)-t.clientX,top:parseInt(e.css("top"),10)-t.clientY},i.addListener("mouseup",this.onMouseUp).addListener("mousemove",this.onMouseMove),e.addClass("dragging").triggerEvent("dragstart",null,!1,!0),t.stopPropagation()},this.onMouseMove=function(t){var n=t.clientX+a.left,i=t.clientY+a.top;e.css("left",n+"px").css("top",i+"px").triggerEvent("drag",null,!1,!0),t.stopPropagation()},this.onMouseUp=function(t){i.removeListener("mousemove",this.onMouseMove).removeListener("mouseup",this.onMouseUp),e.removeClass("dragging").triggerEvent("dragend",null,!1,!0),t.stopPropagation()},this.enable=function(){return e.addClass("draggable"),n.addListener("mousedown",this.onMouseDown),this},this.disable=function(){return e.removeClass("draggable"),n.removeListener("mousedown",this.onMouseDown),this},this.destroy=function(){return this.disable(),this}}),t.Function=t.Base.extend(function(){}),t.Function.proxy=function(e,n){return t.Var.type(e,"function")?function(){return e.apply(n||this,arguments)}:void 0},t.Function.emptyFn=function(){},t.Object=t.Base.extend(function(){}),t.Object.extend=function(){for(var e,t,n,i,a=arguments[0]||{},s=1,o=arguments.length;o>s;s++)if(null!=(e=arguments[s]))for(t in e)n=a[t],i=e[t],n!==i&&void 0!==i&&(a[t]=i);return a},t.Object.copy=function(e){return t.Object.extend({},e)},t.Object.each=function(e,t,n){var i,a,s=void 0!==n;for(i in e)if(e.hasOwnProperty(i)&&(a=t.call(s?n:e[i],i,e[i]),a===!1))break;return e},t.Resizable=t.Base.extend(function(){var e,n,i,a;this.constructor=function(a,s){e=a,n=s||new t.Dom("body"),i={},i.top_left=new t.Dom("<div/>",{"class":"resize-handle"}).data("direction","top-left").appendTo(e),i.top_right=new t.Dom("<div/>",{"class":"resize-handle"}).data("direction","top-right").appendTo(e),i.bottom_left=new t.Dom("<div/>",{"class":"resize-handle"}).data("direction","bottom-left").appendTo(e),i.bottom_right=new t.Dom("<div/>",{"class":"resize-handle"}).data("direction","bottom-right").appendTo(e),this.enable()},this.onMouseDown=function(t){a={handle:t.target,x:t.clientX,y:t.clientY,left:parseInt(e.css("left"),10),top:parseInt(e.css("top"),10),w:parseInt(e.css("width"),10),h:parseInt(e.css("height"),10)},n.addListener("mousemove",this.onMouseMove).addListener("mouseup",this.onMouseUp),e.addClass("resizing").triggerEvent("resizestart",null,!1,!0),t.stopPropagation()},this.onMouseMove=function(n){var i,s,o,r,l=new t.Dom(a.handle);switch(l.data("direction")){case"top-left":i=a.w-n.clientX+a.x,s=a.h-n.clientY+a.y,o=a.top+n.clientY-a.y,r=a.left+n.clientX-a.x;break;case"top-right":i=a.w+n.clientX-a.x,s=a.h-n.clientY+a.y,o=a.top+n.clientY-a.y;break;case"bottom-left":i=a.w-n.clientX+a.x,s=a.h+n.clientY-a.y,r=a.left+n.clientX-a.x;break;case"bottom-right":i=a.w+n.clientX-a.x,s=a.h+n.clientY-a.y}void 0!==o&&e.css("top",o+"px"),void 0!==r&&e.css("left",r+"px"),e.css("width",i+"px").css("height",s+"px").triggerEvent("resize",null,!1,!0),n.stopPropagation()},this.onMouseUp=function(t){n.removeListener("mousemove",this.onMouseMove).removeListener("mouseup",this.onMouseUp),e.removeClass("resizing").triggerEvent("resizeend",null,!1,!0),t.stopPropagation()},this.enable=function(){return t.Object.each(i,function(e,t){t.addListener("mousedown",this.onMouseDown)},this),e.addClass("resizable"),this},this.disable=function(){return t.Object.each(i,function(e,t){t.removeListener("mousedown",this.onMouseDown)},this),e.removeClass("resizable"),this},this.destroy=function(){return this.disable(),t.Object.each(i,function(e,t){t.remove()},this),this}}),t.String=t.Base.extend(function(){}),t.String.capitalize=function(e){return e.replace(/(?:^|\s)\S/g,function(e){return e.toUpperCase()})},t.String.t=function(e,n){return t.formatString(e,n)},t.formatString=function(e,n){return t.Object.each(n,function(t){e=e.replace(t,n[t])},this),e},t.String.uuid=function(e,t){var n,i=["0","1","2","3","4","5","6","7","8","9","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z"],a=[];if(t=t||i.length,e)for(n=0;e>n;n++)a[n]=i[0|Math.random()*t];else{var s;for(a[8]=a[13]=a[18]=a[23]="-",a[14]="4",n=0;36>n;n++)a[n]||(s=0|16*Math.random(),a[n]=i[19===n?8|3&s:s])}return a.join("")},t.Var=t.Base.extend(function(){}),t.Var.classes2types={"[object Boolean]":"boolean","[object Number]":"number","[object String]":"string","[object Function]":"function","[object Array]":"array","[object Date]":"date","[object RegExp]":"regexp","[object Object]":"object"},t.Var.type=function(e){return null==e?e+"":t.Var.classes2types[Object.prototype.toString.call(e)]||"object"},t.Var.is=function(e,n){return t.Var.type(e)===n.toLowerCase()},t.Editor=t.Dom.extend(function(){var e,n,i,a,s,o,r,l,d,c,u,h;this.constructor=function(p){this.super("<div/>",{"class":"metaScore-editor"}),void 0!==p&&this.appendTo(p),e=new t.Dom("<div/>",{"class":"workspace"}).appendTo(this),n=(new t.Editor.MainMenu).appendTo(this),i=new t.Dom("<div/>",{"class":"sidebar"}).appendTo(this),a=(new t.Editor.Panel.Block).appendTo(i),s=(new t.Editor.Panel.Page).appendTo(i),o=(new t.Editor.Panel.Element).appendTo(i),r=new t.Dom("<iframe/>",{"class":"player-wrapper"}).appendTo(e),l=new t.Dom(r.get(0).contentDocument.head),d=new t.Dom(r.get(0).contentDocument.body).addClass("metaScore-player-wrapper"),c=new t.Player,u=new t.Dom("<div/>",{"class":"grid"}).appendTo(e),h=new t.Editor.History,new t.Dom("<link/>",{rel:"stylesheet",type:"text/css",href:"dist/metaScore.player.css"}).appendTo(l),n.addDelegate("button[data-action]:not(.disabled)","click",function(e){switch(t.Dom.data(e.target,"action")){case"new":break;case"open":break;case"save":break;case"download":break;case"delete":break;case"revert":break;case"undo":h.undo();break;case"redo":h.redo();break;case"edit":break;case"settings":break;case"help":}},this),a.addListener("blockset",function(e){var t=e.detail.block;s.setPage(t.getActivePage(),!0),s.getMenu().enableItems('[data-action="new"]'),o.getMenu().enableItems('[data-action="new"]'),e.stopPropagation()}).addListener("blockunset",function(e){s.unsetPage(),s.getMenu().disableItems('[data-action="new"]'),e.stopPropagation()}).addListener("valueschange",function(e){var t=e.detail.block,n=e.detail.old_values,i=e.detail.new_values;h.add({undo:function(){a.updateFieldValues(t,n)},redo:function(){a.updateFieldValues(t,i)}})}).getToolbar().addDelegate(".buttons [data-action]","click",function(e){switch(t.Dom.data(e.target,"action")){case"new":this.addBlock();break;case"delete":this.removeBlock()}e.stopPropagation()},this),s.addListener("pageset",function(e){var n=e.detail.page,i=new t.Player.Block(n.parents().parents().get(0));a.setBlock(i,!0),s.getMenu().enableItems('[data-action="new"]'),o.getMenu().enableItems('[data-action="new"]'),e.stopPropagation()}).addListener("pageunset",function(e){o.unsetElement(),o.getMenu().disableItems('[data-action="new"]'),e.stopPropagation()}).getToolbar().addDelegate(".buttons [data-action]","click",function(e){switch(t.Dom.data(e.target,"action")){case"new":this.addPage();break;case"delete":this.removePage()}e.stopPropagation()},this),o.addListener("elementset",function(e){var n=e.detail.element,i=new t.Player.Page(n.parents().get(0)),o=new t.Player.Block(i.parents().parents().get(0));s.setPage(i,!0),a.setBlock(o,!0),e.stopPropagation()}).getToolbar().addDelegate(".buttons [data-action]","click",function(e){switch(t.Dom.data(e.target,"action")){case"new":this.addElement(t.Dom.data(e.target,"type"));break;case"delete":this.removePage()}e.stopPropagation()},this),d.addDelegate(".metaScore-block .pages .page .element","click",function(e){var n=new t.Player.Element(e.target);o.setElement(n),e.stopImmediatePropagation()},this).addDelegate(".metaScore-block .pages .page","click",function(e){var n=new t.Player.Page(e.target);s.setPage(n),o.unsetElement(),e.stopImmediatePropagation()},this).addDelegate(".metaScore-block .pager","click",function(e){var n=new t.Player.Block(e.target.parentElement);a.setBlock(n),e.stopImmediatePropagation()},this).addListener("click",function(e){a.unsetBlock(),e.stopPropagation()}).addDelegate(".metaScore-block","pageactivated",function(e){var t=e.detail.page;s.setPage(t)},this).addDelegate(".metaScore-block .pages","childremoved",function(e){var n=new t.Player.Block(e.target.parentElement);0===n.getPageCount()&&this.addPage(n),n.setActivePage(0)},this).addListener("keydown",this.onKeydown).addListener("keyup",this.onKeyup),h.addListener("add",this.onHistoryAdd).addListener("undo",this.onHistoryUndo).addListener("redo",this.onHistoryRedo),new t.Dom("body").addListener("keydown",this.onKeydown).addListener("keyup",this.onKeyup),a.unsetBlock()},this.addBlock=function(e){return e||(e=new t.Player.Block,this.addPage(e)),e.appendTo(d),a.setBlock(e),h.add({undo:t.Function.proxy(function(){this.removeBlock(e)},this),redo:t.Function.proxy(function(){this.addBlock(e)},this)}),e},this.removeBlock=function(){var e;(e=a.getBlock())&&e.remove(),a.unsetBlock()},this.addPage=function(e){var n;return e=e||a.getBlock(),n=new t.Player.Page,e.addPage(n),s.setPage(n),n},this.removePage=function(){var e;(e=s.getPage())&&e.remove()},this.addElement=function(e,n){var i;return n=n||s.getPage(),i=new t.Player.Element[e],n.addElement(i),o.setElement(i),i},this.removeElement=function(){var e;(e=o.getElement())&&e.remove()},this.onKeydown=function(e){switch(e.keyCode){case 18:d.addClass("alt-down")}},this.onKeyup=function(e){switch(e.keyCode){case 18:d.removeClass("alt-down")}},this.onHistoryAdd=function(){n.enableItems('[data-action="undo"]'),n.disableItems('[data-action="redo"]')},this.onHistoryUndo=function(){h.hasUndo()?n.enableItems('[data-action="undo"]'):n.disableItems('[data-action="undo"]'),n.enableItems('[data-action="redo"]')},this.onHistoryRedo=function(){h.hasRedo()?n.enableItems('[data-action="redo"]'):n.disableItems('[data-action="redo"]'),n.enableItems('[data-action="undo"]')}}),t.Editor.Button=t.Dom.extend(function(){var e;this.disabled=!1,this.defaults={label:null},this.constructor=function(e){var t=this;this.super("<button/>"),this.initConfig(e),this.configs.label&&this.setLabel(this.configs.label),this.addListener("click",function(e){t.disabled&&e.stopPropagation()})},this.setLabel=function(n){void 0===e&&(e=new t.Dom("<span/>",{"class":"label"}).appendTo(this)),e.text(n)},this.disable=function(){return this.disabled=!0,this.addClass("disabled"),this},this.enable=function(){return this.disabled=!1,this.removeClass("disabled"),this}}),t.Editor.DropDownMenu=t.Dom.extend(function(){this.constructor=function(e){this.super("<ul/>",{"class":"dropdown-menu"}),this.initConfig(e)},this.addItem=function(e){var n=new t.Dom("<li/>",e).appendTo(this);return n},this.enableItems=function(e){var t=this.children(e);return t.removeListener("click",this.preventClick).removeClass("disabled"),t},this.disableItems=function(e){var t=this.children(e);return t.addListener("click",this.preventClick).addClass("disabled"),t},this.preventClick=function(e){e.stopPropagation()}}),t.Editor.Field=t.Dom.extend(function(){this.defaults={value:null,disabled:!1},this.tag="<input/>",this.attributes={type:"text","class":"field"},this.constructor=function(e){this.super(this.tag,this.attributes),this.initConfig(e),null!==this.configs.value&&this.setValue(this.configs.value),this.configs.disabled&&this.disable(),this.addListener("change",this.onChange)},this.onChange=function(){this.value=this.val(),this.triggerEvent("valuechange",{field:this,value:this.value},!0,!1)},this.setValue=function(e){this.val(e)},this.disable=function(){return this.disabled=!0,this.addClass("disabled"),this.attr("disabled","disabled"),this},this.enable=function(){return this.disabled=!1,this.removeClass("disabled"),this.attr("disabled",null),this}}),t.Editor.History=t.Evented.extend(function(){var e=[],t=-1,n=!1;this.defaults={max_commands:30},this.constructor=function(e){this.initConfig(e)},this.execute=function(e,t){return e&&e.hasOwnProperty(t)&&(n=!0,e[t](e),n=!1),this},this.add=function(i){return n?this:(e.splice(t+1,e.length-t),e.push(i),e.length>this.configs.max_commands&&(e=e.slice(-1*this.configs.max_commands)),t=e.length-1,this.triggerEvent("add",{command:i}),this)},this.undo=function(){var n=e[t];return n?(this.execute(n,"undo"),t-=1,this.triggerEvent("undo",{command:n}),this):this},this.redo=function(){var n=e[t+1];return n?(this.execute(n,"redo"),t+=1,this.triggerEvent("redo",{command:n}),this):this},this.clear=function(){var n=e.length;e=[],t=-1,n>0&&this.triggerEvent("clear")},this.hasUndo=function(){return-1!==t},this.hasRedo=function(){return e.length-1>t}}),t.Editor.MainMenu=t.Dom.extend(function(){this.constructor=function(){this.super("<div/>",{"class":"main-menu clearfix"}),this.setupUI()},this.setupUI=function(){var e,n;e=new t.Dom("<div/>",{"class":"left"}).appendTo(this),n=new t.Dom("<div/>",{"class":"right"}).appendTo(this),(new t.Editor.Button).attr({title:t.String.t("New")}).data("action","new").appendTo(e),(new t.Editor.Button).attr({title:t.String.t("Open")}).data("action","open").appendTo(e),(new t.Editor.Button).attr({title:t.String.t("edit")}).data("action","edit").appendTo(e),(new t.Editor.Button).attr({title:t.String.t("save")}).data("action","save").appendTo(e),(new t.Editor.Button).attr({title:t.String.t("download")}).data("action","download").appendTo(e),(new t.Editor.Button).attr({title:t.String.t("delete")}).data("action","delete").appendTo(e),(new t.Editor.Field.TimeField).attr({title:t.String.t("time")}).data("action","time").appendTo(e),(new t.Editor.Button).attr({title:t.String.t("revert")}).data("action","revert").appendTo(e),(new t.Editor.Button).attr({title:t.String.t("undo")}).data("action","undo").appendTo(e),(new t.Editor.Button).attr({title:t.String.t("redo")}).data("action","redo").appendTo(e),(new t.Editor.Button).attr({title:t.String.t("settings")}).data("action","settings").appendTo(n),(new t.Editor.Button).attr({title:t.String.t("help")}).data("action","help").appendTo(n)},this.enableItems=function(e){var t=this.children(e);return t.removeClass("disabled"),t},this.disableItems=function(e){var t=this.children(e);return t.addClass("disabled"),t}}),t.Editor.Overlay=t.Dom.extend(function(){var e;this.defaults={value:null,disabled:!1,parent:".metaScore-editor",modal:!0,draggable:!0},this.constructor=function(n){this.super("<div/>",{"class":"overlay clearfix"}),this.initConfig(n),this.configs.modal&&(this.mask=new t.Dom("<div/>",{"class":"overlay-mask"})),this.configs.draggable&&(e=new t.Draggable(this,this))},this.show=function(){this.configs.modal&&this.mask.appendTo(this.configs.parent),this.appendTo(this.configs.parent)},this.hide=function(){this.configs.modal&&this.mask.remove(),this.remove()}}),t.Editor.Panel=t.Dom.extend(function(){var e,n,i={};this.defaults={title:"",fields:{}},this.constructor=function(i){this.super("<div/>",{"class":"panel"}),this.initConfig(i),e=new t.Editor.Toolbar({title:this.configs.title}).appendTo(this),e.getTitle().addListener("click",this.toggleState),n=new t.Dom("<table/>",{"class":"fields"}).appendTo(this),this.setupFields()},this.setupFields=function(){var e,a,s;t.Object.each(this.configs.fields,function(o,r){e=new t.Dom("<tr/>",{"class":"field-wrapper "+o}).appendTo(n),a="field-"+t.String.uuid(5),i[o]=s=(new r.type).attr("id",a),s.data("name",o),new t.Dom("<td/>").appendTo(e).append(new t.Dom("<label/>",{text:r.label,"for":a})),new t.Dom("<td/>").appendTo(e).append(s)},this)},this.getToolbar=function(){return e},this.getField=function(e){return void 0===e?i:i[e]},this.enableFields=function(){t.Object.each(i,function(e,t){t.enable()},this)},this.disableFields=function(){t.Object.each(i,function(e,t){t.disable()},this)},this.showFields=function(e){e?n.children("tr.field-wrapper."+e.join(", tr.field-wrapper.")).show():n.children("tr.field-wrapper").show()},this.hideFields=function(e){e?n.children("tr.field-wrapper."+e.join(", tr.field-wrapper.")).hide():n.children("tr.field-wrapper").hide()},this.toggleState=function(){this.toggleClass("collapsed")}}),t.Editor.Toolbar=t.Dom.extend(function(){var e,n;this.defaults={title:null},this.constructor=function(i){this.super("<div/>",{"class":"toolbar clearfix"}),this.initConfig(i),e=new t.Dom("<div/>",{"class":"title"}).appendTo(this),n=new t.Dom("<div/>",{"class":"buttons"}).appendTo(this),this.configs.title&&e.text(this.configs.title)},this.getTitle=function(){return e},this.addButton=function(e){return new t.Editor.Button(e).appendTo(n)}}),t.Editor.Field.BooleanField=t.Editor.Field.extend(function(){this.defaults={value:!0,unchecked_value:!1,checked:!1,disabled:!1},this.attributes={type:"checkbox","class":"field booleanfield"},this.constructor=function(e){this.super(e),this.configs.checked&&this.attr("checked","checked")},this.onChange=function(){this.value=this.is(":checked")?this.val():this.configs.unchecked_value,this.triggerEvent("valuechange",{field:this,value:this.value},!0,!1)},this.setChecked=function(e){this.attr("checked",e?"checked":"")}}),t.Editor.Field.ColorField=t.Editor.Field.extend(function(){var e,n,i;this.defaults={value:{r:255,g:255,b:255,a:1},disabled:!1},this.tag="<div/>",this.attributes={"class":"field colorfield"},this.constructor=function(i){e=(new t.Editor.Button).addListener("click",this.onClick),n=(new t.Editor.Overlay).addClass("colorfield-overlay"),n.gradient=new t.Dom("<div/>",{"class":"gradient"}).appendTo(n),n.gradient.canvas=new t.Dom("<canvas/>",{width:"255",height:"255"}).addListener("click",this.onGradientClick).addListener("mousedown",this.onGradientMousedown).addListener("mouseup",this.onGradientMouseup).appendTo(n.gradient),n.gradient.position=new t.Dom("<div/>",{"class":"position"}).appendTo(n.gradient),n.alpha=new t.Dom("<div/>",{"class":"alpha"}).appendTo(n),n.alpha.canvas=new t.Dom("<canvas/>",{width:"20",height:"255"}).addListener("click",this.onAlphaClick).addListener("mousedown",this.onAlphaMousedown).addListener("mouseup",this.onAlphaMouseup).appendTo(n.alpha),n.alpha.position=new t.Dom("<div/>",{"class":"position"}).appendTo(n.alpha),n.controls=new t.Dom("<div/>",{"class":"controls"}).appendTo(n),n.controls.r=new t.Dom("<input/>",{type:"number",min:"0",max:"255",name:"r"}).addListener("input",this.onControlInput),new t.Dom("<div/>",{"class":"control-wrapper"}).append(new t.Dom("<label/>",{text:"R","for":"r"})).append(n.controls.r).appendTo(n.controls),n.controls.g=new t.Dom("<input/>",{type:"number",min:"0",max:"255",name:"g"}).addListener("input",this.onControlInput),new t.Dom("<div/>",{"class":"control-wrapper"}).append(new t.Dom("<label/>",{text:"G","for":"g"})).append(n.controls.g).appendTo(n.controls),n.controls.b=new t.Dom("<input/>",{type:"number",min:"0",max:"255",name:"b"}).addListener("input",this.onControlInput),new t.Dom("<div/>",{"class":"control-wrapper"}).append(new t.Dom("<label/>",{text:"B","for":"b"})).append(n.controls.b).appendTo(n.controls),n.controls.a=new t.Dom("<input/>",{type:"number",min:"0",max:"1",step:"0.01",name:"a"}).addListener("input",this.onControlInput),new t.Dom("<div/>",{"class":"control-wrapper"}).append(new t.Dom("<label/>",{text:"A","for":"a"})).append(n.controls.a).appendTo(n.controls),n.controls.current=new t.Dom("<canvas/>"),new t.Dom("<div/>",{"class":"canvas-wrapper current"}).append(n.controls.current).appendTo(n.controls),n.controls.previous=new t.Dom("<canvas/>"),new t.Dom("<div/>",{"class":"canvas-wrapper previous"}).append(n.controls.previous).appendTo(n.controls),n.controls.cancel=new t.Editor.Button({label:"Cancel"}).addClass("cancel").addListener("click",this.onCancelClick).appendTo(n.controls),n.controls.apply=new t.Editor.Button({label:"Apply"}).addClass("apply").addListener("click",this.onApplyClick).appendTo(n.controls),n.mask.addListener("click",this.onApplyClick),this.super(i),new t.Dom("<div/>",{"class":"icon"}).appendTo(this),e.appendTo(this),this.fillGradient()},this.setValue=function(i,a,s,o){var r;this.value=this.value||{},t.Var.is(i,"object")||(i=this.parseColor(i)),i.hasOwnProperty("r")&&(this.value.r=parseInt(i.r,10)),i.hasOwnProperty("g")&&(this.value.g=parseInt(i.g,10)),i.hasOwnProperty("b")&&(this.value.b=parseInt(i.b,10)),i.hasOwnProperty("a")&&(this.value.a=parseFloat(i.a)),a!==!1&&this.fillAlpha(),o!==!1&&(n.controls.r.val(this.value.r),n.controls.g.val(this.value.g),n.controls.b.val(this.value.b),n.controls.a.val(this.value.a)),s!==!1&&(r=this.rgb2hsv(this.value),n.gradient.position.css("left",255*(1-r.h)+"px"),n.gradient.position.css("top",127.5*r.s+127.5*(1-r.v/255)+"px"),n.alpha.position.css("top",255*(1-this.value.a)+"px")),this.fillCurrent(),e.css("background-color","rgba("+this.value.r+","+this.value.g+","+this.value.b+","+this.value.a+")")},this.onClick=function(){this.disabled||(i=t.Object.copy(this.value),this.fillPrevious(),n.show())},this.onControlInput=function(){this.setValue({r:n.controls.r.val(),g:n.controls.g.val(),b:n.controls.b.val(),a:n.controls.a.val()},!0,!0,!1)},this.onCancelClick=function(e){this.setValue(i),n.hide(),e.stopPropagation()},this.onApplyClick=function(e){n.hide(),this.triggerEvent("valuechange",{field:this,value:this.value},!0,!1),e.stopPropagation()
},this.fillPrevious=function(){var e=n.controls.previous.get(0).getContext("2d");e.fillStyle="rgba("+i.r+","+i.g+","+i.b+","+i.a+")",e.clearRect(0,0,e.canvas.width,e.canvas.height),e.fillRect(0,0,e.canvas.width,e.canvas.height)},this.fillCurrent=function(){var e=n.controls.current.get(0).getContext("2d");e.fillStyle="rgba("+this.value.r+","+this.value.g+","+this.value.b+","+this.value.a+")",e.clearRect(0,0,e.canvas.width,e.canvas.height),e.fillRect(0,0,e.canvas.width,e.canvas.height)},this.fillGradient=function(){var e,t=n.gradient.canvas.get(0).getContext("2d");e=t.createLinearGradient(0,0,t.canvas.width,0),e.addColorStop(0,"rgb(255, 0, 0)"),e.addColorStop(.15,"rgb(255, 0, 255)"),e.addColorStop(.33,"rgb(0, 0, 255)"),e.addColorStop(.49,"rgb(0, 255, 255)"),e.addColorStop(.67,"rgb(0, 255, 0)"),e.addColorStop(.84,"rgb(255, 255, 0)"),e.addColorStop(1,"rgb(255, 0, 0)"),t.fillStyle=e,t.fillRect(0,0,t.canvas.width,t.canvas.height),e=t.createLinearGradient(0,0,0,t.canvas.height),e.addColorStop(0,"rgba(255, 255, 255, 1)"),e.addColorStop(.5,"rgba(255, 255, 255, 0)"),e.addColorStop(.5,"rgba(0, 0, 0, 0)"),e.addColorStop(1,"rgba(0, 0, 0, 1)"),t.fillStyle=e,t.fillRect(0,0,t.canvas.width,t.canvas.height)},this.fillAlpha=function(){var e,t=n.alpha.canvas.get(0).getContext("2d");e=t.createLinearGradient(0,0,0,t.canvas.height),e.addColorStop(0,"rgb("+this.value.r+","+this.value.g+","+this.value.b+")"),e.addColorStop(1,"transparent"),t.fillStyle=e,t.clearRect(0,0,t.canvas.width,t.canvas.height),t.fillRect(0,0,t.canvas.width,t.canvas.height)},this.onGradientMousedown=function(e){n.gradient.canvas.addListener("mousemove",this.onGradientMousemove),e.stopPropagation()},this.onGradientMouseup=function(e){n.gradient.canvas.removeListener("mousemove",this.onGradientMousemove),e.stopPropagation()},this.onGradientClick=this.onGradientMousemove=function(e){var t=e.target.getBoundingClientRect(),i=e.pageX-t.left,a=e.pageY-t.top,s=n.gradient.canvas.get(0).getContext("2d"),o=s.getImageData(i,a,1,1),r=this.value;n.gradient.position.css("left",i+"px"),n.gradient.position.css("top",a+"px"),r.r=o.data[0],r.g=o.data[1],r.b=o.data[2],this.setValue(r,!0,!1),e.stopPropagation()},this.onAlphaMousedown=function(e){n.alpha.canvas.addListener("mousemove",this.onAlphaMousemove),e.stopPropagation()},this.onAlphaMouseup=function(e){n.alpha.canvas.removeListener("mousemove",this.onAlphaMousemove),e.stopPropagation()},this.onAlphaClick=this.onAlphaMousemove=function(e){var t=e.target.getBoundingClientRect(),i=e.pageY-t.top,a=n.alpha.canvas.get(0).getContext("2d"),s=a.getImageData(0,i,1,1),o=this.value;n.alpha.position.css("top",i+"px"),o.a=Math.round(100*(s.data[3]/255))/100,this.setValue(o,!1,!1),e.stopPropagation()},this.rgb2hsv=function(e){var t,n,i,a=e.r,s=e.g,o=e.b,r=Math.max(a,s,o),l=Math.min(a,s,o),d=r-l;if(n=0===r?0:d/r,i=r,r===l)t=0;else{switch(r){case a:t=(s-o)/d+(o>s?6:0);break;case s:t=(o-a)/d+2;break;case o:t=(a-s)/d+4}t/=6}return{h:t,s:n,v:i}},this.parseColor=function(e){var t,n={};return e=e.replace(/\s\s*/g,""),(t=/^#([\da-fA-F]{2})([\da-fA-F]{2})([\da-fA-F]{2})/.exec(e))?(n.r=parseInt(t[1],16),n.g=parseInt(t[2],16),n.b=parseInt(t[3],16),n.a=1):(t=/^#([\da-fA-F])([\da-fA-F])([\da-fA-F])/.exec(e))?(n.r=17*parseInt(t[1],16),n.g=17*parseInt(t[2],16),n.b=17*parseInt(t[3],16),n.a=1):(t=/^rgba\(([\d]+),([\d]+),([\d]+),([\d]+|[\d]*.[\d]+)\)/.exec(e))?(n.r=+t[1],n.g=+t[2],n.b=+t[3],n.a=+t[4]):(t=/^rgb\(([\d]+),([\d]+),([\d]+)\)/.exec(e))&&(n.r=+t[1],n.g=+t[2],n.b=+t[3],n.a=1),n}}),t.Editor.Field.CornerField=t.Editor.Field.extend(function(){this.defaults={value:null,disabled:!1},this.constructor=function(e){this.super(e)}}),t.Editor.Field.ImageField=t.Editor.Field.extend(function(){var e;this.defaults={value:null,disabled:!1},this.attributes={type:"file","class":"field imagefield"},this.constructor=function(e){this.super(e),this.addListener("change",this.onFileSelect,!1)},this.setValue=function(e,t){this.value=e,t!==!1&&this.triggerEvent("valuechange",{field:this,value:this.value},!1,!0)},this.onFileSelect=function(t){var n=t.target.files;e=n.length>0&&n[0].type.match("image.*")?n[0]:null},this.getBase64=function(n){var i;e&&(i=new FileReader,i.onload=t.Function.proxy(function(e){n.call(this,e.target.result,e)},this),i.readAsDataURL(e))}}),t.Editor.Field.IntegerField=t.Editor.Field.extend(function(){this.defaults={value:0,disabled:!1,min:null,max:null},this.attributes={type:"number","class":"field integerfield"},this.constructor=function(e){this.super(e)}}),t.Editor.Field.TimeField=t.Editor.Field.extend(function(){var e,n,i,a;this.defaults={value:0,disabled:!1,min:0,max:null},this.tag="<div/>",this.attributes={"class":"field timefield"},this.constructor=function(s){e=new t.Dom("<input/>",{type:"number","class":"hours"}),n=new t.Dom("<input/>",{type:"number","class":"minutes"}),i=new t.Dom("<input/>",{type:"number","class":"seconds"}),a=new t.Dom("<input/>",{type:"number","class":"centiseconds"}),this.super(s),e.addListener("input",this.onInput).appendTo(this),new t.Dom("<span/>",{text:":","class":"separator"}).appendTo(this),n.addListener("input",this.onInput).appendTo(this),new t.Dom("<span/>",{text:":","class":"separator"}).appendTo(this),i.addListener("input",this.onInput).appendTo(this),new t.Dom("<span/>",{text:".","class":"separator"}).appendTo(this),a.addListener("input",this.onInput).appendTo(this)},this.onInput=function(t){var s=parseInt(a.val(),10),o=parseInt(i.val(),10),r=parseInt(n.val(),10),l=parseInt(e.val(),10);t.stopPropagation(),this.setValue(10*s+1e3*o+6e4*r+36e5*l)},this.setValue=function(t){var s,o,r,l;this.value=t,null!==this.configs.min&&(this.value=Math.max(this.value,this.configs.min)),null!==this.configs.max&&(this.value=Math.min(this.value,this.configs.max)),s=parseInt(this.value/10%100,10),o=parseInt(this.value/1e3%60,10),r=parseInt(this.value/6e4%60,10),l=parseInt(this.value/36e5,10),a.val(s),i.val(o),n.val(r),e.val(l),this.triggerEvent("valuechange",{field:this,value:this.value},!0,!1)},this.getValue=function(){return this.value},this.disable=function(){return this.disabled=!0,e.attr("disabled","disabled"),n.attr("disabled","disabled"),i.attr("disabled","disabled"),a.attr("disabled","disabled"),this.addClass("disabled"),this},this.enable=function(){return this.disabled=!1,e.attr("disabled",null),n.attr("disabled",null),i.attr("disabled",null),a.attr("disabled",null),this.removeClass("disabled"),this}}),t.Editor.Panel.Block=t.Editor.Panel.extend(function(){var e,n;this.defaults={title:t.String.t("Block"),fields:{x:{type:t.Editor.Field.IntegerField,label:t.String.t("X")},y:{type:t.Editor.Field.IntegerField,label:t.String.t("Y")},width:{type:t.Editor.Field.IntegerField,label:t.String.t("Width")},height:{type:t.Editor.Field.IntegerField,label:t.String.t("Height")},"bg-color":{type:t.Editor.Field.ColorField,label:t.String.t("Background color")},"bg-image":{type:t.Editor.Field.ImageField,label:t.String.t("Background image")},synched:{type:t.Editor.Field.BooleanField,label:t.String.t("Synchronized pages ?")}}},this.constructor=function(n){this.super(n),e=new t.Editor.DropDownMenu,e.addItem({text:t.String.t("Add a new block"),"data-action":"new"}),e.addItem({text:t.String.t("Delete the active block"),"data-action":"delete"}),this.getToolbar().addButton().data("action","menu").append(e),this.addDelegate(".field","valuechange",this.onFieldValueChange)},this.getMenu=function(){return e},this.getBlock=function(){return n},this.setBlock=function(e,i){return n&&n.get(0)===e.get(0)?void 0:(this.unsetBlock(n,i),this.updateFieldValues(e),this.enableFields(),this.getMenu().enableItems('[data-action="delete"]'),e._draggable=new t.Draggable(e,e.child(".pager"),e.parents()).enable(),e._resizable=new t.Resizable(e,e.parents()).enable(),e.addListener("dragstart",this.onBlockDragStart).addListener("dragend",this.onBlockDragEnd).addListener("resizeend",this.onBlockResizeEnd).addClass("selected"),i!==!0&&this.triggerEvent("blockset",{block:e}),n=e,this)},this.unsetBlock=function(e,t){return e=e||this.getBlock(),this.disableFields(),this.getMenu().disableItems('[data-action="delete"]'),e&&(e._draggable.destroy(),delete e._draggable,e._resizable.destroy(),delete e._resizable,e.removeListener("dragstart",this.onBlockDragStart).removeListener("dragend",this.onBlockDragEnd).removeListener("resizeend",this.onBlockResizeEnd).removeClass("selected"),n=null),t!==!0&&this.triggerEvent("blockunset",{block:e}),this},this.onBlockDragStart=function(){var e=this.getBlock(),t=["x","y"];this.beforeDragValues=this.getValues(e,t)},this.onBlockDragEnd=function(){var e=this.getBlock(),t=["x","y"];this.updateFieldValues(e,t,!0),this.triggerEvent("valueschange",{block:e,old_values:this.beforeDragValues,new_values:this.getValues(e,t)}),delete this.beforeDragValues},this.onBlockResizeEnd=function(){var e=this.getBlock(),t=["x","y","width","height"],n=this.getValues(e,t);this.updateFieldValues(e,t,!0),this.triggerEvent("valueschange",{block:e,old_values:n,new_values:this.getValues(e,t)})},this.onFieldValueChange=function(e){var t,n,i,a=this.getBlock();a&&(t=e.detail.field.data("name"),n=e.detail.value,i=this.getValues(a,[t]),this.updateBlockProperty(a,t,n),this.triggerEvent("valueschange",{block:a,old_values:i,new_values:this.getValues(a,[t])}))},this.updateFieldValue=function(e,t,n){var i=this.getField(e);switch(e){case"x":case"y":case"width":case"height":case"bg-color":i.setValue(t);break;case"bg-image":break;case"synched":i.setChecked(t)}n!==!0&&i.triggerEvent("change")},this.updateFieldValues=function(e,n,i){n=n||this.getValues(e,Object.keys(this.getField())),t.Var.is(n,"array")?t.Array.each(n,function(t,n){this.updateFieldValue(n,this.getValue(e,n),i)},this):t.Object.each(n,function(e,t){this.updateFieldValue(e,t,i)},this)},this.updateBlockProperty=function(e,t,n){switch(t){case"x":e.css("left",n+"px");break;case"y":e.css("top",n+"px");break;case"width":e.css("width",n+"px");break;case"height":e.css("height",n+"px");break;case"bg-color":e.css("background-color","rgba("+n.r+","+n.g+","+n.b+","+n.a+")");break;case"bg-image":break;case"synched":e.data("synched",n)}},this.getValue=function(e,t){var n;switch(t){case"x":n=parseInt(e.css("left"),10);break;case"y":n=parseInt(e.css("top"),10);break;case"width":n=parseInt(e.css("width"),10);break;case"height":n=parseInt(e.css("height"),10);break;case"bg-color":n=e.css("background-color");break;case"bg-image":break;case"synched":n="true"===e.data("synched")}return n},this.getValues=function(e,n){var i={};return n=n||Object.keys(this.getField()),t.Array.each(n,function(t,n){i[n]=this.getValue(e,n)},this),i}}),t.Editor.Panel.Element=t.Editor.Panel.extend(function(){var e,n;this.defaults={title:t.String.t("Element"),fields:{x:{type:t.Editor.Field.IntegerField,label:t.String.t("X")},y:{type:t.Editor.Field.IntegerField,label:t.String.t("Y")},width:{type:t.Editor.Field.IntegerField,label:t.String.t("Width")},height:{type:t.Editor.Field.IntegerField,label:t.String.t("Height")},"r-index":{type:t.Editor.Field.IntegerField,label:t.String.t("Reading index"),configs:{min:0}},"z-index":{type:t.Editor.Field.IntegerField,label:t.String.t("Display index")},"bg-color":{type:t.Editor.Field.ColorField,label:t.String.t("Background color")},"bg-image":{type:t.Editor.Field.ImageField,label:t.String.t("Background image")},"border-width":{type:t.Editor.Field.IntegerField,label:t.String.t("Border width")},"border-color":{type:t.Editor.Field.ColorField,label:t.String.t("Border color")},"rounded-conrners":{type:t.Editor.Field.CornerField,label:t.String.t("Rounded conrners")},"start-time":{type:t.Editor.Field.TimeField,label:t.String.t("Start time")},"end-time":{type:t.Editor.Field.TimeField,label:t.String.t("End time")}}},this.constructor=function(n){var i;this.super(n),i=this.getToolbar(),i.addButton().data("action","previous"),i.addButton().data("action","next"),e=new t.Editor.DropDownMenu,e.addItem({text:t.String.t("Add a new cursor"),"data-action":"new","data-type":"Cursor"}),e.addItem({text:t.String.t("Add a new image"),"data-action":"new","data-type":"Image"}),e.addItem({text:t.String.t("Add a new text element"),"data-action":"new","data-type":"Text"}),e.addItem({text:t.String.t("Delete the active element"),"data-action":"delete"}),i.addButton().data("action","menu").append(e),this.addDelegate(".field","change",this.onFieldChange)},this.getMenu=function(){return e},this.getElement=function(){return n},this.setElement=function(e,i){return n&&n.get(0)===e.get(0)?void 0:(this.unsetElement(n,i),n=e,this.updateValues(),this.enableFields(),this.getMenu().enableItems('[data-action="delete"]'),n._draggable=new t.Draggable(n,n,n.parents()).enable(),n._resizable=new t.Resizable(n,n.parents()).enable(),n.addListener("drag",this.onElementDrag).addListener("resize",this.onElementResize).addClass("selected"),i!==!0&&this.triggerEvent("elementset",{element:n}),this)},this.unsetElement=function(e,t){return e=e||this.getElement(),this.disableFields(),this.getMenu().disableItems('[data-action="delete"]'),e&&(e._draggable.destroy(),delete e._draggable,e._resizable.destroy(),delete e._resizable,e.removeListener("drag",this.onElementDrag).removeListener("resize",this.onElementResize).removeClass("selected"),n=null),t!==!0&&this.triggerEvent("elementunset",{element:e}),this},this.onElementDrag=function(){this.updateValues(["x","y"])},this.onElementResize=function(){this.updateValues(["x","y","width","height"])},this.onFieldChange=function(e){var t=e.detail.field,i=e.detail.value;if(n)switch(t.data("name")){case"x":n.css("left",i+"px");break;case"y":n.css("top",i+"px");break;case"width":n.css("width",i+"px");break;case"height":n.css("height",i+"px");break;case"r-index":n.data("r-index",i);break;case"z-index":n.css("z-index",i);break;case"bg-color":n.css("background-color","rgba("+i.r+","+i.g+","+i.b+","+i.a+")");break;case"bg-image":break;case"border-width":n.css("border-width",i+"px");break;case"border-color":n.css("border-color","rgba("+i.r+","+i.g+","+i.b+","+i.a+")");break;case"rounded-conrners":break;case"start-time":n.data("start-time",i);break;case"end-time":n.data("end-time",i)}},this.updateValue=function(e){var t=this.getField(e);switch(e){case"x":t.setValue(parseInt(n.css("left"),10));break;case"y":t.setValue(parseInt(n.css("top"),10));break;case"width":t.setValue(parseInt(n.css("width"),10));break;case"height":t.setValue(parseInt(n.css("height"),10));break;case"r-index":t.setValue(n.data("r-index")||0);break;case"z-index":t.setValue(parseInt(n.css("z-index"),10));break;case"bg-color":t.setValue(n.css("background-color"));break;case"bg-image":break;case"border-width":t.setValue(parseInt(n.css("border-width"),10));break;case"border-color":t.setValue(n.css("border-color"));break;case"rounded-conrners":break;case"start-time":t.setValue(n.data("start-time")||0);break;case"end-time":t.setValue(n.data("end-time")||0)}},this.updateValues=function(e){void 0===e&&(e=Object.keys(this.getField())),t.Object.each(e,function(e,t){this.updateValue(t)},this)}}),t.Editor.Panel.Page=t.Editor.Panel.extend(function(){var e,n;this.defaults={title:t.String.t("Page"),fields:{"bg-color":{type:t.Editor.Field.ColorField,label:t.String.t("Background color")},"bg-image":{type:t.Editor.Field.ImageField,label:t.String.t("Background image")},"start-time":{type:t.Editor.Field.TimeField,label:t.String.t("Start time")},"end-time":{type:t.Editor.Field.TimeField,label:t.String.t("End time")}}},this.constructor=function(n){this.super(n),e=new t.Editor.DropDownMenu,e.addItem({text:t.String.t("Add a new page"),"data-action":"new"}),e.addItem({text:t.String.t("Delete the active page"),"data-action":"delete"}),this.getToolbar().addButton().data("action","menu").append(e),this.addDelegate(".field","change",this.onFieldChange)},this.getMenu=function(){return e},this.getPage=function(){return n},this.setPage=function(e,t){return n&&n.get(0)===e.get(0)?void 0:(this.unsetPage(n,t),n=e,this.updateValues(),this.enableFields(),this.getMenu().enableItems('[data-action="delete"]'),t!==!0&&this.triggerEvent("pageset",{page:n}),this)},this.unsetPage=function(e,t){return e=e||this.getPage(),this.disableFields(),this.getMenu().disableItems('[data-action="delete"]'),e&&(n=null),t!==!0&&this.triggerEvent("pageunset",{page:e}),this},this.onFieldChange=function(e){var t=e.detail.field,i=e.detail.value;if(n)switch(t.data("name")){case"bg-color":n.css("background-color","rgba("+i.r+","+i.g+","+i.b+","+i.a+")");break;case"bg_image":case"start-time":n.data("start-time",i);break;case"end-time":n.data("end-time",i)}},this.updateValue=function(e){var t=this.getField(e);switch(e){case"bg-color":t.setValue(n.css("background-color"));break;case"bg-image":break;case"start-time":t.setValue(n.data("start-time")||0);break;case"end-time":t.setValue(n.data("end-time")||0)}},this.updateValues=function(e){void 0===e&&(e=Object.keys(this.getField())),t.Object.each(e,function(e,t){this.updateValue(t)},this)}}),t.Player=t.Base.extend(function(){}),t.Player.Block=t.Dom.extend(function(){var e,n;this.constructor=function(i){e=[],i?(this.super(i),e=this.children(".pages"),n=new t.Player.Pager(this.child(".pager").get(0))):(this.super("<div/>",{"class":"metaScore-block"}),e=new t.Dom("<div/>",{"class":"pages"}).appendTo(this),n=(new t.Player.Pager).appendTo(this)),n.addDelegate(".button","click",function(e){var n,i=!t.Dom.hasClass(e.target,"inactive");if(i)switch(n=t.Dom.data(e.target,"action")){case"first":this.setActivePage(0);break;case"previous":this.setActivePage(this.getActivePageIndex()-1);break;case"next":this.setActivePage(this.getActivePageIndex()+1)}e.stopPropagation()},this)},this.getPages=function(){return e.children(".page")},this.addPage=function(t){e.append(t),this.setActivePage(this.getPages().count()-1)},this.getActivePage=function(){return new t.Player.Page(this.getPages().child(".active").get(0))},this.getActivePageIndex=function(){return this.getPages().index(".active")},this.getPageCount=function(){return this.getPages().count()},this.setActivePage=function(e){var n=this.getPages(),i=new t.Player.Page(n.get(e));n.removeClass("active"),i.addClass("active"),this.updatePager(),this.triggerEvent("pageactivated",{index:e,page:i})},this.updatePager=function(){var e=this.getActivePageIndex(),t=this.getPageCount();n.updateCount(e,t)},this.isSynched=function(){return"true"===this.data("synched")}}),t.Player.Element=t.Dom.extend(function(){this.constructor=function(e){e?this.super(e):this.super("<div/>",{"class":"element"})}}),t.Player.Media=t.Dom.extend(function(){}),t.Player.Page=t.Dom.extend(function(){this.constructor=function(e){e?this.super(e):this.super("<div/>",{"class":"page"})},this.addElement=function(e){return this.append(e),e}}),t.Player.Pager=t.Dom.extend(function(){var e,n;this.constructor=function(i){i?(this.super(i),e=this.child(".count"),n=this.child(".buttons"),n.first=n.child('[data-action="first"]'),n.previous=n.child('[data-action="previous"]'),n.next=n.child('[data-action="next"]')):(this.super("<div/>",{"class":"pager"}),e=new t.Dom("<div/>",{"class":"count"}).appendTo(this),n=new t.Dom("<div/>",{"class":"buttons"}).addListener("mousedown",function(e){e.stopPropagation()}).appendTo(this),n.first=new t.Dom("<div/>",{"class":"button","data-action":"first"}).appendTo(n),n.previous=new t.Dom("<div/>",{"class":"button","data-action":"previous"}).appendTo(n),n.next=new t.Dom("<div/>",{"class":"button","data-action":"next"}).appendTo(n))},this.updateCount=function(i,a){e.text(t.String.t("page !current/!count",{"!current":i+1,"!count":a})),n.first.toggleClass("inactive",0===i),n.previous.toggleClass("inactive",0===i),n.next.toggleClass("inactive",i>=a-1)}}),t.Player.Element.Cursor=t.Player.Element.extend(function(){this.constructor=function(e){this.super(e),this.data("type","cursor")}}),t.Player.Element.Image=t.Player.Element.extend(function(){this.constructor=function(e){this.super(e),this.data("type","image")}}),t.Player.Element.Text=t.Player.Element.extend(function(){this.constructor=function(e){this.super(e),this.data("type","text")}}),t.Player.Media.CuePoint=t.Base.extend(function(){var e,n;this.constructor=function(t){n=[],e=t,e.addEventListener("timeupdate",this.onMediaTimeUpdate)},this.onMediaTimeUpdate=function(e){var i,a;i=e.target,a=parseFloat(i.currentTime),t.Object.each(n,function(e,t){!t.timer&&a>=t.inTime-.5&&t.inTime>a&&this.setupTriggerTimer(t,1e3*(t.inTime-a))})},this.addTrigger=function(e){return n.push(e)-1},this.removeTrigger=function(e){var t=n[e];this.stopTrigger(t,!1),n.splice(e,1)},this.setupTriggerTimer=function(e,n){e.timer=setTimeout(t.Function.proxy(this.launchTrigger,this,e),n)},this.launchTrigger=function(n){n.hasOwnProperty("onStart")&&t.Var.is(n.onStart,"function")&&n.onStart(e)},this.stopTrigger=function(n,i){n.hasOwnProperty("timer")&&(clearTimeout(n.timer),delete n.timer),n.hasOwnProperty("interval")&&(clearInterval(n.interval),delete n.interval),i!==!1&&n.hasOwnProperty("onEnd")&&t.Var.is(n.onEnd,"function")&&n.onEnd(e)}}),e.metaScore=t})(this);